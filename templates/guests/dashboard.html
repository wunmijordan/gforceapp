{% extends 'base.html' %}
{% load guest_extras %}
{% load static %}
{% load access_tags %}
{% block title %}GForce - Dashboard{% endblock %}

{% block content %}

    
    
<div class="page-wrapper">
  <!-- BEGIN PAGE HEADER -->
  <div class="page-header d-print-none" aria-label="Page header">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <!-- Dynamic Page Title -->
          <kbd class="bg-indigo-lt"><h2 class="page-title">{{ page_title }}</h2></kbd>
        </div>

        <!-- Page title actions -->
        <div class="col-auto ms-auto d-print-none">
          <div class="btn-list">
            
            {% if request.user|is_magnet_admin %}
              <div>
                <!-- Single Button for Regular Users -->
                <a href="{% url 'create_guest' %}" class="btn btn-gray d-none d-sm-inline-block">
                  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-users-plus">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                    <path d="M3 21v-2a4 4 0 0 1 4 -4h4c.96 0 1.84 .338 2.53 .901" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /><path d="M16 19h6" /><path d="M19 16v6" />
                  </svg>
                  Add New Guest
                </a>

                <!-- Mobile Button -->
                <a href="{% url 'create_guest' %}" class="btn btn-gray d-sm-none btn-icon" aria-label="Add guest">
                  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-users-plus">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                    <path d="M3 21v-2a4 4 0 0 1 4 -4h4c.96 0 1.84 .338 2.53 .901" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /><path d="M16 19h6" /><path d="M19 16v6" />
                  </svg>
                </a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <!--<div class="container-xl mt-4">
      <div class="row g-2 justify-content-center">
        {% comment %} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SUPERUSER + PROJECT ADMINS SEE EVERYONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ {% endcomment %}
        {% if request.user.is_superuser or request.user|is_project_admin %}
          <div class="w-full mx-auto relative mb-4">
            <div class="scroll-wrapper">
              <ul class="scroll-track" data-direction="left">
                {% for user in other_users %}
                  {% if user != request.user %}
                    {% include "partials/_user_card.html" with user=user %}
                  {% endif %}
                {% endfor %}
              </ul>
            </div>
          </div>

        {% else %}
          {% with memberships=request.user.team_memberships.all %}
            {% if user_teams|length == 1 %}
              {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SINGLE TEAM USER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
              <div class="w-full mx-auto relative mb-4">
                <!-- Team name overlay --
                <span class="team-name-overlay {{ team.color_class|default:'bg-dark-lt' }}">{{ team.name }}</span>
                <div class="scroll-wrapper">
                  <ul class="scroll-track" data-direction="left">
                    {% for member in other_users %}
                      {% if member != request.user %}
                        {% include "partials/_user_card.html" with user=member %}
                      {% endif %}
                    {% endfor %}
                  </ul>
                </div>
              </div>

            {% elif user_teams|length > 1 %}
              {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MULTIPLE TEAMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
              {% for team, members in team_member_pairs %}
                <div class="w-full mx-auto relative mb-1 scroll-container">
                  <!-- Team name overlay --
                  <span class="team-name-overlay {{ team.color_class|default:'bg-dark-lt' }}">{{ team.name }}</span>

                  <div class="scroll-wrapper">
                    <ul class="scroll-track" data-direction="{% cycle 'left' 'right' %}">
                      {% for member in members %}
                        {% include "partials/_user_card.html" with user=member %}
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              {% endfor %}

            {% endif %}
          {% endwith %}
        {% endif %}
      </div>
    </div>-->
  </div>
  <!-- END PAGE HEADER -->

  
  <div class="page-body">
    <div class="container-xl">
      <div class="row row-deck row-cards">

        
        <div class="col-md-6 col-lg-4 p-4">
          <div class="row gy-3">
            <div class="col-12 col-sm d-flex flex-column">
              <div style="--user-color: {{ user.color }};">
                <span class="typing-text">Welcome back,</span>
              </div>
              <span style="font-size: 3rem; font-weight: bold; line-height: 1.1;">
                <small style="font-size: 1.5rem; font-style: italic;">{{ request.user.title|default:"" }}</small><br> {{ request.user.full_name }}
              </span>
              <!--<div class="d-flex flex-wrap gap-2 mt-4 mb-2 justify-content-start">
                {% if not request.user|is_project_admin %}
                  {% with memberships=user.team_memberships.all %}
                    {% if memberships %}
                      {% for membership in memberships %}
                        {% if membership.team.is_active %}
                          <span class="px-2 m-0 border-0 {{ membership.team.color_class }}"
                                style="
                                  font-size: 0.8rem;
                                  font-weight: semibold;
                                  font-style: italic;
                                  border-radius: 12px;
                                  background: #1F2937;
                                  box-shadow: 0 4px 8px #000000d2;
                                ">
                            {{ membership.team.name }}
                          </span>
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endwith %}
                {% endif %}
              </div>-->
              <div class="row g-2 justify-content-center">
                {% comment %} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SUPERUSER + PROJECT ADMINS SEE EVERYONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ {% endcomment %}
                {% if request.user.is_superuser or request.user|is_project_admin %}
                  <div class="w-full mx-auto relative mb-4">
                    <div class="scroll-wrapper">
                      <ul class="scroll-track" data-direction="left">
                        {% for user in other_users %}
                          {% if user != request.user %}
                            {% include "partials/_user_card.html" with user=user %}
                          {% endif %}
                        {% endfor %}
                      </ul>
                    </div>
                  </div>

                {% else %}
                  {% with memberships=request.user.team_memberships.all %}
                    {% if user_teams|length == 1 %}
                      {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SINGLE TEAM USER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
                      <div class="w-full mx-auto relative mb-4">
                        <!-- Team name overlay -->
                        <span class="team-name-overlay {{ team.color_class }}" style="background: #1F2937;">{{ team.name }}</span>
                        <div class="scroll-wrapper">
                          <ul class="scroll-track" data-direction="left">
                            {% for member in other_users %}
                              {% if member != request.user %}
                                {% include "partials/_user_card.html" with user=member %}
                              {% endif %}
                            {% endfor %}
                          </ul>
                        </div>
                      </div>

                    {% elif user_teams|length > 1 %}
                      {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MULTIPLE TEAMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
                      {% for team, members in team_member_pairs %}
                        <div class="w-full mx-auto relative scroll-container">
                          <!-- Team name overlay -->
                          <span class="team-name-overlay {{ team.color_class }}" style="background: #1F2937;">{{ team.name }}</span>

                          <div class="scroll-wrapper">
                            <ul class="scroll-track" data-direction="{% cycle 'left' 'right' %}">
                              {% for member in members %}
                                {% include "partials/_user_card.html" with user=member %}
                              {% endfor %}
                            </ul>
                          </div>
                        </div>
                      {% endfor %}

                    {% endif %}
                  {% endwith %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-12 col-lg-8">
          <div id="timeCard"
              class="card transition-all duration-500 rounded-2xl overflow-hidden p-4"
              data-user-color="{{ user.color_hex|default:'#22c55e' }}">
            <div class="card-body p-0">
              <div class="row g-4 align-items-center">
                
                <!-- ðŸ•’ Column 1: Date & Clock -->
                <div class="col-md-6 d-flex flex-column align-items-center justify-content-center text-center">
                  {% if request.user|is_project_admin %}
                  <div class="mb-2">
                    <!--<label for="userSelect" class="form-label text-white fw-bold">View User Summary:</label>-->
                    <select id="userSelect" class="form-select border-0 text-white"
                        style="box-shadow: 0 4px 8px #000000d2; border-radius: 8px; background: #1F2937; width: 300px; font-weight: bold;">
                      <option value="">Select a Member to view Data</option>
                      {% for u in users %}
                        <option value="{{ u.id }}">{{ u.title|default:"" }} {{ u.full_name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  {% endif %}
                  <div id="liveDate"
                      class="fw-bold mb-1"
                      style="font-size: 1.2rem; letter-spacing: 0.05em;">
                  </div>
                  <canvas id="analogClock" width="220" height="220" class="mb-1"></canvas>
                  <div id="digitalClock"
                      class="text-6xl font-mono tracking-widest fw-bold text-glow"
                      style="font-size: 3.5rem; letter-spacing: 0.1em; font-family: monospace;">
                    </div>
                </div>

                <!-- ðŸ“Š Column 2: Stats + Action -->
                <div id="summaryColumn" class="col-md-6 d-flex flex-column gap-3" {% if request.user|is_project_admin %}style="display:none;"{% endif %}>
                  <!-- ðŸŒŸ Weekly Upcoming Events with Countdown -->
                  <div id="weeklyEventsContainer"
                      class="flex-fill p-3 text-center"
                      style="border-radius: 12px; background: #111827; box-shadow: 0 4px 8px #000000d2">
                    {% if next_events_for_week %}
                      <div id="eventDisplayArea" class="fw-bold text-warning text-center" style="font-size:1.05rem;">
                        {% for event in next_events_for_week %}
                          <div class="weekly-event-item {% if not forloop.first %}d-none{% endif %}" 
                              data-datetime="{{ event.datetime_iso }}"
                              data-postponed="{{ event.postponed|yesno:'true,false' }}">
                            <div class="d-flex justify-content-center align-items-center mb-1">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chevrons-right {{ user.color_class }}">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M7 7l5 5l-5 5" /><path d="M13 7l5 5l-5 5" />
                              </svg>
                              <span class="ms-2 text-white fw-bold">{{ event.name }} |</span> 
                              {% if event.team_name %}
                                <span class="badge text-white {{ event.team_color_class }}"> {{ event.team_name }} </span>
                              {% else %}
                                <span class="badge bg-warning-800 text-white">GForce</span>
                              {% endif %}                              
                            </div>
                            {% if event.postponed %}
                              {% if event.date %}
                                <small class="text-danger fst-italic" style="font-size:0.8rem;">
                                  Postponed â†’ {{ event.date }}{% if event.time %} at {{ event.time }}{% endif %}
                                </small>
                              {% else %}
                                <small class="text-danger fst-italic">Postponed (Date TBD)</small>
                              {% endif %}
                            {% else %}
                              <small class="text-secondary" style="font-size:0.8rem;">
                                {{ event.date|date:"D, M j Y" }} â€¢ {{ event.time|default:"TBA" }}
                              </small>
                            {% endif %}
                            <div class="countdown fw-semibold mt-1">
                              <span class="countdown-text">Loading...</span>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <div class="text-muted text-center small">No events scheduled this week.</div>
                    {% endif %}
                  </div>

                  <!-- Row 1: Total Clock In / Out -->
                  <div class="d-flex gap-2">
                    <div class="flex-fill p-3 text-center"
                          style="border-radius: 12px; background: #1F2937; box-shadow: 0 4px 8px #000000d2">
                      <div class="text-white">Total Clock In</div>
                      <div class="d-flex justify-content-center align-items-center">
                        <h1 id="totalClockIn" class="fw-bold text-warning" style="font-family: monospace;">
                          {{ total_clock_in|default:"--" }}
                        </h1>
                        <h1 id="totalClockInBadge" class="badge bg-warning-subtle text-warning ms-1 d-none">%</h1>
                        
                      </div>
                    </div>
                    <div class="flex-fill p-3 text-center"
                          style="border-radius: 12px; background: #1F2937; box-shadow: 0 4px 8px #000000d2">
                      <div class="text-white">Total Clock Out</div>
                      <div class="d-flex justify-content-center align-items-center">
                        <h1 id="totalClockOut" class="fw-bold text-purple" style="font-family: monospace;">
                          {{ total_clock_out|default:"--" }}
                        </h1>
                        <h1 id="totalClockOutBadge" class="badge bg-purple-subtle text-purple ms-1 d-none" style="font-family: monospace;">
                          %
                        </h1>
                      </div>
                    </div>
                  </div>

                  <!-- Row 2: Summary -->
                  <div class="d-flex gap-2">
                    <div class="flex-fill p-3 text-center"
                          style="border-radius: 12px; background: #1F2937; box-shadow: 0 4px 8px #000000d2">
                      <div class="text-white">Present</div>
                      <div class="d-flex justify-content-center align-items-center">
                        <h1 id="summaryPresent" class="fw-bold text-success" style="font-family: monospace;">
                          --
                        </h1>
                        <h1 id="summaryPresentBadge" class="badge bg-success-subtle text-success ms-1 d-none" style="font-family: monospace;">
                          %
                        </h1>
                      </div>
                    </div>
                    <div class="flex-fill p-3 text-center"
                          style="border-radius: 12px; background: #1F2937; box-shadow: 0 4px 8px #000000d2">
                      <div class="text-white d-block">Excused</div>
                      <div class="d-flex justify-content-center align-items-center">
                        <h1 id="summaryExcused" class="fw-bold text-blue" style="font-family: monospace;">
                          --
                        </h1>
                        <h1 id="summaryExcusedBadge" class="badge bg-info-subtle text-info ms-1 d-none" style="font-family: monospace;">
                          %
                        </h1>
                      </div>
                    </div>
                    <div class="flex-fill p-3 text-center"
                          style="border-radius: 12px; background: #1F2937; box-shadow: 0 4px 8px #000000d2">
                      <div class="text-white">Absent</div>
                      <div class="d-flex justify-content-center align-items-center">
                        <h1 id="summaryAbsent" class="fw-bold text-red" style="font-family: monospace;">
                          --
                        </h1>
                        <h1 id="summaryAbsentBadge" class="badge bg-danger-subtle text-danger ms-1 d-none" style="font-family: monospace;">
                          %
                        </h1>
                      </div>
                    </div>
                  </div>

                  <!-- Row 3: Clock In Button -->
                  <div class="d-flex justify-content-center m-3 ">
                    <button id="clockInBtn" data-bs-toggle="modal" data-bs-target="#dashboardAttendanceModal"
                            class="btn flex-fill py-3 fw-bold border-0" style="width: 50%; border-radius: 12px; background: #1F2937; box-shadow: 0 4px 8px #000000d2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-clock-down">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M20.984 12.535a9 9 0 1 0 -8.431 8.448" />
                        <path d="M12 7v5l3 3" /><path d="M19 16v6" /><path d="M22 19l-3 3l-3 -3" />
                      </svg>
                      Clock In
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-12 col-lg-8">
          <div id="calendar"></div>
        </div>

        <div class="col-md-6 col-lg-4 p-4">
          <div class="row gy-3 mx-auto">
            <h1 class="card-title fw-bold mt-4">Upcoming Events</h1>
            {% if available_events %}
              <div id="dashboardEventCarousel" class="vertical-carousel">
                {% for event in available_events %}
                  <div class="team-slide">
                    <div class="event-card overflow-hidden shadow-sm"
                        style="height: min-height: 350px; min-width: 400px; border-radius: 14px;">
                      {% if event.event_image %}
                        <img src="{{ event.event_image.url }}" alt="{{ event.name }}"
                              style="object-fit:cover; width: 350px; height: 350px;">
                      {% else %}
                        <img src="{% static 'images/event-placeholder.png' %}" alt="{{ event.name }}"
                              class="d-flex align-items-center justify-content-center bg-dark text-muted" 
                              style="object-fit:cover; width: 350px; height: 350px;">
                      {% endif %}
                    </div>
                    <div class="left-badge badge fw-semibold" style="color: {{ event.team_color_hex }};">
                      {{ event.team_name }}
                    </div>
                    <div class="right-badge badge text-white fw-bold">{{ event.name }} â€” {{ event.date }}</div>
                  </div>
                  
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>

        {% if request.user|in_team:"Magnet" %}
          <div class="col-sm-6 col-lg-3">
            <div class="card">
              <div class="card-body">
                <div class="subheader">My Guest Entries</div>
                <div class="d-flex align-items-baseline">
                  <div class="h3 me-2" data-count="{{ user_total_guest_entries }}">0
                    {{ user_total_guest_entries }}
                  </div>
                  <div class="me-auto">
                    <span class="d-inline-flex align-items-center lh-1"
                          data-bs-toggle="tooltip" 
                          title="Change compared to previous month">
                      {% if user_guest_entry_diff_positive %}
                        <span class="text-green">
                          +{{ user_guest_entry_diff_percent }}%
                          <svg xmlns="http://www.w3.org/2000/svg" 
                              width="24" height="24" viewBox="0 0 24 24" fill="none" 
                              stroke="currentColor" stroke-width="2" stroke-linecap="round" 
                              stroke-linejoin="round" class="icon ms-1 icon-2">
                            <path d="M3 17l6 -6l4 4l8 -8"></path>
                            <path d="M14 7h7v7"></path>
                          </svg>
                        </span>
                      {% else %}
                        <span class="text-red">
                          -{{ user_guest_entry_diff_percent }}%
                          <svg xmlns="http://www.w3.org/2000/svg" 
                              width="24" height="24" viewBox="0 0 24 24" fill="none" 
                              stroke="currentColor" stroke-width="2" stroke-linecap="round" 
                              stroke-linejoin="round" class="icon ms-1 icon-2">
                            <path d="M3 7l6 6l4 -4l8 8"></path>
                            <path d="M14 17h7v-7"></path>
                          </svg>
                        </span>
                      {% endif %}
                    </span>
                  </div>
                </div>
                <div class="progress progress-sm" 
                    data-bs-toggle="tooltip" 
                    title="{{ guest_entry_diff_percent }}% change from last month">
                  <div class="progress-bar {% if guest_entry_diff_positive %}bg-success{% else %}bg-danger{% endif %}" 
                      style="width: {{ guest_entry_diff_percent }}%" 
                      role="progressbar" aria-valuenow="{{ guest_entry_diff_percent }}" 
                      aria-valuemin="0" aria-valuemax="100" 
                      aria-label="{{ guest_entry_diff_percent }}% Change">
                    <span class="visually-hidden">
                      {{ guest_entry_diff_percent }}% Change
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-sm-6 col-lg-3">
            <div class="card">
              <div class="card-body">
                <div class="subheader">Planted Guests Growth Rate</div>
                <div class="d-flex align-items-baseline">
                  <div class="h3 me-2" data-count="{{ user_planted_total }}">0
                    {{ user_planted_total }}%
                  </div>
                  <div class="me-auto">
                    <span class="{% if planted_growth_change >= 0 %}text-green{% else %}text-red{% endif %} d-inline-flex align-items-center lh-1"
                          data-bs-toggle="tooltip" 
                          title="Change compared to previous period">
                      {{ planted_growth_change }}%
                      {% if planted_growth_change >= 0 %}
                        <!-- Trending up -->
                        <svg xmlns="http://www.w3.org/2000/svg" 
                            width="24" height="24" 
                            viewBox="0 0 24 24" 
                            fill="none" stroke="currentColor" 
                            stroke-width="2" stroke-linecap="round" 
                            stroke-linejoin="round" 
                            class="icon ms-1 icon-2">
                          <path d="M3 17l6 -6l4 4l8 -8"></path>
                          <path d="M14 7h7v7"></path>
                        </svg>
                      {% else %}
                        <!-- Trending down -->
                        <svg xmlns="http://www.w3.org/2000/svg" 
                            width="24" height="24" 
                            viewBox="0 0 24 24" 
                            fill="none" stroke="currentColor" 
                            stroke-width="2" stroke-linecap="round" 
                            stroke-linejoin="round" 
                            class="icon ms-1 icon-2">
                          <path d="M3 7l6 6l4 -4l8 8"></path>
                          <path d="M21 10v7h-7"></path>
                        </svg>
                      {% endif %}
                    </span>
                  </div>
                </div>
                <div class="progress progress-sm" 
                    data-bs-toggle="tooltip" 
                    title="{{ planted_growth_rate }}% of guests are planted">
                  <div class="progress-bar {% if planted_growth_rate >= 0 %}bg-success{% else %}bg-danger{% endif %}"
                      style="width: {{ planted_growth_rate }}%" 
                      role="progressbar" 
                      aria-valuenow="{{ planted_growth_rate }}" 
                      aria-valuemin="0" aria-valuemax="100" 
                      aria-label="{{ planted_growth_rate }}% Complete">
                    <span class="visually-hidden">
                      {{ planted_growth_rate }}% Complete
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endif %}

        {% if request.user|in_team:"Magnet" %}
          <div class="col-sm-6 col-lg-3">
            <div class="card">
              <div class="card-body">
                <div class="subheader">Total Guests</div>
                <div class="d-flex align-items-baseline">
                  <div class="h1 mb-0 me-2" data-count="{{ total_guests }}">0</div>
                  <div class="me-auto">
                    {% if increase_rate >= 0 %}
                      <span class="text-green d-inline-flex align-items-center lh-1">
                        {{ increase_rate }}%
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon ms-1 icon-2"
                          width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path d="M3 17l6 -6l4 4l8 -8"></path>
                          <path d="M14 7l7 0l0 7"></path>
                        </svg>
                      </span>
                    {% else %}
                      <span class="text-red d-inline-flex align-items-center lh-1">
                        {{ increase_rate }}%
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon ms-1 icon-2"
                          width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path d="M3 7l6 6l4 -4l8 8"></path>
                          <path d="M14 17l7 0l0 -7"></path>
                        </svg>
                      </span>
                    {% endif %}
                  </div>
                </div>
                <div class="text-secondary mt-2">
                  <span class="{% if percent_change < 0 %}text-red{% else %}text-green{% endif %} d-inline-flex align-items-center lh-1">
                    {{ percent_change }}%
                  </span>
                  {% if increase_rate >= 0 %}increased{% else %}decreased{% endif %}
                  from last month
                </div>
              </div>
            </div>
          </div>

          <div class="col-sm-6 col-lg-3">
            <div class="card">
              <div class="card-body">
                <div class="subheader">Most Attended Service</div>
                <div class="d-flex align-items-baseline mb-2">
                  <div class="h1 mb-0 me-2" data-count="{{ most_attended_count }}">0</div>
                  <div class="me-auto">
                    <span class="text-green d-inline-flex align-items-center lh-1">
                      {{ attendance_rate }}%
                      <svg xmlns="http://www.w3.org/2000/svg"
                        class="icon ms-1 icon-2"
                        width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 17l6 -6l4 4l8 -8"></path>
                        <path d="M14 7l7 0l0 7"></path>
                      </svg>
                    </span>
                  </div>
                </div>
                <div class="text-secondary mb-3">
                  {{ most_attended_service }}
                </div>
              </div>
            </div>
          </div>
        {% endif %}

        {% if request.user|in_team:"Magnet" %}
          <div class="col-sm-6 col-lg-3">
            <div class="card">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="subheader">Home Church Visits</div>
                  <!-- Chart Icon -->
                  <div class="ms-auto lh-1">
                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-home-heart">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M21 12l-9 -9l-9 9h2v7a2 2 0 0 0 2 2h6" />
                      <path d="M9 21v-6a2 2 0 0 1 2 -2h2c.39 0 .754 .112 1.061 .304" />
                      <path d="M19 21.5l2.518 -2.58a1.74 1.74 0 0 0 0 -2.413a1.627 1.627 0 0 0 -2.346 0l-.168 .172l-.168 -.172a1.627 1.627 0 0 0 -2.346 0a1.74 1.74 0 0 0 0 2.412l2.51 2.59z" />
                    </svg>
                  </div>
                </div>
                <div class="h1 mb-3" data-count="{{ home_church_count }}">0</div>
                <div class="d-flex mb-2">
                  <div>{{ home_church_percentage }}%</div>
                </div>
                <div class="progress progress-sm mb-3">
                  <div class="progress-bar bg-primary"
                    style="width: {{ home_church_percentage }}%"
                    role="progressbar"
                    aria-valuenow="{{ home_church_percentage }}"
                    aria-valuemin="0"
                    aria-valuemax="100">
                  </div>
                </div>
                <!-- Chart Container -->
                <div id="chart-home-church" style="min-height: 150px;"></div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="card">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="subheader">Occasional Visits</div>
                  <!-- Chart Icon -->
                  <div class="ms-auto lh-1">
                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-arrows-shuffle">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 4l3 3l-3 3" />
                      <path d="M18 20l3 -3l-3 -3" /><path d="M3 7h3a5 5 0 0 1 5 5a5 5 0 0 0 5 5h5" /><path d="M21 7h-5a4.978 4.978 0 0 0 -3 1m-4 8a4.984 4.984 0 0 1 -3 1h-3" />
                    </svg>
                  </div>
                </div>
                <div class="h1 mb-3" data-count="{{ occasional_visit_count }}">0</div>
                <div class="d-flex mb-2">
                  <div>{{ occasional_visit_percentage }}%</div>
                </div>
                <div class="progress progress-sm mb-3">
                  <div class="progress-bar bg-primary"
                    style="width: {{ occasional_visit_percentage }}%"
                    role="progressbar"
                    aria-valuenow="{{ occasional_visit_percentage }}"
                    aria-valuemin="0"
                    aria-valuemax="100">
                  </div>
                </div>
                <!-- Chart Container -->
                <div id="chart-occasional-visit" style="min-height: 150px;"></div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="card">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="subheader">One-Time Visits</div>
                  <!-- Chart Icon -->
                  <div class="ms-auto lh-1">
                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-repeat-once">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 12v-3a3 3 0 0 1 3 -3h13m-3 -3l3 3l-3 3" />
                      <path d="M20 12v3a3 3 0 0 1 -3 3h-13m3 3l-3 -3l3 -3" /><path d="M11 11l1 -1v4" />
                    </svg>
                  </div>
                </div>
                <div class="h1 mb-3" data-count="{{ one_time_visit_count }}">0</div>
                <div class="d-flex mb-2">
                  <div>{{ one_time_visit_percentage }}%</div>
                </div>
                <div class="progress progress-sm mb-3">
                  <div class="progress-bar bg-primary"
                    style="width: {{ one_time_visit_percentage }}%"
                    role="progressbar"
                    aria-valuenow="{{ one_time_visit_percentage }}"
                    aria-valuemin="0"
                    aria-valuemax="100">
                  </div>
                </div>
                <!-- Chart Container -->
                <div id="chart-one-time-visit" style="min-height: 150px;"></div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="card">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="subheader">Special Programme Visits</div>
                  <!-- Chart Icon -->
                  <div class="ms-auto lh-1">
                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-camera-star">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10.5 20h-5.5a2 2 0 0 1 -2 -2v-9a2 2 0 0 1 2 -2h1a2 2 0 0 0 2 -2a1 1 0 0 1 1 -1h6a1 1 0 0 1 1 1a2 2 0 0 0 2 2h1a2 2 0 0 1 2 2v2.5" /><path d="M14.569 11.45a3 3 0 1 0 -4.518 3.83" />
                      <path d="M17.8 20.817l-2.172 1.138a.392 .392 0 0 1 -.568 -.41l.415 -2.411l-1.757 -1.707a.389 .389 0 0 1 .217 -.665l2.428 -.352l1.086 -2.193a.392 .392 0 0 1 .702 0l1.086 2.193l2.428 .352a.39 .39 0 0 1 .217 .665l-1.757 1.707l.414 2.41a.39 .39 0 0 1 -.567 .411l-2.172 -1.138z" />
                    </svg>
                  </div>
                </div>
                <div class="h1 mb-3" data-count="{{ special_programme_count }}">0</div>
                <div class="d-flex mb-2">
                  <div>{{ special_programme_percentage }}%</div>
                </div>
                <div class="progress progress-sm mb-3">
                  <div class="progress-bar bg-primary"
                    style="width: {{ special_programme_percentage }}%"
                    role="progressbar"
                    aria-valuenow="{{ special_programme_percentage }}"
                    aria-valuemin="0"
                    aria-valuemax="100">
                  </div>
                </div>
                <!-- Chart Container -->
                <div id="chart-special-programme" style="min-height: 150px;"></div>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="row row-cards">
              <div class="col-sm-6 col-lg-3">
                <div class="card card-sm">
                  <div class="card-body">
                    <div class="row align-items-center">
                      <div class="col-auto">
                        <span class="avatar bg-green text-white">
                          <!-- Icon: Check Copy (Filled) -->
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                              viewBox="0 0 24 24" fill="currentColor"
                              class="icon icon-tabler icons-tabler-filled icon-tabler-copy-check">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M18.333 6a3.667 3.667 0 0 1 3.667 3.667v8.666a3.667 3.667 0 0 1 -3.667 3.667h-8.666a3.667 3.667 0 0 1 -3.667 -3.667v-8.666a3.667 3.667 0 0 1 3.667 -3.667zm-3.333 -4c1.094 0 1.828 .533 2.374 1.514a1 1 0 1 1 -1.748 .972c-.221 -.398 -.342 -.486 -.626 -.486h-10c-.548 0 -1 .452 -1 1v9.998c0 .32 .154 .618 .407 .805l.1 .065a1 1 0 1 1 -.99 1.738a3 3 0 0 1 -1.517 -2.606v-10c0 -1.652 1.348 -3 3 -3zm1.293 9.293l-3.293 3.292l-1.293 -1.292a1 1 0 0 0 -1.414 1.414l2 2a1 1 0 0 0 1.414 0l4 -4a1 1 0 0 0 -1.414 -1.414" />
                          </svg>
                        </span>
                      </div>
                      <div class="col">
                        <div class="font-weight-medium">Planted</div>
                        <div class="text-secondary" data-count="{{ planted_count }}">0 guests</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-3">
                <div class="card card-sm">
                  <div class="card-body">
                    <div class="row align-items-center">
                      <div class="col-auto">
                        <span class="avatar bg-danger text-white">
                          <!-- Icon: Copy X (Filled) -->
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                              viewBox="0 0 24 24" fill="currentColor"
                              class="icon icon-tabler icons-tabler-filled icon-tabler-copy-x">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M18.333 6a3.667 3.667 0 0 1 3.667 3.667v8.666a3.667 3.667 0 0 1 -3.667 3.667h-8.666a3.667 3.667 0 0 1 -3.667 -3.667v-8.666a3.667 3.667 0 0 1 3.667 -3.667zm-3.333 -4c1.094 0 1.828 .533 2.374 1.514a1 1 0 1 1 -1.748 .972c-.221 -.398 -.342 -.486 -.626 -.486h-10c-.548 0 -1 .452 -1 1v9.998c0 .32 .154 .618 .407 .805l.1 .065a1 1 0 1 1 -.99 1.738a3 3 0 0 1 -1.517 -2.606v-10c0 -1.652 1.348 -3 3 -3zm.8 8.786l-1.837 1.799l-1.749 -1.785a1 1 0 0 0 -1.319 -.096l-.095 .082a1 1 0 0 0 -.014 1.414l1.749 1.785l-1.835 1.8a1 1 0 0 0 -.096 1.32l.082 .095a1 1 0 0 0 1.414 .014l1.836 -1.8l1.75 1.786a1 1 0 0 0 1.319 .096l.095 -.082a1 1 0 0 0 .014 -1.414l-1.75 -1.786l1.836 -1.8a1 1 0 0 0 .096 -1.319l-.082 -.095a1 1 0 0 0 -1.414 -.014" />
                          </svg>
                        </span>
                      </div>
                      <div class="col">
                        <div class="font-weight-medium">Planted Elsewhere</div>
                        <div class="text-secondary" data-count="{{ planted_elsewhere_count }}">0 guests</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-sm-6 col-lg-3">
                <div class="card card-sm">
                  <div class="card-body">
                    <div class="row align-items-center">
                      <div class="col-auto">
                        <span class="avatar bg-primary text-white">
                          <!-- Icon: Plane Departure -->
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                              viewBox="0 0 24 24" fill="none" stroke="currentColor"
                              stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                              class="icon icon-tabler icons-tabler-outline icon-tabler-plane-departure">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M14.639 10.258l4.83 -1.294a2 2 0 1 1 1.035 3.863l-14.489 3.883l-4.45 -5.02l2.897 -.776l2.45 1.414l2.897 -.776l-3.743 -6.244l2.898 -.777l5.675 5.727z" />
                            <path d="M3 21h18" />
                          </svg>
                        </span>
                      </div>
                      <div class="col">
                        <div class="font-weight-medium">Relocated</div>
                        <div class="text-secondary" data-count="{{ relocated_count }}">0 guests</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-3">
                <div class="card card-sm">
                  <div class="card-body">
                    <div class="row align-items-center">
                      <div class="col-auto">
                        <span class="avatar bg-warning text-white">
                          <!-- Icon: Loader -->
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                              viewBox="0 0 24 24" fill="none" stroke="currentColor"
                              stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                              class="icon icon-tabler icons-tabler-outline icon-tabler-loader">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M12 6l0 -3" />
                            <path d="M16.25 7.75l2.15 -2.15" />
                            <path d="M18 12l3 0" />
                            <path d="M16.25 16.25l2.15 2.15" />
                            <path d="M12 18l0 3" />
                            <path d="M7.75 16.25l-2.15 2.15" />
                            <path d="M6 12l-3 0" />
                            <path d="M7.75 7.75l-2.15 -2.15" />
                          </svg>
                        </span>
                      </div>
                      <div class="col">
                        <div class="font-weight-medium">Work in Progress</div>
                        <div class="text-secondary" data-count="{{ work_in_progress_count }}">0 guests</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h3 class="card-title mb-0">Guest Entry Summary
                    <small class="text-white ms-2" id="totalGuestYear">(Total: {{ summary_data.total_count }})</small>
                  </h3>
                  <select id="guestEntrySummaryYearFilter" class="form-select form-select-sm" style="width: auto;">
                    {% for year in available_years %}
                      <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                  </select>
                </div>

                <!-- Highest Month -->
                <div class="mb-3">
                  <div class="d-flex justify-content-between">
                    <span class="text-secondary">
                      Month with Highest Guest Entry:                    
                    </span>
                    <span class="text-success fw-bold">
                      {{ summary_data.max_month }} ({{ summary_data.max_count }}) 
                      <span class="text-muted">â€¢ {{ summary_data.max_percent }}%</span>
                    </span>
                  </div>
                  <div class="progress progress-sm mt-1" title="{{ summary_data.max_percent }}%">
                    <div class="progress-bar bg-success" style="width: {{ summary_data.max_percent }}%" 
                        data-bs-toggle="tooltip" data-bs-placement="top" 
                        title="{{ summary_data.max_percent }}%">
                    </div>
                  </div>
                </div>

                <!-- Lowest Month -->
                <div class="mb-3">
                  <div class="d-flex justify-content-between">
                    <span class="text-secondary">
                      Month with Lowest Guest Entry:
                    </span>
                    <span class="text-danger fw-bold">
                      {{ summary_data.min_month }} ({{ summary_data.min_count }}) 
                      <span class="text-muted">â€¢ {{ summary_data.min_percent }}%</span>
                    </span>
                  </div>
                  <div class="progress progress-sm mt-1" title="{{ summary_data.min_percent }}%">
                    <div class="progress-bar bg-danger" style="width: {{ summary_data.min_percent }}%" 
                        data-bs-toggle="tooltip" data-bs-placement="top" 
                        title="{{ summary_data.min_percent }}%">
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card">
              <div class="card-body">
                <h3 class="card-title">Guest Locations (Coming Soon)</h3>
                <div class="ratio ratio-21x9">
                  <div id="map-world" style="width: 100%; height: 100%;"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="row row-cards">
              <div class="col-12">
                <div class="card">
                  <div class="card-body">
                    <p class="mb-3">Top 10 Services Attended</p>
                    <div id="topServicesProgress" class="progress progress-separated mb-3" style="height: 24px;">
                      <!-- Progress bars will be injected here -->
                    </div>
                    <div id="topServicesLabels" class="row g-2">
                      <!-- Labels will be injected here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Channel of Visit</h3>
              </div>
              <table id="channel-of-visit-table" class="table card-table table-vcenter">
                <thead>
                  <tr>
                    <th>Channel</th>
                    <th>Guests</th>
                    <th class="w-50">Progress</th>
                  </tr>
                </thead>
                <tbody id="channelProgressTableBody">
                  {% for channel in channel_stats %}
                  <tr>
                    <td>{{ channel.channel }}</td>
                    <td>{{ channel.count }}</td>
                    <td class="w-50">
                      <div class="progress progress-xs">
                        <div class="progress-bar bg-primary" style="width: {{ channel.percent }}%">
                        </div>
                      </div>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="3" class="text-center text-muted">No data available</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Attendance Modal -->
<div class="modal modal-blur fade" id="dashboardAttendanceModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered" style="border-radius: 24px;">
    <div class="modal-content bg-dark text-white border-0 rounded-3 shadow-lg">
      
      <div class="modal-header border-0 d-flex justify-content-between align-items-center">
        <button type="button" class="btn-close text-red" data-bs-dismiss="modal"></button>
        
      </div>

      <div class="d-flex px-6">
        <span class="fw-bold" style="width: 48px; height: 48px;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#f59f00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-clock-edit" style="width: 100%; height: 100%;">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M21 12a9 9 0 1 0 -9.972 8.948c.32 .034 .644 .052 .972 .052" />
            <path d="M12 7v5l2 2" /><path d="M18.42 15.61a2.1 2.1 0 0 1 2.97 2.97l-3.39 3.42h-3v-3l3.42 -3.39z" />
          </svg>
        </span>
        <div class="ms-auto">
          <span id="modalLiveDate" class="text-muted small me-2"></span> <span class="text-muted">â€”</span>
          <span id="modalLiveTime" class="text-muted small ms-2"></span>
        </div>
      </div>

      <form id="dashboardAttendanceForm" method="POST" action="{% url 'workforce:mark_attendance' %}">
        {% csrf_token %}
        <div class="modal-body" data-team-color="{{ team.color_hex|default:'#22c55e' }}">
          
          <!-- Team Selection -->
          <div id="teamSelectionRow" class="d-flex flex-wrap gap-2 mb-3 justify-content-center">
            {% with memberships=user.team_memberships.all %}
              <!-- GForce (General events) -->
              <button type="button"
                      class="btn px-3 py-2 team-btn text-warning border-0"
                      data-team-id="null"
                      style="border-radius: 12px; background: #111827; box-shadow: 0 4px 8px #000000d2;">
                GForce
              </button>

              {% if memberships %}
                {% for membership in memberships %}
                  {% if membership.team.is_active %}
                    <button type="button"
                            class="btn px-3 py-2 team-btn text-white border-0 {{ membership.team.color_class }}"
                            data-team-id="{{ membership.team.id }}"
                            style="
                              border-radius: 12px;
                              background-color: #1f2937;
                              box-shadow: 0 4px 8px #000000d2;
                            ">
                      {{ membership.team.name }}
                    </button>
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endwith %}
          </div>

          <!-- Hidden Event Carousel -->
          <div id="eventCarouselWrapper" class="mb-4" style="display: none;">
            <div id="eventCarousel" class="carousel slide" data-bs-ride="carousel">
              <div class="carousel-inner" id="eventCarouselInner"></div>

              <button class="carousel-control-prev" type="button" data-bs-target="#eventCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#eventCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
              </button>
            </div>
          </div>

          <!-- Clock / Event Mode -->
          <div class="d-flex flex-column align-items-center text-center">
            <div id="clockSection">
              <div id="modalAnalogClockWrapper">
                <div id="modalLiveDateMini" class="fw-bold mb-2" style="font-size: 1.1rem;"></div>
                <canvas id="modalAnalogClock" width="200" height="200" class="mb-3"></canvas>
                <div id="modalDigitalClock"
                     class="fw-bold"
                     style="font-size: 2.5rem; letter-spacing: 0.05em; font-family: monospace;"></div>
              </div>
            </div>

            <div id="eventModeSection" class="text-center" style="display: none;">
              <h2 id="eventNameDisplay" class="fw-bold mb-1"></h2>
              <div id="eventTypeDisplay" class="text-secondary mb-2"></div>
              <div id="eventCountdown" class="fw-bold mb-2"
                  style="font-size: 2rem; font-family: monospace;">
              </div>
              <div id="eventLocationStatus" class="small mb-3"></div>

              <textarea name="remarks" class="form-control bg-grey-900 text-white border-0 mb-3"
                        placeholder="Optional remarks (e.g. Attended virtually)..."></textarea>

              <div class="d-flex justify-content-center gap-2 flex-wrap">
                <button type="button" class="btn btn-success px-3 py-2 mark-btn"
                        data-event-id="{{ event.id }}" data-status="present">Present</button>
                <button type="button" class="btn btn-warning px-3 py-2 mark-btn"
                        data-event-id="{{ event.id }}" data-status="excused">Excused</button>
                <button type="button" class="btn btn-danger px-3 py-2 mark-btn"
                        data-event-id="{{ event.id }}" data-status="absent">Absent</button>
                <button type="button" id="clockOutBtn" class="btn btn-secondary px-3 py-2 mark-btn d-none" data-status="clock_out">Clock Out</button>
              </div>
            </div>
          </div>

          <input type="hidden" name="event_id" id="eventIdField">
          <input type="hidden" name="latitude" id="latitude">
          <input type="hidden" name="longitude" id="longitude">
        </div>
      </form>
    </div>
  </div>
</div>



{% endblock %}

{% block extra_js %}

<script>
document.addEventListener("DOMContentLoaded", function () {
  const calendarEl = document.getElementById("calendar");

  const calendar = new FullCalendar.Calendar(calendarEl, {
    
    initialView: "dayGridMonth",
    height: "auto",
    expandRows: true,
    timeZone: "local",
    themeSystem: "bootstrap5",
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "dayGridMonth,dayGridWeek,dayGridDay",
    },
    buttonText: {
      today: 'Today',
      month: 'Month',
      week: 'Week',
      day: 'Day',
    },
    events: "/api/events/",

    // âœ… Show only color strips (no text)
    eventContent: function (arg) {
      const bgColor = arg.event.extendedProps.color || arg.event.backgroundColor || "#4dabf7";
      const strip = document.createElement("div");
      strip.classList.add("color-strip");
      strip.style.backgroundColor = bgColor;
      return { domNodes: [strip] };
    },

    // âœ… Popup showing events for a clicked date
    dateClick: function (info) {
      const clickedDate = info.dateStr;
      const events = calendar.getEvents().filter((e) => {
        const eventDate = new Date(e.start).toISOString().split("T")[0];
        return eventDate === clickedDate;
      });

      if (events.length === 0) return;

      // Remove any previous popup
      document.querySelectorAll(".calendar-popup").forEach((el) => el.remove());

      const popup = document.createElement("div");
      popup.classList.add("calendar-popup");

      const box = document.createElement("div");
      box.classList.add("calendar-popup-box");

      const title = document.createElement("h5");
      title.classList.add("calendar-popup-title");
      title.textContent = new Date(info.date).toLocaleDateString(undefined, {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
      });
      box.appendChild(title);

      const list = document.createElement("ul");
      list.classList.add("calendar-popup-list");

      events.forEach((event) => {
        const item = document.createElement("li");

        const colorDot = document.createElement("span");
        colorDot.classList.add("color-dot");
        colorDot.style.backgroundColor =
          event.extendedProps.color || event.backgroundColor || "#4dabf7";

        const main = document.createElement("div");
        main.classList.add("event-info");

        const name = document.createElement("div");
        name.classList.add("event-title");
        name.textContent = event.title;

        const meta = document.createElement("div");
        meta.classList.add("event-meta");

        // Time
        if (event.start) {
          const time = document.createElement("span");
          time.classList.add("event-chip");
          const eventTime = new Date(event.start);
          time.textContent = `ðŸ•’ ${eventTime.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          })}`;
          meta.appendChild(time);
        }

        // Mode
        const mode = event.extendedProps.mode;
        if (mode) {
          const modeChip = document.createElement("span");
          modeChip.classList.add("event-chip");
          modeChip.textContent = mode;
          meta.appendChild(modeChip);
        }

        // Type
        const type = event.extendedProps.type;
        if (type) {
          const typeChip = document.createElement("span");
          typeChip.classList.add("event-chip");
          typeChip.textContent = type;
          meta.appendChild(typeChip);
        }

        // Team
        const team = event.extendedProps.team;
        if (team) {
          const teamChip = document.createElement("span");
          teamChip.classList.add("event-chip");
          teamChip.textContent = team;
          // optionally style chip with team color
          teamChip.style.backgroundColor = event.extendedProps.team_color_class || "#2e303e";
          teamChip.style.color = "#fff";
          meta.appendChild(teamChip);
        }

        main.appendChild(name);
        main.appendChild(meta);

        item.appendChild(colorDot);
        item.appendChild(main);
        list.appendChild(item);
      });

      box.appendChild(list);
      popup.appendChild(box);
      document.body.appendChild(popup);

      // Show animation
      setTimeout(() => popup.classList.add("show"), 10);

      // Close on background click
      popup.addEventListener("click", (e) => {
        if (e.target === popup) popup.remove();
      });
    },
  });

  calendar.render();

  // Team Marquee Scroll
  document.querySelectorAll(".scroll-track").forEach((track) => {
    const container = track.parentElement; // scroll-wrapper
    const trackWidth = track.scrollWidth;
    const containerWidth = container.offsetWidth;

    // Only scroll if the track is wider than the container
    if (trackWidth > containerWidth) {
      // Duplicate content for seamless scroll
      track.innerHTML += track.innerHTML;

      const totalWidth = track.scrollWidth / 2;
      const duration = totalWidth / 50; // tweak for speed
      const direction = track.dataset.direction === "right" ? "reverse" : "normal";

      track.style.animation = `scroll-marquee ${duration}s linear infinite ${direction}`;
      track.addEventListener("animationiteration", () => {
        track.style.transform = "translateX(0)";
      });

      // Pause/resume on hover or touch
      const pauseAnimation = () => (track.style.animationPlayState = "paused");
      const resumeAnimation = () => (track.style.animationPlayState = "running");

      container.addEventListener("mouseenter", pauseAnimation);
      container.addEventListener("mouseleave", resumeAnimation);

      container.addEventListener("touchstart", pauseAnimation);
      container.addEventListener("touchend", resumeAnimation);
    } else {
      // Short lists: remove animation and reset transform
      track.style.animation = "none";
      track.style.transform = "translateX(0)";
    }
  });


  // Team Animated Switch
  const containers = document.querySelectorAll(".team-container");

  containers.forEach(container => {
    const items = container.querySelectorAll(".team-item");
    if (items.length <= 1) return; // only one item â†’ no animation

    let current = 0;

    setInterval(() => {
      const currentItem = items[current];
      const next = (current + 1) % items.length;
      const nextItem = items[next];

      // Slide current out
      currentItem.classList.add("slide-out");
      currentItem.classList.remove("slide-in");

      // Prepare next to slide in
      nextItem.classList.add("slide-in");
      nextItem.classList.remove("d-none");

      // After animation, swap visibility
      setTimeout(() => {
        currentItem.classList.add("d-none");
        currentItem.classList.remove("slide-out");
        nextItem.classList.remove("slide-in");
        current = next;
      }, 500); // matches CSS transition
    }, 3000); // change every 3 seconds
  });


  const liveDate = document.getElementById("liveDate");
  const digitalClock = document.getElementById("digitalClock");
  const analogClock = document.getElementById("analogClock");
  const ctx = analogClock.getContext("2d");
  const clockInBtn = document.getElementById("clockInBtn");
  const timeCard = document.getElementById("timeCard");

  let clockedIn = false;
  const attendanceMarked = {};

  // ðŸŽ¨ Use user's assigned color
  const userColor = timeCard.dataset.userColor || "#4dabf7";

  // ðŸ—“ï¸ Live Date
  function updateLiveDate() {
    const now = new Date();
    const options = { weekday: "long", year: "numeric", month: "long", day: "2-digit" };
    liveDate.textContent = now.toLocaleDateString("en-US", options);
    liveDate.style.color = userColor;
  }

  // ðŸ•‘ Digital Clock
  function updateDigitalClock() {
    const now = new Date();
    digitalClock.textContent = now.toLocaleTimeString([], { hour12: false });
  }

  // â° Analog Clock
  function drawAnalogClock() {
    const now = new Date();
    const radius = analogClock.width / 2;

    ctx.clearRect(0, 0, analogClock.width, analogClock.height);
    ctx.save();
    ctx.translate(radius, radius);

    // Face
    ctx.beginPath();
    ctx.arc(0, 0, radius - 5, 0, 2 * Math.PI);
    ctx.fillStyle = "#0f172a";
    ctx.fill();
    ctx.lineWidth = 3;
    ctx.strokeStyle = `${userColor}55`;
    ctx.stroke();

    // Tick Marks
    for (let i = 0; i < 60; i++) {
      ctx.beginPath();
      const len = i % 5 === 0 ? 8 : 3;
      ctx.lineWidth = i % 5 === 0 ? 2 : 1;
      ctx.strokeStyle = "#475569";
      ctx.moveTo(0, -radius + 5);
      ctx.lineTo(0, -radius + 5 + len);
      ctx.stroke();
      ctx.rotate(Math.PI / 30);
    }

    // Numbers
    ctx.fillStyle = "#cbd5e1";
    ctx.font = "15px monospace";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    for (let num = 1; num <= 12; num++) {
      const angle = (num * Math.PI) / 6;
      ctx.rotate(angle);
      ctx.translate(0, -radius * 0.78);
      ctx.rotate(-angle);
      ctx.fillText(num, 0, 0);
      ctx.rotate(angle);
      ctx.translate(0, radius * 0.78);
      ctx.rotate(-angle);
    }

    const hour = now.getHours() % 12;
    const minute = now.getMinutes();
    const second = now.getSeconds();

    function drawHand(angle, length, width, color) {
      ctx.beginPath();
      ctx.lineWidth = width;
      ctx.lineCap = "round";
      ctx.strokeStyle = color;
      ctx.moveTo(0, 0);
      ctx.rotate(angle);
      ctx.lineTo(0, -length);
      ctx.stroke();
      ctx.rotate(-angle);
    }

    drawHand((hour * 30 + minute / 2) * Math.PI / 180, radius * 0.5, 5, userColor);
    drawHand(minute * 6 * Math.PI / 180, radius * 0.75, 3, userColor);
    drawHand(second * 6 * Math.PI / 180, radius * 0.9, 1, "#8f8f8fff");

    ctx.restore();
  }

  // ðŸŽ¨ Dynamic Theme
  function updateTheme() {
    const hour = new Date().getHours();
    const isDaytime = hour >= 6 && hour < 18;

    timeCard.style.backgroundColor = isDaytime ? "#384455ff" : "#0f172a";
    timeCard.style.color = isDaytime ? "#1f2937" : "#f3f4f6";
    timeCard.style.boxShadow = `inset 0 2px 4px ${userColor}44, 0 4px 8px #000000d2`;

    digitalClock.style.color = userColor;

    clockInBtn.style.color = userColor;
  }

  setInterval(() => {
    updateLiveDate();
    updateDigitalClock();
    drawAnalogClock();
    updateTheme();
  }, 1000);

  // ============================
  // ðŸŒ WebSocket + Attendance Summary
  // ============================
  const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
  const ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws/attendance/`);

  // âœ… Keep the same fetchSummary() name
  async function fetchSummary(data = null) {
    try {
      // If no data is passed (e.g., initial load or manual call), fallback to API fetch
      if (!data) {
        const res = await fetch("/accounts/attendance/summary/");
        data = await res.json();
      }

      const summary = data.summary || {};
      const totals = data.totals || {};
      const today = data.today || {};

      const eventId = window.currentEvent?.id;
      const clockOutBtn = document.querySelector(".mark-btn[data-status='clock_out']");

      // Sync attendanceMarked based on backend summary
      if (eventId && today.clock_in && !today.clock_out) {
        attendanceMarked[eventId] = true;
        if (clockOutBtn) clockOutBtn.classList.remove("d-none");
      } else if (eventId && today.clock_out) {
        // User already clocked out
        attendanceMarked[eventId] = false;
        if (clockOutBtn) clockOutBtn.classList.add("d-none");
      }

      // Detect if these are percentages (string with "%")
      const isPercentage = typeof summary.present === "string" && summary.present.includes("%");

      // Safe helper
      const formatValue = (val) => (typeof val === "string" ? val.replace("%", "") : val);

      // Update text content
      document.getElementById("summaryPresent").textContent = formatValue(summary.present);
      document.getElementById("summaryExcused").textContent = formatValue(summary.excused);
      document.getElementById("summaryAbsent").textContent = formatValue(summary.absent);

      document.getElementById("totalClockIn").textContent = formatValue(totals.clock_in);
      document.getElementById("totalClockOut").textContent = formatValue(totals.clock_out);

      // Show or hide badges depending on mode
      const toggleBadge = (id, show) => {
        const el = document.getElementById(id);
        if (el) el.classList.toggle("d-none", !show);
      };

      toggleBadge("summaryPresentBadge", isPercentage);
      toggleBadge("summaryExcusedBadge", isPercentage);
      toggleBadge("summaryAbsentBadge", isPercentage);
      toggleBadge("totalClockInBadge", isPercentage);
      toggleBadge("totalClockOutBadge", isPercentage);

      clockedIn = data.today.clocked_in;
      clockInBtn.textContent = clockedIn ? "Clock Out" : "Clock In";

    } catch (error) {
      console.error("âš ï¸ Error fetching summary:", error);
    }
  }

  // --- Helper: Update summary table ---
  function updateAttendanceSummary(records) {
    const tbody = document.querySelector("#attendanceTableBody");
    if (!tbody) return;
    tbody.innerHTML = records.map((r) => `
      <tr>
        <td>${r.date}</td>
        <td>${r.event.name}</td>
        <td>${r.event.team.name || "GForce"}</td>
        <td>${r.user.title || ""} ${r.user.full_name}</td>
        <td>
          ${
            r.status === "present"
              ? `<span class="badge bg-success-lt">Present</span>`
              : r.status === "late"
              ? `<span class="badge bg-danger-lt">Late</span>`
              : r.status === "excused"
              ? `<span class="badge bg-warning-lt">Excused</span>`
              : `<span class="badge bg-secondary-lt">Absent</span>`
          }
        </td>
        <td>${r.clock_in_time || "â€”"}</td>
        <td>${r.clock_out_time || "â€”"}</td>
        <td>${r.remarks || "â€”"}</td>
      </tr>`).join("");
  }

  // ============================
  // ðŸ” WebSocket Setup
  // ============================
  ws.onopen = () => {
    console.log("âœ… Connected to attendance WebSocket");
    // Fetch initial data in case backend hasnâ€™t broadcasted yet
    fetchSummary();
  };

  ws.onmessage = (event) => {
    try {
      const message = JSON.parse(event.data);

      // Check if the message type is relevant to summary updates
      if (message.type === "dashboard_summary") {
        // This will trigger the same UI updates without breaking compatibility
        fetchSummary(message);
      }

      // If you have other message types (like admin table updates), handle them too
      else if (message.type === "send_summary") {
        // existing admin broadcast logic (optional)
        updateAttendanceSummary(message.records);
      }
    } catch (error) {
      console.error("âš ï¸ Error processing WS message:", error);
    }
  };

  ws.onclose = () => {
    console.warn("âš ï¸ Attendance WebSocket closed. Reconnecting in 5s...");
    setTimeout(() => window.location.reload(), 5000);
  };

  // ============================
  // âºï¸ Clock In/Out
  // ============================
  async function toggleClock(forcedAction = null) {
    if (!window.currentEvent?.id) return;

    const action = forcedAction || (clockedIn ? "clock_out" : "clock_in");

    const res = await fetch("/accounts/attendance/clock/", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
      },
      body: new URLSearchParams({
        action,
        event_id: window.currentEvent.id,
      }),
    });

    const data = await res.json();

    if (data.success) {
      clockedIn = data.action === "clock_in";
      clockInBtn.textContent = clockedIn ? "Clock Out" : "Clock In";
      showToast(`âœ… ${data.action.replace("_", " ")} successful`);

      // Trigger UI refresh (will fallback to local fetch if WS didnâ€™t push yet)
      fetchSummary();
      return true;
    } else {
      showToast(`âš ï¸ ${data.error}`);
      return false;
    }
  }

  // ============================
  // ðŸŽ¨ Style + Initial Run
  // ============================
  clockInBtn.style.color = userColor;

  // Load initial summary data immediately on page load
  fetchSummary();

  // ============================
  const userSelect = document.getElementById("userSelect");
  const summaryColumn = document.getElementById("summaryColumn");

  if (userSelect) {
    userSelect.addEventListener("change", async (e) => {
      const selectedUserId = e.target.value;

      if (!selectedUserId) {
        summaryColumn.style.display = "flex"; // show the summary again
        try {
          // Fetch global summary (percentages)
          await fetchSummary();
        } catch (err) {
          console.error("Error loading global summary:", err);
        }
        return;
      }

      // Fetch summary for this user
      try {
        const res = await fetch(`/accounts/attendance/summary/?user_id=${selectedUserId}`);
        const data = await res.json();
        summaryColumn.style.display = "flex"; // reveal the summary section
        fetchSummary(data); // Reuse the same updater
      } catch (err) {
        console.error("Error loading user summary:", err);
      }
    });
  }


  


  ///////////////// Attendance Modal
  const modalLiveDate = document.getElementById("modalLiveDate");
  const modalLiveTime = document.getElementById("modalLiveTime");
  const analog = document.getElementById("modalAnalogClock");
  const ctxModal = analog.getContext("2d");
  const digital = document.getElementById("modalDigitalClock");
  const dateMini = document.getElementById("modalLiveDateMini");
  const eventModeSection = document.getElementById("eventModeSection");
  const clockSection = document.getElementById("clockSection");
  const eventCountdown = document.getElementById("eventCountdown");
  const eventNameDisplay = document.getElementById("eventNameDisplay");
  const eventTypeDisplay = document.getElementById("eventTypeDisplay");
  const eventLocationStatus = document.getElementById("eventLocationStatus");
  const eventCarouselWrapper = document.getElementById("eventCarouselWrapper");
  const eventCarouselInner = document.getElementById("eventCarouselInner");
  const modalEl = document.getElementById("dashboardAttendanceModal");
  const attendanceForm = document.getElementById("dashboardAttendanceForm");

  const teamColor = teamSelectionRow.dataset.teamColor;

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }


  // --- Live Date & Time ---
  function updateDateTime() {
    const now = new Date();
    const options = { weekday: "long", year: "numeric", month: "long", day: "2-digit" };
    modalLiveDate.textContent = now.toLocaleDateString("en-US", options);
    modalLiveTime.textContent = now.toLocaleTimeString([], { hour12: false });
    dateMini.textContent = modalLiveDate.textContent;
    modalLiveDate.style.color = userColor;
    modalLiveTime.style.color = userColor;
    dateMini.style.color = userColor;
  }

  // ðŸ•‘ Digital Modal Clock
  function updateDigitalModalClock() {
    const now = new Date();
    digital.textContent = now.toLocaleTimeString([], { hour12: false });
    digital.style.color = userColor;
  }

  // --- Analog Clock ---
  function drawModalAnalogClock() {
    const now = new Date();
    const radius = analog.width / 2;
    ctxModal.clearRect(0, 0, analog.width, analog.height);
    ctxModal.save();
    ctxModal.translate(radius, radius);
    ctxModal.beginPath();
    ctxModal.arc(0, 0, radius - 5, 0, 2 * Math.PI);
    ctxModal.fillStyle = "#0f172a";
    ctxModal.fill();
    ctxModal.strokeStyle = `${userColor}55`;
    ctxModal.lineWidth = 3;
    ctxModal.stroke();

    const hour = now.getHours() % 12;
    const minute = now.getMinutes();
    const second = now.getSeconds();

    function hand(angle, length, width, color) {
      ctxModal.beginPath();
      ctxModal.lineWidth = width;
      ctxModal.lineCap = "round";
      ctxModal.strokeStyle = color;
      ctxModal.rotate(angle);
      ctxModal.moveTo(0, 0);
      ctxModal.lineTo(0, -length);
      ctxModal.stroke();
      ctxModal.rotate(-angle);
    }

    hand((hour * 30 + minute / 2) * Math.PI / 180, radius * 0.5, 4, userColor);
    hand(minute * 6 * Math.PI / 180, radius * 0.75, 3, userColor);
    hand(second * 6 * Math.PI / 180, radius * 0.9, 1, "#ccc");

    ctxModal.restore();
    digital.textContent = now.toLocaleTimeString([], { hour12: false });
  }

  setInterval(() => {
    updateDateTime();
    updateDigitalModalClock();
    drawModalAnalogClock();
  }, 1000);

  ///// Event Carousel
  async function loadTeamEvents(teamId) {
    // Hide carousel while loading
    eventCarouselWrapper.style.display = "none";
    eventCarouselInner.innerHTML = `<div class="text-center py-4 text-muted">Loading events...</div>`;

    try {
      const url = teamId ? `/api/events/?team_id=${teamId}` : `/api/events/?team_id=null`;
      const res = await fetch(url);
      const data = await res.json();
      const events = data.events || [];

      if (!events.length) {
        eventCarouselInner.innerHTML = `<div class="text-center text-muted py-4">No upcoming events</div>`;
        return;
      }

      const now = new Date();

      // Build event cards inside carousel
      eventCarouselInner.innerHTML = events
        .map((ev, i) => {
          const imageUrl =
            ev.event_image || "/static/images/event-placeholder.png";
          const eventDateTime =
            ev.date && ev.time ? new Date(`${ev.date}T${ev.time}`) : null;
          const eventDate = ev.date
            ? new Date(ev.date).toLocaleDateString("en-US", {
                weekday: "long",
                year: "numeric",
                month: "long",
                day: "2-digit",
              })
            : "TBD";
          const eventTime = ev.time
            ? new Date(`1970-01-01T${ev.time}`).toLocaleTimeString([], {
                hour12: false,
              })
            : "";

        // Determine state
        let isActive = false;
        let isFuture = false;
        let isPast = false;
        let blurClass = "";
        let overlayButton = "";

        if (eventDateTime) {
          const eventDateOnly = new Date(ev.date);
          const today = new Date(now);
          today.setHours(0, 0, 0, 0);
          if (eventDateOnly < today) {
            isPast = true;
            blurClass = "blur opacity-50";
          } else if (eventDateOnly.toDateString() === today.toDateString()) {
            const activeTime = new Date(eventDateTime);
            activeTime.setMinutes(activeTime.getMinutes() - 15);
            if (now >= activeTime) {
              isActive = true;
            } else {
              blurClass = "blur opacity-50";
            }
          } else if (eventDateOnly > today) {
            isFuture = true;
            blurClass = "blur opacity-50";
            if (ev.registrable) {
              overlayButton = `
                <a href="${ev.registration_link || '#'}" target="_blank" 
                  class="m-2 register-btn"
                  data-event='${JSON.stringify(ev)}'>
                  Register
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="icon icon-tabler icons-tabler-filled icon-tabler-pointer">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M3.039 4.277l3.904 13.563c.185 .837 .92 1.516 1.831 1.642l.17 .016a2.2 2.2 0 0 0 1.982 -1.006l.045 -.078l1.4 -2.072l4.05 4.05a2.067 2.067 0 0 0 2.924 0l1.047 -1.047c.388 -.388 .606 -.913 .606 -1.461l-.008 -.182a2.067 2.067 0 0 0 -.598 -1.28l-4.047 -4.048l2.103 -1.412c.726 -.385 1.18 -1.278 1.053 -2.189a2.2 2.2 0 0 0 -1.701 -1.845l-13.524 -3.89a1 1 0 0 0 -1.236 1.24z" />
                  </svg>
                </a>`;
            }
          }
        }

        return `
          <div class="carousel-item ${i === 0 ? "active" : ""}">
            <div class="card flex-fill h-100 position-relative mx-auto" style="max-width: 420px; border-radius: 15px; overflow:hidden;">
              <div class="card-body text-center ${isActive ? "cursor-pointer start-event-btn" : ""}" data-event='${JSON.stringify(ev)}'>
                <img src="${imageUrl}" alt="${ev.name}" 
                    class="card-img-top ${blurClass}" style="height: 250px; object-fit: cover;">
                <h3 class="text-warning fw-bold mb-1" style="color: {{ team.color_hex }};">
                  ${ev.name}
                </h3>
                <div class="mb-1">${eventDate} â€” ${eventTime}</div>
              </div>
              <div class="carousel-eventmode m-2">
                ${ev.attendance_mode} ${ev.event_type}
              </div>
              <div class="overlay-status m-2">
                ${ev.tag}
              </div>
              ${overlayButton}
          </div>
          </div>
        `;
      }).join("");

      eventCarouselWrapper.style.display = "block";
    } catch (err) {
      console.error("Error loading team events:", err);
      eventCarouselInner.innerHTML = `<div class="text-danger text-center py-4">Failed to load events</div>`;
    }
  }

  let activeTeamButton = null;

  document.querySelectorAll("#teamSelectionRow .team-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      // If same button clicked again â†’ deselect
      if (activeTeamButton === btn) {
        btn.classList.remove("active");
        activeTeamButton = null;

        // Hide carousel + event mode, show clock view
        eventCarouselWrapper.style.display = "none";
        exitEventMode();
        clockSection.style.display = "block";
        return;
      }

      // Deactivate previously active team button
      if (activeTeamButton) activeTeamButton.classList.remove("active");

      // Activate new one
      btn.classList.add("active");
      activeTeamButton = btn;

      const teamId = btn.dataset.teamId;
      loadTeamEvents(teamId === "null" ? null : teamId);
    });
  });

  // ---- Carousel Click Handling ----
  eventCarouselInner.addEventListener("click", (e) => {
    const registerBtn = e.target.closest(".register-btn");
    if (registerBtn) {
      const ev = JSON.parse(registerBtn.dataset.event);
      showToast(`ðŸ“ Registered for ${ev.name}!`);
      // optionally send to server
      return;
    }

    const card = e.target.closest(".start-event-btn");
    if (!card) return;
    if (card.closest(".blur")) return; // prevent selecting blurred events

    const eventData = JSON.parse(card.dataset.event);

    // âœ… Check for missing ID (avoids ValueError on backend)
    if (!eventData.id) {
      console.error("Missing event ID:", eventData);
      return;
    }

    selectEvent(eventData);

    // âœ… Log attendance when event starts
    //fetch("/workforce/attendance/", {
    //  method: "POST",
    //  headers: {
    //    "Content-Type": "application/json",
    //    "X-CSRFToken": getCookie("csrftoken"),
    //  },
    //  body: JSON.stringify({ event_id: eventData.id }),
    //})
    //  .then(res => res.json())
    //  .then(data => console.log("Attendance logged:", data))
    //  .catch(err => console.error("Error logging attendance:", err));
  });

  new bootstrap.Carousel(document.getElementById("eventCarousel"), {
    //interval: false, // disables automatic cycling
    touch: true
  });

  // --- CONFIG ---
  const CHURCH_COORDS = { lat: 6.641732871081892, lon: 3.3706539797031843 };  // (latitude, longitude)
  const THRESHOLD_KM = 0.01; // ~10 meters
  let activeCountdownTimer = null;
  let proximityCheckTimer = null;

  async function checkExistingAttendance(eventId) {
    try {
      const res = await fetch(`/accounts/attendance/check/?event_id=${eventId}`);
      const data = await res.json();

      const clockOutBtn = document.querySelector(".mark-btn[data-status='clock_out']");

      if (data.clock_in && !data.clock_out) {
        // User already clocked in â†’ show clock-out button
        clockOutBtn.classList.remove("d-none");
        attendanceMarked[eventId] = true;
      } else {
        // No clock-in or already clocked-out â†’ hide button
        clockOutBtn.classList.add("d-none");
        attendanceMarked[eventId] = false;
      }
    } catch (err) {
      console.error("Error checking attendance state:", err);
    }
  }

  // --- EVENT SELECTION ---
  function selectEvent(eventData) {
    window.currentEvent = eventData;
    checkExistingAttendance(eventData.id);

    clockSection.style.display = "none";
    eventModeSection.style.display = "block";

    // Stop any previous timers
    if (activeCountdownTimer) clearInterval(activeCountdownTimer);
    if (proximityCheckTimer) clearInterval(proximityCheckTimer);

    // --- Attendance Mode Logic ---
    const mode = eventData.attendance_mode?.toLowerCase();
    if (mode === "virtual") {
      eventLocationStatus.textContent = "ðŸŒ This is a Virtual event";
    } else if (mode === "physical") {
      checkProximityAndUpdateStatus();
      proximityCheckTimer = setInterval(() => {
        checkProximityAndUpdateStatus();
      }, 5000);
    }

    // --- Event Details ---
    eventNameDisplay.innerHTML = `<span class="text-warning fw-bold">${eventData.name}</span>`;
    eventTypeDisplay.innerHTML = `
      <span class="text-secondary fst-italic">This is a ${eventData.attendance_mode} ${eventData.event_type}</span>
    `;

    // Reset UI
    eventLocationStatus.textContent = "";
    document.querySelectorAll(".mark-btn").forEach((b) => {
      b.disabled = false;
      b.classList.remove("btn-secondary", "opacity-50");
      b.textContent = b.dataset.status
        .split("_")
        .map((s) => s.charAt(0).toUpperCase() + s.slice(1))
        .join(" ");
    });

    // --- Clock Out Button Visibility ---
    //const clockOutBtn = document.querySelector(".mark-btn[data-status='clock_out']");
    //if (clockOutBtn) {
    //  clockOutBtn.classList.add("d-none"); // hide by default
    //  if (attendanceMarked[eventData.id]) {
    //    clockOutBtn.classList.remove("d-none"); // show if attendance was marked
    //  }
    //}

    // --- Countdown Setup ---
    let targetTime = null;
    if (eventData.date && eventData.time) {
      targetTime = new Date(`${eventData.date}T${eventData.time}`);
    } else if (eventData.time) {
      targetTime = new Date(`1970-01-01T${eventData.time}`);
    }

    if (targetTime && !isNaN(targetTime)) {
      startCountdown(targetTime, eventData);
    } else {
      eventCountdown.textContent = "No event time set";
    }
  }

  // --- COUNTDOWN TIMER ---
  function startCountdown(targetTime, eventData) {
    const mode = eventData.attendance_mode?.toLowerCase();
    if (activeCountdownTimer) clearInterval(activeCountdownTimer);

    activeCountdownTimer = setInterval(() => {
      const now = new Date();
      const diff = targetTime - now;

      if (diff <= 0) {
        clearInterval(activeCountdownTimer);
        eventCountdown.innerHTML = `<span class="text-danger">
          <span class="countdown-end-wiggle ms-2 justify-center align-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" stroke="#9b282fff" fill="#111827" class="icon icon-tabler icons-tabler-filled icon-tabler-alarm" style="width: 48px; height: 48px;">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M16 6.072a8 8 0 1 1 -11.995 7.213l-.005 -.285l.005 -.285a8 8 0 0 1 11.995 -6.643zm-4 2.928a1 1 0 0 0 -1 1v3l.007 .117a1 1 0 0 0 .993 .883h2l.117 -.007a1 1 0 0 0 .883 -.993l-.007 -.117a1 1 0 0 0 -.993 -.883h-1v-2l-.007 -.117a1 1 0 0 0 -.993 -.883z" />
              <path d="M6.412 3.191a1 1 0 0 1 1.273 1.539l-.097 .08l-2.75 2a1 1 0 0 1 -1.273 -1.54l.097 -.08l2.75 -2z" />
              <path d="M16.191 3.412a1 1 0 0 1 1.291 -.288l.106 .067l2.75 2a1 1 0 0 1 -1.07 1.685l-.106 -.067l-2.75 -2a1 1 0 0 1 -.22 -1.397z" />
            </svg>
          </span><br>
          ${eventData.event_type} already started!
        </span>`;
        return;
      }

      const h = Math.floor(diff / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      eventCountdown.innerHTML = `<span class="text-green">
        <span class="countdown-start-wiggle ms-2 justify-center align-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="#111827" stroke="#f59f00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-hourglass-high" style="width: 48px; height: 48px;">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6.5 7h11" />
            <path d="M6 20v-2a6 6 0 1 1 12 0v2a1 1 0 0 1 -1 1h-10a1 1 0 0 1 -1 -1z" />
            <path d="M6 4v2a6 6 0 1 0 12 0v-2a1 1 0 0 0 -1 -1h-10a1 1 0 0 0 -1 1z" />
          </svg>
        </span><br>
        <span style="font-family: monospace;">${h}hr ${m}min ${s}sec</span><br>to go!
      </span>`;
    }, 1000);
  }

  // --- PROXIMITY LOGIC ---
  function checkProximityAndUpdateStatus() {
    const presentBtn = document.querySelector(".mark-btn[data-status='present']");
    getUserDistanceFromChurch(CHURCH_COORDS, THRESHOLD_KM, (distanceKm, withinRange) => {
      if (distanceKm == null) {
        eventLocationStatus.innerHTML = `<span class="fst-italic">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff000fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-map-pin-question">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
            <path d="M14.997 19.317l-1.583 1.583a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 13.657 -5.584" />
            <path d="M19 22v.01" /><path d="M19 19a2.003 2.003 0 0 0 .914 -3.782a1.98 1.98 0 0 0 -2.414 .483" />
          </svg> 
          Unable to determine your location.
          <br>Enable GPS to mark Attendance.
        </span>`;
        presentBtn.disabled = true;
        presentBtn.classList.add("opacity-50");
      } else if (!withinRange) {
        eventLocationStatus.innerHTML = `<span class="fst-italic">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59f00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-map-pin-x">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
            <path d="M13.024 21.204a2 2 0 0 1 -2.437 -.304l-4.244 -4.243a8 8 0 1 1 13.119 -2.766" />
            <path d="M22 22l-5 -5" /><path d="M17 22l5 -5" />
          </svg>
          You are still <span class="fw-bold text-warning">${distanceKm.toFixed(2)} km</span> away from Church!
          <br>Please select other options or get to Church to mark Present.
        </span>`;
        presentBtn.disabled = true;
        presentBtn.classList.add("opacity-50");
      } else {
        eventLocationStatus.innerHTML = `<span class="fst-italic">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="rgba(21, 255, 0, 1)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-map-pin-check">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
            <path d="M11.87 21.48a1.992 1.992 0 0 1 -1.283 -.58l-4.244 -4.243a8 8 0 1 1 13.355 -3.474" />
            <path d="M15 19l2 2l4 -4" />
          </svg> 
          You are within range (<span class="fw-bold text-green">${distanceKm.toFixed(2)} km</span>) to mark Present!
        </span>`;
        presentBtn.disabled = false;
        presentBtn.classList.remove("opacity-50");
      }
    });
  }

  // --- GEOLOCATION UTILITY ---
  function getUserDistanceFromChurch(churchCoords, thresholdKm, callback) {
    if (!navigator.geolocation) {
      callback(null, false);
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;

        // Update hidden form fields for attendance submission
        document.getElementById("latitude").value = userLat;
        document.getElementById("longitude").value = userLon;

        const distanceKm = haversineDistance(userLat, userLon, churchCoords.lat, churchCoords.lon);
        callback(distanceKm, distanceKm <= thresholdKm);
      },
      (err) => {
        console.warn("Geolocation error:", err);
        callback(null, false);
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  }

  // --- HAVERSINE FORMULA ---
  function haversineDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth's radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) ** 2;
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
  }

  function showToast(message) {
    // Replace with your preferred toast/alert system
    const toast = document.createElement("div");
    toast.className = "position-fixed bottom-0 start-50 translate-middle-x bg-dark text-white px-4 py-2 rounded shadow";
    toast.style.zIndex = 2000;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function exitEventMode() {
    if (activeCountdownTimer) clearInterval(activeCountdownTimer);
    if (proximityCheckTimer) clearInterval(proximityCheckTimer);

    eventModeSection.style.display = "none";
    clockSection.style.display = "block";

    eventCountdown.textContent = "";
    eventLocationStatus.textContent = "";

    // âœ… Clear active event
    window.currentEvent = null;
  }

  // --- Handle Present / Excused / Absent buttons ---
  document.querySelectorAll(".mark-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      if (!window.currentEvent || !window.currentEvent.id) {
        alert("No event selected!");
        return;
      }

      const eventId = window.currentEvent.id;
      const status = btn.dataset.status;
      const form = document.getElementById("dashboardAttendanceForm");
      const csrf = form.querySelector("[name=csrfmiddlewaretoken]").value;
      const remarks = form.querySelector("[name=remarks]")?.value || "";
      const lat = document.getElementById("latitude").value;
      const lon = document.getElementById("longitude").value;

      const clockOutBtn = document.querySelector(
        ".mark-btn[data-status='clock_out']"
      );

      // --- Helper to close modal safely ---
      const closeModal = () => {
        const modalInstance = bootstrap.Modal.getInstance(
          document.getElementById("dashboardAttendanceModal")
        );
        if (modalInstance) modalInstance.hide();
      };

      // --- Helper: protect Clock Out until attendance is marked ---
      if (status === "clock_out" && !attendanceMarked[eventId]) {
        showToast("âš ï¸ You must mark attendance before clocking out.");
        return;
      }

      // Disable button while submitting
      btn.disabled = true;
      btn.textContent = "Submitting...";

      try {
        // --- CLOCK OUT FLOW ---
        if (status === "clock_out") {
          const success = await toggleClock("clock_out");

          if (success !== false) {
            showToast("âœ… Clocked out successfully");

            // Reset attendance marker
            attendanceMarked[eventId] = false;

            // Hide the clock-out button again
            if (clockOutBtn) clockOutBtn.classList.add("d-none");

            // Re-enable all attendance buttons for next action
            document.querySelectorAll(".mark-btn").forEach((b) => {
              if (b.dataset.status !== "clock_out") {
                b.disabled = false;
                b.textContent = b.dataset.status
                  .split("_")
                  .map((s) => s[0].toUpperCase() + s.slice(1))
                  .join(" ");
                b.classList.remove("btn-secondary");
              }
            });

            closeModal();
            exitEventMode();
            fetchSummary();
          } else {
            showToast("âš ï¸ Failed to clock out. Try again.");
          }

          btn.disabled = false;
          btn.textContent = "Clock Out";
          return;
        }

        // --- NORMAL ATTENDANCE FLOW ---
        const res = await fetch(form.action, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrf,
            "X-Requested-With": "XMLHttpRequest",
          },
          body: new URLSearchParams({
            event_id: eventId,
            status,
            remarks,
            latitude: lat,
            longitude: lon,
          }),
        });

        const data = await res.json();

        if (res.ok && data.success) {
          attendanceMarked[eventId] = true;

          showToast(`âœ… ${data.message || `${status} marked successfully`}`);

          await toggleClock("clock_in");

          // Show clock-out button
          if (clockOutBtn) clockOutBtn.classList.remove("d-none");

          // Disable all attendance options
          document.querySelectorAll(".mark-btn").forEach((b) => {
            if (b.dataset.status !== "clock_out") {
              b.disabled = true;
              b.textContent = "Already Marked";
              b.classList.add("btn-secondary");
            }
          });

          closeModal();
          exitEventMode();
          fetchSummary();
        } else {
          showToast(`âš ï¸ ${data.error || "Failed to mark attendance"}`);
        }
      } catch (err) {
        console.error("Attendance error:", err);
        showToast("âš ï¸ Network or server error while marking attendance.");
      } finally {
        btn.disabled = false;
        btn.textContent = status
          .split("_")
          .map((s) => s.charAt(0).toUpperCase() + s.slice(1))
          .join(" ");
      }
    });
  });

  ////////////////////////
  // Next Available Event on Dashboard
  const container = document.getElementById("weeklyEventsContainer");
  if (!container) return;

  const getEventItems = () => [...container.querySelectorAll(".weekly-event-item")];
  let currentIndex = 0;

  const updateCountdowns = () => {
    const now = new Date();
    const items = getEventItems();

    items.forEach(item => {
      const targetStr = item.dataset.datetime;
      const isPostponed = item.dataset.postponed === "true";
      const textElem = item.querySelector(".countdown-text");

      // No date set â†’ show â€œPostponed (Date TBD)â€
      if (isPostponed && (!targetStr || targetStr === "null")) {
        textElem.innerHTML = `<span class="text-danger fst-italic">Postponed (Date TBD)</span>`;
        return;
      }

      // Parse target date
      if (!targetStr) return;
      const target = new Date(targetStr);
      const diff = target - new Date();

      // Event started more than 1 hour ago â†’ remove completely
      if (diff <= -3600 * 1000) {
        item.remove();
        return;
      }

      // Event currently in progress (<1 hour since start)
      if (diff <= 0) {
        textElem.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#ff000fff" class="icon icon-tabler icons-tabler-filled icon-tabler-player-record">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M8 5.072a8 8 0 1 1 -3.995 7.213l-.005 -.285l.005 -.285a8 8 0 0 1 3.995 -6.643z" />
        </svg> 
        In Progress`;
        textElem.classList.replace("text-warning", "text-success");
        return;
      }

      // Countdown until event starts
      const hours = Math.floor(diff / 1000 / 60 / 60);
      const mins = Math.floor((diff / 1000 / 60) % 60);
      const secs = Math.floor((diff / 1000) % 60);

      let countdownStr = "";
      if (hours > 0) countdownStr += `${hours}hr `;
      if (mins > 0 || hours > 0) countdownStr += `${mins}min `;
      countdownStr += `${secs}sec`;

      textElem.innerHTML = `<span class="fst-italic">Starts in â€” </span>
        <span style="font-family: monospace; font-size: 1.1rem">${countdownStr}</span>`;
    });

    // If all events are gone â†’ show placeholder
    const remaining = getEventItems();
    if (remaining.length === 0) {
      container.innerHTML = `<div class="text-muted text-center small">No events scheduled this week.</div>`;
    }
  };

  // Hide all except first item
  const showCurrentItemOnly = () => {
    const items = getEventItems();
    items.forEach((it, i) => {
      if (i === currentIndex) {
        it.classList.remove("d-none");
        it.classList.add("flash-animate");
      } else {
        it.classList.add("d-none");
        it.classList.remove("flash-animate", "flip-in", "flip-out");
      }
    });
    currentIndex = 0;
  };

  // ðŸ” Rotate between multiple active events with flip & scale
  const rotateEvents = () => {
    const items = getEventItems();
    if (items.length <= 1) return;

    const currentItem = items[currentIndex];

    // Animate current item out: flip + shrink
    currentItem.classList.add("flip-out");
    currentItem.addEventListener("animationend", function hideCurrent() {
      currentItem.classList.add("d-none");
      currentItem.classList.remove("flip-out", "flash-animate");
      currentItem.removeEventListener("animationend", hideCurrent);

      // Advance index
      currentIndex = (currentIndex + 1) % items.length;
      const nextItem = items[currentIndex];

      // Prepare next item
      nextItem.classList.remove("d-none");
      nextItem.classList.add("flip-in", "flash-animate");

      nextItem.addEventListener("animationend", function cleanNext() {
        nextItem.classList.remove("flip-in");
        nextItem.removeEventListener("animationend", cleanNext);
      });
    });
  };

  // Initialize countdowns and rotation
  updateCountdowns();
  showCurrentItemOnly();
  setInterval(updateCountdowns, 1000);
  setInterval(rotateEvents, 6000);

  // Ensure only first shows when page becomes visible again
  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) {
      showCurrentItemOnly();
    }
  });

  // Add CSS for flip + scale animations
  const style = document.createElement("style");
  style.innerHTML = `
  /* Flash pulse */
  @keyframes flashPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; color: #fbbf24; }
  }
  .flash-animate {
    animation: flashPulse 1.5s ease-in-out 2 infinite;
  }

  /* Flip out (current event card flips upward & shrinks) */
  @keyframes flipOutDown {
    0% { transform: rotateX(0deg) scale(1); opacity: 1; }
    100% { transform: rotateX(90deg) scale(0.8); opacity: 0; }
  }
  .flip-out {
    animation: flipOutDown 0.6s ease forwards;
  }

  /* Flip in (next event card flips downwards & grows) */
  @keyframes flipInDown {
    0% { transform: rotateX(-90deg) scale(0.8); opacity: 0; }
    100% { transform: rotateX(0deg) scale(1); opacity: 1; }
  }
  .flip-in {
    animation: flipInDown 0.6s ease forwards;
  }

  /* Smooth transition for hidden items */
  #eventDisplayArea .d-none {
    opacity: 0;
    pointer-events: none;
  }
  `;
  document.head.appendChild(style);


  ////////////////////////
  // Dashboard Event Carousel
  const slides = document.querySelectorAll(".team-slide");
  if (!slides.length) return;

  let current = 0;
  slides[current].classList.add("active");

  setInterval(() => {
    slides[current].classList.remove("active");
    current = (current + 1) % slides.length;
    slides[current].classList.add("active");
  }, 7000); // change slide every 7 seconds


});
</script>

{% endblock %}