{% extends 'base.html' %}
{% load guest_extras %}
{% block title %}Guest Report{% endblock %}
{% load widget_tweaks %}
{% load form_tags %}
{% load access_tags %}


{% block content %}


<!-- Updated Follow-Up Report Page Template -->
<div class="page-wrapper">
  
  <div class="page-header d-print-none" aria-label="Page Header">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <h3 class="page-title text-white mt-1">
            <small class="text-warning"> Report(s) on {{ guest.title }} {{ guest.full_name }} </small>
          </h3>
        </div>
      </div>
    </div>
  </div>

  <div class="page-body">
    <div class="container-xl">
      <div class="row row-deck row-cards justify-content-center">
      
        <!-- Past Reports Section -->
        <div class="col-12 mb-4">
          <div class="card">
            
            <div class="card-table">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-start flex-wrap w-100">
                  <!-- Left section: Title and pagination -->
                  <div>
                    <h3 class="card-title mb-0">Past Reports</h3>
                    <p class="text-secondary m-0">
                      {% with start=page_obj.start_index end=page_obj.end_index total=page_obj.paginator.count %}
                        <i><small class="text-warning">You are viewing {{ start }}â€“{{ end }} of {{ total }} Report(s)</small></i>
                      {% endwith %}
                    </p>
                  </div>

                  <!-- Right section: Export button -->
                  <div class="ms-auto">
                    <a href="{% url 'export_followup_reports_pdf' guest.id %}" class="btn btn-grey ms-auto">
                      <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-file-export">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" />
                        <path d="M11.5 21h-4.5a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v5m-5 6h7m-3 -3l3 3l-3 3" />
                      </svg>
                      Export Report
                    </a>
                  </div>
                </div>
              </div>
              <div id="advanced-table">
                <div class="table-responsive">
                  <table class="table table-vcenter table-selectable table-striped table-hover table-bordered mb-0">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Note</th>
                        <th>Status</th>
                        <th>Service Attendance</th>
                        <th>Edit</th>
                      </tr>
                    </thead>

                    <tbody class="table-tbody">
                      {% for report in page_obj %}
                        <tr data-report-id="{{ report.id }}">
                          <td><strong>{{ report.report_date }}</strong></td>
                          <td class="note-cell text-secondary">{{ report.note }}</td>
                          <td>
                            <span class="badge
                              {% if report.guest.status == 'planted' %}bg-success-lt
                              {% elif report.guest.status == 'planted_elsewhere' %}bg-danger-lt
                              {% elif report.guest.status == 'relocated' %}bg-primary-lt
                              {% elif report.guest.status == 'work_in_progress' %}bg-warning-lt
                              {% else %}bg-grey-lt{% endif %}">
                              {{ report.guest.get_status_display }}
                            </span>
                          </td>
                          <td>
                            <div class="badges-list">
                              {% if report.service_sunday %}<span class="badge bg-indigo-lt">Sunday</span>{% endif %}
                              {% if report.service_midweek %}<span class="badge bg-purple-lt">Midweek</span>{% endif %}
                              {% if report.service_others %}<span class="badge bg-pink-lt">Others</span>{% endif %}
                            </div>
                          </td>
                          <td>
                            <form method="get" action="{% url 'followup_report_page' guest.id %}">
                              <input type="hidden" name="edit_report_id" value="{{ report.id }}">
                              <button type="submit" class="btn btn-sm bg-gray text-warning">
                                <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-edit">
                                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                  <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />
                                  <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />
                                  <path d="M16 5l3 3" />
                                </svg>
                              </button>
                            </form>
                          </td>
                        </tr>  
                      {% endfor %}
                    </tbody>
                  </table>
                  <!-- Paginator -->
                  <div class="card-footer d-flex align-items-center">
                    {% if not page_obj.object_list %}
                      <div class="flex-grow-1 text-center text-muted">
                        No Follow-up Reports Yet!
                      </div>
                    {% endif %}
                    <ul class="pagination bg-grey m-0">
                      {% if page_obj.has_previous %}
                        <li class="page-item">
                          <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                              <path d="M15 6l-6 6l6 6"></path>
                            </svg>
                          </a>
                        </li>
                      {% endif %}
                      {% for num in page_obj.paginator.page_range %}
                        {% if num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
                          <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                          </li>
                        {% endif %}
                      {% endfor %}
                      {% if page_obj.has_next %}
                        <li class="page-item">
                          <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                              <path d="M9 6l6 6l-6 6"></path>
                            </svg>
                          </a>
                        </li>
                      {% endif %}
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
     
        <!-- Follow-Up Form Section -->
        <div class="col-md-12 col-lg-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                {% if report_to_edit %}Edit Report{% else %}New Report{% endif %}
              </h3>
            </div>
            <div class="card-body">
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="submit_report" value="1" />
                <div class="space-y">
                  <div class="row g-4">
                    <!-- Date Field (Read-only if editing) -->
                    <div class="col-12 mb-3">
                      {{ form.report_date.label_tag }}
                      {{ form.report_date }}
                    </div>

                    <!-- Service checkboxes in a new row -->
                    <div class="col-12">
                      <div class="row mb-3">
                        <div class="col-md-4">
                          <label class="form-check">
                            {{ form.service_sunday }}
                            <span class="form-check-label">Sunday Service</span>
                          </label>
                        </div>
                        <div class="col-md-4">
                          <label class="form-check">
                            {{ form.service_midweek }}
                            <span class="form-check-label">Midweek Recharge</span>
                          </label>
                        </div>
                        <div class="col-md-4">
                          <label class="form-check">
                            {{ form.service_others }}
                            <span class="form-check-label">Others</span>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Note -->
                  <div class="mb-3">
                    {{ form.note.label_tag }}
                    {{ form.note }}
                  </div>

                  <div>
                    {% if request.user.is_superuser or guest.assigned_to == request.user or guest.full_name == "Wunmi Jordan" %}
                      <button type="submit" class="btn btn-success btn-4 w-100">
                        {% if report_to_edit %}
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="icon icon-tabler icon-tabler-file-isr" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M15 3v4a1 1 0 0 0 1 1h4" />
                            <path d="M6 8v-3a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-7" />
                            <path d="M3 15l3 -3l3 3" />
                          </svg>
                          Update Report
                        {% else %}
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="icon icon-tabler icon-tabler-file-isr" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M15 3v4a1 1 0 0 0 1 1h4" />
                            <path d="M6 8v-3a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-7" />
                            <path d="M3 15l3 -3l3 3" />
                          </svg>
                          Submit Report
                        {% endif %}
                      </button>
                    {% endif %}
                  </div>
                  {% if error %}
                    <div class="alert alert-danger mt-2">{{ error }}</div>
                  {% endif %}
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}






