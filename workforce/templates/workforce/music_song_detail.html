{% extends "base.html" %}
{% block title %}{{ song.title }} â€” Embassage{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="text-white">{{ song.title }}</h2>
  <div>
    <a href="{% url 'workforce:upload_track' song.id %}" class="btn btn-outline-primary btn-sm">Upload Track</a>
    <a href="{% url 'workforce:upload_chart' song.id %}" class="btn btn-outline-secondary btn-sm">Upload Chart</a>
  </div>
</div>

<div class="row">
  <div class="col-md-7">
    <div class="card bg-dark text-white p-3">
      <h5>Practice Player</h5>

      <!-- WAVEFORM -->
      <div id="waveform" class="waveform mt-3"></div>
      <div id="waveform-timeline"></div>

      <div class="d-flex gap-2 mt-3">
        <button id="wsPlayPause" class="btn btn-primary btn-sm">Play</button>
        <button id="wsStop" class="btn btn-secondary btn-sm">Stop</button>
        <select id="wsSpeed" class="form-select form-select-sm" style="width:100px;">
          <option value="0.5">0.5x</option>
          <option value="0.75">0.75x</option>
          <option value="1" selected>1x</option>
          <option value="1.25">1.25x</option>
          <option value="1.5">1.5x</option>
        </select>
      </div>

      <hr class="border-secondary">

      <!-- PLAYLIST (sortable) -->
      <div id="sortablePlaylist" class="list-group">
        {% for t in tracks %}
          <div class="list-group-item d-flex justify-content-between align-items-center bg-surface text-white"
               data-trackid="{{ t.id }}"
               data-src="{{ t.file }}">
            <div>
              <strong>{{ t.title|default:t.file_name }}</strong>
              <div class="small text-muted">{{ t.file_type }}</div>
            </div>
            <button class="btn btn-sm btn-primary ws-load">Load</button>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="card bg-dark text-white p-3 mt-4">
      <h5>Practice Mix (Stems)</h5>

      {% for t in tracks %}
        {% if t.track_type == "stem" %}
          <div class="d-flex align-items-center gap-3 my-2">
            <strong style="width:120px;">{{ t.title|default:t.file_name }}</strong>

            <input type="range" min="0" max="1" step="0.01"
                  value="0.8" class="form-range stem-slider"
                  data-src="{{ t.file }}">
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <div class="col-md-5">
    <div class="card bg-dark text-white p-3">
      <h5>Charts</h5>

      {% for c in charts %}
        <div class="mb-3">
          <strong>{{ c.title|default:c.file_name }}</strong>

          {% if c.file_type == "application/pdf" or ".pdf" in c.file_name|lower %}
            <iframe src="{{ c.file }}" class="w-100" style="height:300px;"></iframe>
          {% else %}
            <a href="{{ c.file }}" class="text-white" target="_blank">
              Download {{ c.file_name }}
            </a>
          {% endif %}

          <div class="small text-muted">{{ c.created_at }}</div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/wavesurfer.js"></script>
<script src="https://unpkg.com/wavesurfer.js/dist/plugins/timeline.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  // ---- WAVESURFER ----
  const ws = WaveSurfer.create({
    container: '#waveform',
    waveColor: '#999',
    progressColor: '#4CAF50',
    height: 120,
  });

  const timeline = WaveSurfer.Timeline.create({
    container: "#waveform-timeline"
  });

  ws.registerPlugin(timeline);

  document.querySelectorAll(".ws-load").forEach(btn => {
    btn.addEventListener("click", function () {
      const div = btn.closest(".list-group-item");
      const src = div.dataset.src;
      ws.load(src);
    });
  });

  document.getElementById("wsPlayPause").onclick = () => ws.playPause();
  document.getElementById("wsStop").onclick = () => ws.stop();
  document.getElementById("wsSpeed").onchange = e => {
    ws.setPlaybackRate(parseFloat(e.target.value));
  };


  // ---- SORTABLE REORDER ----
  new Sortable(sortablePlaylist, {
    animation: 150,
    onEnd: function () {
      const order = [];
      document.querySelectorAll("#sortablePlaylist .list-group-item").forEach(i => {
        order.push(i.dataset.trackid);
      });

      fetch("{% url 'workforce:music_reorder_tracks' song.id %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ "order[]": order })
      });
    }
  });

  // ---- STEM MIX PLAYER ----
  const stems = [];

  document.querySelectorAll(".stem-slider").forEach(slider => {
    const audio = new Audio(slider.dataset.src);
    audio.loop = true;
    audio.volume = slider.value;
    audio.play();
    stems.push({ slider, audio });

    slider.addEventListener("input", () => {
      audio.volume = slider.value;
    });
  });

});
</script>
{% endblock %}

