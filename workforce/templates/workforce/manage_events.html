{% extends 'base.html' %}
{% load widget_tweaks %}
{% load access_tags %}

{% block content %}

<div class="page-wrapper">
  <!-- BEGIN PAGE HEADER -->
  <div class="page-header d-print-none" aria-label="Page header">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <!-- Dynamic Page Title -->
          <kbd class="bg-success-lt"><h2 class="page-title">{{ page_title }}</h2></kbd>
        </div>

        <!-- Page title actions -->
        <div class="col-auto ms-auto d-print-none">
          <div class="btn-list">
            <div>
              <!-- Single Button for Regular Users -->
              <a href="#" class="btn btn-gray d-none d-sm-inline-block" aria-label="Add programme" data-bs-toggle="modal" data-bs-target="#eventModal" id="addEventBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-calendar-plus">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12.5 21h-6.5a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v5" />
                  <path d="M16 3v4" /><path d="M8 3v4" /><path d="M4 11h16" /><path d="M16 19h6" /><path d="M19 16v6" />
                </svg>
                Add Programme
              </a>

              <!-- Mobile Button -->
              <a href="#" class="btn btn-gray d-sm-none btn-icon" aria-label="Add programme" data-bs-toggle="modal" data-bs-target="#eventModal" id="addEventBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-calendar-plus">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12.5 21h-6.5a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v5" />
                  <path d="M16 3v4" /><path d="M8 3v4" /><path d="M4 11h16" /><path d="M16 19h6" /><path d="M19 16v6" />
                </svg>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>   
  </div>
  <!-- END PAGE HEADER -->
  <div class="page-body">
    <div class="container-xl">

      <div class="card bg-dark text-light shadow-sm p-4 rounded-3">
        <!-- Events List -->

        <h4 class="mb-3">Active Events</h4>
        <ul id="eventList" class="list-group bg-gray" style="max-height: 60vh; overflow-y: auto;">
          {% for event in events %}
            {% include "workforce/partials/event_item.html" %}
          {% empty %}
            <li class="list-group-item bg-gray text-white text-center">No events yet.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-light border-0 rounded-3 shadow-lg">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="modalTitle">Add Event</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="eventForm" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row g-3">
            {% for field in form %}
              {% if field.name != "postponed" %}
                {% if field.field.widget.input_type == "checkbox" %}
                  <div class="col-md-6 form-check mt-4 ms-2">
                    {% render_field field class="form-check-input" %}
                    <label class="form-check-label text-pink ms-2" for="{{ field.id_for_label }}">
                      {{ field.label }}
                    </label>
                  </div>
                {% elif field.name == "team" %}
                  <div class="col-md-6">
                    <label class="form-label text-green">{{ field.label }}</label>
                    {% render_field field class="form-select bg-gray border-0 {{ membership.team.color_class }}" %}
                  </div>
                {% elif field.name == "event_image" %}
                  <div class="col-md-6">
                    <label class="form-label text-purple">{{ field.label }}</label>
                    {% render_field field class="form-control bg-gray text-purple border-0" %}
                    <small class="text-muted">Upload a banner or poster for this event (optional)</small>
                  </div>
                  <div class="col-md-6" id="imagePreview"></div>
                {% elif field.name == "registration_link" %}
                  <div class="col-md-12" id="registrationLinkWrapper" style="display: none;">
                    <label class="form-label text-teal">{{ field.label }}</label>
                    {% render_field field class="form-control bg-gray text-teal border-0" %}
                    <small class="text-muted">Enter a registration link (only used if ‚ÄúRegistrable‚Äù is checked)</small>
                  </div>
                {% else %}
                  <div class="col-md-6">
                    <label class="form-label text-warning">{{ field.label }}</label>
                    {% render_field field class="form-control bg-gray text-secondary border-0" %}
                  </div>
                {% endif %}
              {% endif %}
            {% endfor %}
            <div class="col-md-6 form-check mt-4 ms-2" id="postponeWrapper" style="display: none;">
              {% render_field form.postponed class="form-check-input" %}
              <label class="form-check-label text-pink ms-2" for="{{ form.postponed.id_for_label }}">
                {{ form.postponed.label }}
              </label>
            </div>
          </div>
        </div>

        <div class="modal-footer border-0">
          <button type="button" class="btn" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-green">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
  <div id="toast" class="toast align-items-center text-white bg-dark border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">Action completed.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // --- DOM Elements ---
  const modalEl = document.getElementById("eventModal");
  const modal = new bootstrap.Modal(modalEl);
  const form = document.getElementById("eventForm");
  const eventList = document.getElementById("eventList");
  const addBtn = document.getElementById("addEventBtn");
  const toastEl = document.getElementById("toast");
  const toastMessage = document.getElementById("toastMessage");
  const toast = new bootstrap.Toast(toastEl);

  const dateField = form.querySelector("[name='date']");
  const endDateField = form.querySelector("[name='end_date']");
  const timeField = form.querySelector("[name='time']");
  const dayOfWeekField = form.querySelector("[name='day_of_week']");
  const recurringCheckbox = form.querySelector("[name='is_recurring_weekly']");
  const registrableCheckbox = form.querySelector("[name='registrable']");
  const registrationLinkWrapper = document.getElementById("registrationLinkWrapper");
  const registrationLinkField = form.querySelector("[name='registration_link']");
  const durationField = form.querySelector("[name='duration_days']");

  const postponeWrapper = document.getElementById("postponeWrapper");
  const postponedCheckbox = form.querySelector("[name='postponed']");
  const imagePreview = document.getElementById("imagePreview");

  let editMode = false;
  let editId = null;

  // --- Helpers ---
  function showToast(message) {
    toastMessage.textContent = message;
    toast.show();
  }

  function togglePostponeVisibility(isEdit) {
    if (!postponeWrapper || !postponedCheckbox) return;
    if (isEdit) {
      postponeWrapper.style.display = "block";
    } else {
      postponeWrapper.style.display = "none";
      postponedCheckbox.checked = false;
    }
  }

  // Clear fields ONLY when user actively toggles the checkbox (not when populating modal)
  function clearFieldsForPostpone() {
    if (dateField) dateField.value = "";
    if (endDateField) endDateField.value = "";
    if (timeField) timeField.value = "";
    // Keep fields enabled for optional reselection
    if (dateField) dateField.removeAttribute("disabled");
    if (endDateField) endDateField.removeAttribute("disabled");
    if (timeField) timeField.removeAttribute("disabled");
  }

  function toggleRecurringFields() {
    if (!recurringCheckbox || !dayOfWeekField || !dateField || !endDateField) return;

    if (recurringCheckbox.checked) {
      dayOfWeekField.removeAttribute("disabled");
      dateField.setAttribute("disabled", "disabled");
      endDateField.setAttribute("disabled", "disabled");
    } else {
      dayOfWeekField.setAttribute("disabled", "disabled");
      dateField.removeAttribute("disabled");
      endDateField.removeAttribute("disabled");
    }
  }

  function toggleRegistrationLink() {
    if (!registrableCheckbox || !registrationLinkWrapper || !registrationLinkField) return;
    if (registrableCheckbox.checked) {
      registrationLinkWrapper.style.display = "block";
    } else {
      registrationLinkWrapper.style.display = "none";
      registrationLinkField.value = "";
    }
  }

  function toggleEndDateVisibility() {
    if (!durationField || !endDateField) return;
    const days = parseInt(durationField.value) || 1;
    if (days > 1) {
      endDateField.parentElement.style.display = "block";
    } else {
      endDateField.parentElement.style.display = "none";
      endDateField.value = "";
    }
  }

  function resetModal() {
    editMode = false;
    editId = null;
    document.getElementById("modalTitle").textContent = "Add Event";
    form.reset();
    togglePostponeVisibility(false);
    if (imagePreview) imagePreview.innerHTML = "";
    toggleRecurringFields();
    toggleRegistrationLink();
    toggleEndDateVisibility();
  }

  function populateEditModal(btn) {
    editMode = true;
    editId = btn.dataset.id;
    document.getElementById("modalTitle").textContent = "Edit Event";

    // Fields to populate
    const fieldsToPopulate = [
      "name", "event_type", "attendance_mode", "date", "end_date",
      "time", "duration_days", "team", "is_active", "is_recurring_weekly",
      "day_of_week", "registrable", "registration_link", "postponed"
    ];

    fieldsToPopulate.forEach(name => {
      const field = form.querySelector(`[name='${name}']`);
      if (!field) return;
      const value = btn.dataset[name];

      // IMPORTANT: when populating we set the checkbox state but DO NOT clear fields here
      if (field.type === "checkbox") {
        field.checked = (value === "true");
      } else {
        // Use empty string if no value (keeps previously saved date/time if provided)
        field.value = value || "";
      }
    });

    // --- Team field separately ---
    const teamField = form.querySelector("[name='team']");
    if (teamField) {
      const teamId = btn.dataset.team_id; // <- use data-team_id
      if (teamId) teamField.value = teamId;
      else teamField.value = ""; // no team
    }

    // Recurring & postpone visibility ‚Äî but don't clear date/time here
    toggleRecurringFields();
    togglePostponeVisibility(true);

    // Image preview
    if (imagePreview) {
      const imageUrl = btn.dataset.image;
      imagePreview.innerHTML = imageUrl
        ? `<img src="${imageUrl}" alt="Event Image" class="rounded-3 mt-2 border border-secondary" style="width: 150px; height: auto; object-fit: cover;" />`
        : "";
    }

    // Registration link visibility
    toggleRegistrationLink();

    // End date visibility
    toggleEndDateVisibility();
  }

  // --- Event Listeners ---

  // Add event button
  if (addBtn) addBtn.addEventListener("click", resetModal);

  // Recurring toggle
  if (recurringCheckbox) {
    recurringCheckbox.addEventListener("change", toggleRecurringFields);
    toggleRecurringFields();
  }

  // Registrable toggle
  if (registrableCheckbox) {
    registrableCheckbox.addEventListener("change", toggleRegistrationLink);
    toggleRegistrationLink();
  }

  // Postponed checkbox: clear fields only when user toggles it (user action)
  if (postponedCheckbox) {
    postponedCheckbox.addEventListener("change", (e) => {
      if (e.target.checked) {
        clearFieldsForPostpone();
      }
      // If user unchecks, do nothing (you said no second toggling flow needed)
    });
  }

  // Duration toggle (for end date visibility)
  if (durationField) {
    durationField.addEventListener("input", toggleEndDateVisibility);
    toggleEndDateVisibility();
  }

  // Edit / Delete buttons (delegated)
  if (eventList) {
    eventList.addEventListener("click", async (e) => {
      const editBtn = e.target.closest(".edit-btn");
      const deleteBtn = e.target.closest(".delete-btn");

      // Edit
      if (editBtn) {
        populateEditModal(editBtn);
        modal.show();
        return;
      }

      // Delete
      if (deleteBtn) {
        e.preventDefault();
        if (!confirm("Delete this event?")) return;

        try {
          const res = await fetch(`/delete-event/${deleteBtn.dataset.id}/`, {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
          });

          if (res.ok) {
            deleteBtn.closest("li").remove();
            showToast("üóëÔ∏è Event deleted successfully");
          }
        } catch (err) {
          console.error(err);
          showToast("‚ö†Ô∏è Failed to delete event");
        }
      }
    });
  }

  // Form submit (Add/Edit)
  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      // Preserve existing image if editing and no new file selected
      const fileInput = form.querySelector("[name='event_image']");
      const existingImage = document.querySelector(`.edit-btn[data-id='${editId}']`)?.dataset.image;
      if (editMode && fileInput && !fileInput.files.length && existingImage) {
        formData.append("existing_image", existingImage);
      }

      const url = editMode ? `/edit-event/${editId}/` : `{% url 'workforce:manage_events' %}`;

      try {
        const res = await fetch(url, { method: "POST", body: formData });
        const data = await res.json();

        if (res.ok && data.html) {
          if (editMode) {
            document.querySelector(`li[data-id='${editId}']`).outerHTML = data.html;
            showToast("‚úèÔ∏è Event updated successfully");
          } else {
            eventList.insertAdjacentHTML("beforeend", data.html);
            showToast("‚úÖ Event added successfully");
          }

          modal.hide();
          resetModal();
        } else {
          console.error(data.errors);
          showToast("‚ö†Ô∏è Error saving event");
        }
      } catch (err) {
        console.error("Unexpected error:", err);
        showToast("‚ö†Ô∏è Unexpected error occurred");
      }
    });
  }
});
</script>


{% endblock %}
