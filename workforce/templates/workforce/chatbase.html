{% load static %}
{% load user_avatar_tags %}
{% load guest_avatar_tags %}
{% load widget_tweaks %}
{% load access_tags %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}GForce{% endblock %}</title>

  <!-- PWA manifest and theme color -->
  <link rel="manifest" href="{% static 'manifest.json' %}">
  <meta name="theme-color" content="#2e303e">

  <!-- Apple support -->
  <link rel="apple-touch-icon" href="{% static 'images/icons/icon-192x192.png' %}">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <link rel="icon" type="image/png" sizes="192x192" href="{% static 'images/icons/icon-192x192.png' %}">
  <link rel="icon" type="image/png" sizes="512x512" href="{% static 'images/icons/icon-512x512.png' %}">
  <link rel="icon" type="image/png" sizes="512x512" href="{% static 'images/icons/icon-512x512-maskable.png' %}">

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <!--<link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/css/tabler.min.css" rel="stylesheet" />-->
  <link href="{% static 'vendor/tabler/tabler.min.css' %}" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/@tabler/icons-webfont/tabler-icons.min.css">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet">
  <link href="{% static 'css/custom.css' %}" rel="stylesheet" />

  <script src="{% static 'js/tabler-theme-dark.js' %}"></script>

  {% block extra_css %}{% endblock %}

</head>
<body class="min-vh-100" data-new-gr-c-s-check-loaded="14.1249.0" data-gr-ext-installed="">

  


  <!-- Page Content -->
  <main>
    {% block content %}{% endblock %}
  </main>


  <!-- Android PWA Install Modal -->
  <div id="installModal" class="pwa-modal d-none">
    <div class="pwa-modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <span class="fst-italic me-1">Install</span> <strong style="color: #ff5e01ff;"> GForceApp</strong>
        </h5>
        <button class="btn-animate-icon btn-animate-icon-rotate closeModal">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-x">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M18 6l-12 12" /><path d="M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div style="display:flex; align-items:center; gap:12px;">
          <img src="/static/images/icons/icon-192x192.png"
              style="width:60px; height:60px; border-radius:10px;">
          <div class="text-secondary">
            Get the full experience on your device.
          </div>
          <button id="installBtn" class="btn btn-gray btn-animate-icon btn-animate-icon-move-down" 
                  style="border: none; box-shadow: 0 4px 8px #000000ee;
                          width: 150px; border-radius: 12px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#806885ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-download">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
              <path d="M7 11l5 5l5 -5" /><path d="M12 4l0 12" />
            </svg>
            Install
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- iOS Install Modal -->
  <div id="iosInstallModal" class="pwa-modal d-none">
    <div class="pwa-modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <span class="fst-italic">Install</span> <strong style="color: #ff5e01ff;"> GForceApp</strong>
        </h5>
        <button id="closeIosModal" class="btn-animate-icon btn-animate-icon-rotate closeModal">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-x">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M18 6l-12 12" /><path d="M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div style="display:flex; align-items:center; gap:12px;">
          <img src="/static/images/icons/icon-192x192.png"
              style="width:60px; height:60px; border-radius:10px;">
          <div style="flex:1; line-height:1.35;">
            <span class="text-muted mb-2">Get the full experience on your device.</span><br>
            Tap 
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#806885ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-share-2">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 9h-1a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-8a2 2 0 0 0 -2 -2h-1" />
              <path d="M12 14v-11" /><path d="M9 6l3 -3l3 3" />
            </svg><br>
            then, <strong>"Add to Home Screen"</strong>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
  /* Modal overlay */
  .pwa-modal {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.4);
    box-shadow: 0 6px 18px #000000ee;
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:9999;
    opacity:0;
    visibility:hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  /* Show modal */
  .pwa-modal.show {
    opacity:1;
    visibility:visible;
  }

  /* Modal content */
  .pwa-modal-content {
    background:#111827;
    color:white;
    border-radius:18px;
    padding:18px 24px;
    box-shadow:0 6px 18px #000000ee;
    width:90%;
    max-width:380px;
    position:relative;
    backdrop-filter:blur(6px);
    transform: translateY(-20px);
    transition: transform 0.3s ease;
  }

  /* Animate modal content on show */
  .pwa-modal.show .pwa-modal-content {
    transform: translateY(0);
  }

  /* Center modal header title */
  .pwa-modal .modal-header {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative; /* needed for absolute close button */
    padding-right: 45px; /* space so title stays centered */
  }

  /* Position close button to far right */
  .pwa-modal .modal-header .closeModal {
    position: absolute;
    background:none;
    border:none;
    color: #ff0101ff;
    font-size:20px;
    cursor:pointer;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
  }
  </style>

  <script>
  let deferredPrompt;
  const installModal = document.getElementById('installModal');
  const installBtn = document.getElementById('installBtn');
  const iosModal = document.getElementById('iosInstallModal');
  const closeBtns = document.querySelectorAll('.closeModal');

  // SHOW modal
  function showModal(modal) {
    modal.classList.remove('d-none');   // FIX
    requestAnimationFrame(() => {
      modal.classList.add('show');
    });
  }

  // HIDE modal
  function hideModal(modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      modal.classList.add('d-none');    // hide after fade-out
    }, 300);
  }

  // ANDROID PWA
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();         // block native banner
    deferredPrompt = e;         // store event
    showModal(installModal);    // show custom modal
  });

  // User clicks install
  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    hideModal(installModal);

    deferredPrompt.prompt();                          // <-- REQUIRED USER ACTION
    const choice = await deferredPrompt.userChoice;
    console.log('User choice:', choice.outcome);

    deferredPrompt = null;
  });

  // Close buttons
  closeBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
      const modal = e.target.closest('.pwa-modal');
      hideModal(modal);
      if (modal === iosModal) {
        localStorage.setItem('iosInstallDismissed', 'true');
      }
    });
  });

  // iOS Install
  document.addEventListener("DOMContentLoaded", () => {
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isStandalone = window.navigator.standalone === true;

    if (isIOS && !isStandalone && !localStorage.getItem('iosInstallDismissed')) {
      setTimeout(() => showModal(iosModal), 800);
    }
  });
  </script>

  <!-- Notification Settings Modal -->
  <div class="modal fade" id="notifSettingsModal" tabindex="-1" aria-labelledby="notifSettingsLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-3 shadow">
        <div class="modal-header">
          <h5 class="modal-title" id="notifSettingsLabel">Notification Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form id="settingsForm" method="post">
          <div class="modal-body">
            {% csrf_token %}

            <!-- Notification Sound Selector -->
            <div class="mb-3">
              <label class="form-label">Notification Sound</label>
              <div class="list-group">
                {% for value,label in sound_choices %}
                <label class="list-group-item d-flex align-items-center">
                  <input type="radio"
                        name="notification_sound"
                        value="{{ value }}"
                        {% if settings and settings.notification_sound == value %}checked{% endif %}
                        class="me-2">
                  <span class="flex-grow-1">{{ label }}</span>
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm preview-btn"
                          data-sound="{{ value }}">
                    ▶
                  </button>
                </label>
                {% endfor %}
              </div>
            </div>

            <!-- Vibration Toggle -->
            <div class="form-check mb-3">
              <input type="checkbox"
                    name="vibration_enabled"
                    id="vibration_enabled"
                    {% if settings and settings.vibration_enabled %}checked{% endif %}
                    class="form-check-input">
              <label for="vibration_enabled" class="form-check-label">Enable Vibration</label>
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>

        <!-- Hidden audio elements -->
        <audio id="notifSound" preload="auto"></audio>
        <audio id="previewSound" preload="auto"></audio>
      </div>
    </div>
  </div>

  <!-- JS: Map sound keys → static URLs & URLs -->
  <script>
    window.APP_CONFIG = {
      urls: {
        topServicesData: "{% url 'top_services_data' %}",
        channelBreakdown: "{% url 'channel_breakdown' %}",
        updateSettings: "{% url 'notifications:update_user_settings' %}",
        markAllRead: "{% url 'notifications:mark_all_read' %}"
      },
      csrfToken: "{{ csrf_token }}",
      user: {
        id: {{ request.user.id|default:'null' }},
        isAuthenticated: {{ request.user.is_authenticated|yesno:'true,false' }},
      },
      sound: {
        userSound: "{{ settings.notification_sound|default:'chime1' }}",
        vibrationEnabled: {{ settings.vibration_enabled|yesno:'true,false' }},
        soundMap: {
          {% for value,label in sound_choices %}
          "{{ value }}": "{% static 'sounds/' %}{{ value }}.mp3"{% if not forloop.last %},{% endif %}
          {% endfor %}
        }
      }
    };
  </script>

  

  <!-- ========================= -->
  <!-- JS LIBRARIES -->
  <!-- ========================= -->
  <script src="https://unpkg.com/htmx.org@1.9.3"></script>
  <!-- FullCalendar (global builds) -->
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/bootstrap5@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const navbar = document.querySelector(".navbar");
      window.addEventListener("scroll", function () {
        if (window.scrollY > 50) {
          navbar.classList.add("scrolled");
        } else {
          navbar.classList.remove("scrolled");
        }
      });
    });
  </script>

  <!-- ========================= -->
  <!-- CUSTOM SCRIPTS -->
  <!-- ========================= -->
  <!-- Inject VAPID public key into global JS scope -->
  <script>
    window.VAPID_PUBLIC_KEY = "{{ VAPID_PUBLIC_KEY|escapejs }}";
    console.log("Injected VAPID key:", window.VAPID_PUBLIC_KEY, "Length:", window.VAPID_PUBLIC_KEY.length);
  </script>

  <script src="{% static 'js/custom.js' %}"></script>  
  
  {% block extra_js %}{% endblock %}

</body>
</html>