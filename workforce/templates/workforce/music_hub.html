{% extends "base.html" %}
{% load static %}
{% load access_tags %}
{% load humanize %}
{% block title %}Embassage Music Hub{% endblock %}

{% block content %}
<div class="page-wrapper">
  <!-- BEGIN PAGE HEADER -->
  <div class="page-header d-print-none" aria-label="Page header">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        
        <div class="col">
          <!-- Dynamic Page Title -->
          <kbd class="bg-warning-lt"><h2 class="page-title">{{ page_title }}</h2></kbd>
        </div>

        <!-- Page title actions -->
        <div class="col-auto ms-auto d-print-none">
          <div class="btn-list">
            <!-- Single Button for Song Creation -->
            <a href="#" id="searchSongBtn" class="btn btn-gray d-none d-sm-inline-block">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-music-search">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 17a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
                <path d="M9 17v-13h10v7" /><path d="M9 8h10" /><path d="M18 18m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                <path d="M20.2 20.2l1.8 1.8" />
              </svg>
              Search Song
            </a>

            <!-- Mobile Button -->
            <a href="#" id="searchSongBtn" class="btn btn-gray d-sm-none btn-icon" aria-label="Search Song">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-music-search">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 17a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
                <path d="M9 17v-13h10v7" /><path d="M9 8h10" /><path d="M18 18m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                <path d="M20.2 20.2l1.8 1.8" />
              </svg>
            </a>

            <!-- Single Button for Song Creation -->
            <a href="{% url 'workforce:music_create_song' %}" class="btn btn-gray d-none d-sm-inline-block">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-music-plus">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 17a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
                <path d="M9 17v-13h10v8" /><path d="M9 8h10" /><path d="M16 19h6" /><path d="M19 16v6" />
              </svg>
              Add New Song
            </a>

            <!-- Mobile Button -->
            <a href="{% url 'workforce:music_create_song' %}" class="btn btn-gray d-sm-none btn-icon" aria-label="Add Song">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-music-plus">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 17a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
                <path d="M9 17v-13h10v8" /><path d="M9 8h10" /><path d="M16 19h6" /><path d="M19 16v6" />
              </svg>
            </a>
            
            <!-- Single Button for Rehearsal -->
            <a href="{% url 'workforce:rehearsal_create' %}" class="btn btn-gray d-none d-sm-inline-block">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-calendar-plus">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12.5 21h-6.5a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v5" />
                <path d="M16 3v4" /><path d="M8 3v4" /><path d="M4 11h16" /><path d="M16 19h6" /><path d="M19 16v6" />
              </svg>
              Create Rehearsal
            </a>

            <!-- Mobile Button -->
            <a href="{% url 'workforce:rehearsal_create' %}" class="btn btn-gray d-sm-none btn-icon" aria-label="Create Rehearsal">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-calendar-plus">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12.5 21h-6.5a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v5" />
                <path d="M16 3v4" /><path d="M8 3v4" /><path d="M4 11h16" /><path d="M16 19h6" /><path d="M19 16v6" />
              </svg>
            </a>
            
          </div>
        </div>
      
      </div>
    </div>
  </div>

  <div class="page-body">
    <div class="container-xl">
      <div class="row row-deck row-cards">

        <div class="col-md-6 col-lg-4 p-4">
          <div class="row gy-3">
            <div class="col-12 col-sm d-flex flex-column">
              <div style="--user-color: {{ user.color }};">
                <span class="typing-text">Welcome back,</span>
              </div>
              <span style="font-size: 3rem; font-weight: bold; line-height: 1.1;">
                <small style="font-size: 1.5rem; font-style: italic;">{{ request.user.title|default:"" }}</small><br> {{ request.user.full_name }}
              </span>
              <!--<div class="d-flex flex-wrap gap-2 mt-4 mb-2 justify-content-start">
                {% if not request.user|is_project_admin %}
                  {% with memberships=user.team_memberships.all %}
                    {% if memberships %}
                      {% for membership in memberships %}
                        {% if membership.team.is_active %}
                          <span class="px-2 m-0 border-0 {{ membership.team.color_class }}"
                                style="
                                  font-size: 0.8rem;
                                  font-weight: semibold;
                                  font-style: italic;
                                  border-radius: 12px;
                                  background: #1F2937;
                                  box-shadow: 0 4px 8px #000000d2;
                                ">
                            {{ membership.team.name }}
                          </span>
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endwith %}
                {% endif %}
              </div>-->
              <div class="row g-2 justify-content-center">
                {% comment %} ─────────────── SUPERUSER + PROJECT ADMINS SEE EVERYONE ─────────────── {% endcomment %}
                {% if request.user.is_superuser or request.user|is_project_admin %}
                  <div class="w-full mx-auto relative mb-4">
                    <div class="scroll-wrapper">
                      <ul class="scroll-track" data-direction="left">
                        {% for user in other_users %}
                          {% if user != request.user %}
                            {% include "partials/_user_card.html" with user=user %}
                          {% endif %}
                        {% endfor %}
                      </ul>
                    </div>
                  </div>

                {% else %}
                  {% with memberships=request.user.team_memberships.all %}
                    {% if user_teams|length == 1 %}
                      {# ───────────── SINGLE TEAM USER ───────────── #}
                      <div class="w-full mx-auto relative mb-4">
                        <!-- Team name overlay -->
                        <span class="team-name-overlay {{ team.color_class }}" style="background: #1F2937;">{{ team.name }}</span>
                        <div class="scroll-wrapper">
                          <ul class="scroll-track" data-direction="left">
                            {% for member in other_users %}
                              {% if member != request.user %}
                                {% include "partials/_user_card.html" with user=member %}
                              {% endif %}
                            {% endfor %}
                          </ul>
                        </div>
                      </div>

                    {% elif user_teams|length > 1 %}
                      {# ───────────── MULTIPLE TEAMS ───────────── #}
                      {% for team, members in team_member_pairs %}
                        <div class="w-full mx-auto relative scroll-container">
                          <!-- Team name overlay -->
                          <span class="team-name-overlay {{ team.color_class }}" style="background: #1F2937;">{{ team.name }}</span>

                          <div class="scroll-wrapper">
                            <ul class="scroll-track" data-direction="{% cycle 'left' 'right' %}">
                              {% for member in members %}
                                {% include "partials/_user_card.html" with user=member %}
                              {% endfor %}
                            </ul>
                          </div>
                        </div>
                      {% endfor %}

                    {% endif %}
                  {% endwith %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-12 col-lg-8">
          <div class="card border-0 pb-2"
                style="box-shadow: 0 4px 8px #000000d2; border-radius: 24px;
                      max-height: 200px; overflow-y: auto;"> 
            <div class="card-body p-0">
              <div class="row g-4 align-items-center">
                  
                <h5 class="mb-3">Upcoming Rehearsals</h5>
                {% for r in rehearsals %}
                  <div class="mb-2 border rounded p-2">
                    <div class="fw-bold">{{ r.title }}</div>
                    <div class="text-muted small">{{ r.date }} {{ r.start_time|default_if_none:"" }}</div>
                    <div class="small text-secondary">{{ r.location }}</div>
                  </div>
                {% empty %}
                  <div class="text-muted">No rehearsals scheduled.</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row row-cards g-3">
        <h3 class="mb-1">Songs</h3>
        <div id="songList">
          {% for song in songs %}
          <div class="col-6 col-md-4 mb-5">
            <div class="card flex-fill h-100 border-0 pb-2"
                  style="box-shadow: 0 4px 8px #000000d2; border-radius: 24px;">                
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <a href="{{ song.get_absolute_url }}" class="fw-bold text-white">{{ song.title }}</a>
                  <div class="text-muted small">{{ song.subtitle }}</div>
                </div>
                <div>
                  <a href="{{ song.get_absolute_url }}" class="btn btn-sm btn-primary">Open</a>
                </div>
              </div>
            </div>
          </div>
          {% empty %}
            <div class="text-muted">No songs yet — create one.</div>
          {% endfor %}
        </div>
      </div>
          
    </div>
  </div>
</div>

<!-- Search Modal -->
<div id="songSearchModal" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Search Christian/Gospel Songs</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="songSearchQuery" class="form-control mb-3" placeholder="Type song title...">
        <div id="songSearchResults"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const modal = new bootstrap.Modal(document.getElementById("songSearchModal"));
  const queryInput = document.getElementById("songSearchQuery");
  const resultsDiv = document.getElementById("songSearchResults");

  document.getElementById("searchSongBtn").onclick = () => modal.show();

  let timeout = null;
  queryInput.addEventListener("input", function () {
    clearTimeout(timeout);
    const query = queryInput.value.trim();
    if (!query) return resultsDiv.innerHTML = "";
    
    timeout = setTimeout(() => {
      fetch(`/music/search_external_songs?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          resultsDiv.innerHTML = data.results.map(song => `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
              <div>
                <strong>${song.title}</strong> <small class="text-muted">${song.composer || ''}</small>
              </div>
              <button class="btn btn-sm btn-success importSongBtn" data-id="${song.id}">Import</button>
            </div>
          `).join("");

          document.querySelectorAll(".importSongBtn").forEach(btn => {
            btn.onclick = () => {
              const songId = btn.dataset.id;
              fetch(`/music/import_song/`, {
                method: "POST",
                headers: {
                  "X-CSRFToken": "{{ csrf_token }}",
                  "Content-Type": "application/x-www-form-urlencoded",
                },
                body: `external_id=${songId}`
              }).then(() => location.reload());
            }
          });
        });
    }, 300);
  });
});
</script>

{% endblock %}
