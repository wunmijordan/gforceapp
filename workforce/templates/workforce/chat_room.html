{% extends 'workforce/chatbase.html' %}
{% load access_tags %}
{% load static %}
{% load humanize %}
{% block content %}

<div class="page-wrapper chat-wrapper" style="display:flex; flex-direction:column; height:100dvh; overflow:hidden;">

  <header class="navbar-chat scrolled navbar-expand-md d-md-none d-print-none">
    <div class="container-fluid">

      <!-- Mobile chat header -->
      <div class="d-flex w-100 d-md-none align-items-center mb-2 px-1">

        <!-- Left group: back button + toggler -->
        <div class="d-flex align-items-center me-1 gap-2 flex-shrink-0">
          <!-- Back button -->
          <a class="link-secondary p-0 chat-back-btn" style="color:white;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="#ff5e01ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-chevrons-left">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M11 7l-5 5l5 5"/>
              <path d="M17 7l-5 5l5 5"/>
            </svg>
          </a>

          <!-- Navbar toggler -->
          <button class="navbar-toggler p-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu"
                  aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation"
                  style="min-height:40px;">
            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="#02bd12ff"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-users-group">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M10 13a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M8 21v-1a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v1" />
              <path d="M15 5a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M17 10h2a2 2 0 0 1 2 2v1" />
              <path d="M5 5a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M3 13v-1a2 2 0 0 1 2 -2h2" />
            </svg>
            <span id="total-unread-toggler"
                  class="badge-lt text-warning"
                  style="display:none; position:absolute; top:-2px; right:-2px; font-size:0.65rem; min-width:18px; height:18px; display:flex; align-items:center; justify-content:center;">
            </span>
          </button>
        </div>

        <!-- Mobile Search bar container -->
        <div class="flex-grow-1 position-relative">
          <!-- Input -->
          <input type="text"
                class="form-control text-center rounded-4 ms-2 border-0 chat-search"
                placeholder="Search Chat" aria-label="Search"
                style="
                  background: #111827;
                  box-shadow: 0 4px 8px #000000d2;
                  height: 48px;             /* tall enough for icons */
                  padding: 0 20px;       /* space for logo + avatar */
                  width: 200px;
                ">

          

          <!-- Avatar / SVG inside input (right) 
          <span class="position-absolute top-50 end-0 translate-middle-y pe-2 me-2">
            <span class="d-flex align-items-center justify-content-center" style="width:32px; height:32px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                  stroke="rgba(227, 1, 247, 0.81)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-armchair">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M5 11a2 2 0 0 1 2 2v2h10v-2a2 2 0 1 1 4 0v4a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-4a2 2 0 0 1 2 -2z"/>
                <path d="M5 11v-5a3 3 0 0 1 3 -3h8a3 3 0 0 1 3 3v5"/>
                <path d="M6 19v2"/><path d="M18 19v2"/>
              </svg>
            </span>
          </span>-->
        </div>

        <div class="navbar-nav flex-row ms-auto">
          <div class="nav-item dropdown d-flex align-items-center ms-2 me-0">
            <a href="#" class="nav-link px-0" data-bs-toggle="dropdown" aria-label="Show notifications">
              <!-- Tabler bell icon -->
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff5e01ff"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                <path d="M10 5a2 2 0 1 1 4 0a7 7 0 0 1 4 6v3a4 4 0 0 0 2 3h-16a4 4 0 0 0 2 -3v-3a7 7 0 0 1 4 -6"></path>
                <path d="M9 17v1a3 3 0 0 0 6 0v-1"></path>
              </svg>
              {% if unread_count > 0 %}
                <span class="badge-lt text-red position-absolute top-5 start-100 translate-middle"
                      style="font-size: 0.6rem; width: 20px; height:20px; display:flex; align-items:center; justify-content:center;"
                      id="notif-badge">
                  {{ unread_count }}
                </span>
              {% endif %}
            </a>

            <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-end dropdown-menu-card notif-dropdown">
              <div class="card">
                <div class="card-header d-flex">
                  <h3 class="card-title">Notifications</h3>
                  <div class="btn-close ms-auto" data-bs-dismiss="dropdown"></div>
                </div>

                <div class="list-group list-group-flush list-group-hoverable" id="notif-list">
                  {% for notif in unread_notifications %}
                  <div class="list-group-item notif-item" data-id="{{ notif.id }}">
                    <div class="row align-items-center">
                      <div class="col-auto">
                        <span class="status-dot status-dot-animated {% if notif.is_urgent %}bg-red{% elif notif.is_success %}bg-green{% else %}bg-gray{% endif %} d-block"></span>
                      </div>
                      <div class="col">
                        <a href="{{ notif.link }}" class="text-body d-block notif-link text-truncate">{{ notif.title }}</a>
                        <div class="d-block text-secondary mt-n1 notif-description" data-full="{{ notif.description }}">
                          {{ notif.description|truncatechars:150 }}
                          {% if notif.description|length > 150 %}
                            <a href="#" class="show-more">...more</a>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-auto">
                        <a href="#" class="list-group-item-actions notif-star">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="icon text-light icon-2">
                            <path
                              d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z"></path>
                          </svg>
                        </a>
                      </div>
                    </div>
                  </div>
                  {% empty %}
                  <div class="list-group-item">No new notifications</div>
                  {% endfor %}
                </div>

                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <a href="#" class="btn btn-2 w-100 mark-all-read-btn"> Mark All Read </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="nav-item dropdown">
          <a href="#" class="nav-link d-flex lh-1 p-0 px-0 ms-2 text-white" data-bs-toggle="dropdown" aria-label="Open user menu" aria-expanded="false">
            {% if user.image %}
              <img src="{{ user.image.url }}" class="avatar avatar-sm" 
                  style="width: 32px; height: 32px; border-radius: 0.5rem; object-fit: cover;">
            {% else %}
              <span class="avatar avatar-sm bg-grey text-white d-inline-flex align-items-center justify-content-center"
                    style="width: 32px; height: 32px; font-weight: bold; font-size: 16px; border-radius: 0.5rem;">
                {{ user.initials }}
              </span>
            {% endif %}

            <div class="ps-2 d-flex flex-column justify-content-center">
              <!--<div class="d-block d-xl-none">{{ user.get_full_name|default:user.full_name }}</div>--> <!-- Show on mobile -->
              <div class="d-none d-xl-block"><i><small>{{ user.title|default:"" }}</small></i><br> {{ user.full_name }}</div> <!-- Show on xl+ -->

              <div class="d-none d-xl-block mt-1 fs-6 text-secondary">
                {% if user.is_superuser %}
                  <span class="text-warning">Superuser</span>
                {% elif user|has_group:"Pastor" %}
                  <span class="text-green">Pastor</span>
                {% elif user|has_group:"Minister" %}
                  <span class="text-blue">Minister</span>
                {% elif user|has_group:"Admin" %}
                  <span class="text-secondary">Admin</span>
                {% elif user|has_group:"GForce Member" %}
                  <span class="text-pink">GForce Member</span>
                {% else %}
                  <span class="text-red">Demo</span>
                {% endif %}
              </div>
            </div>
          </a>
          <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow py-1">
            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#notifSettingsModal">
              <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-bell-cog">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 17h-8a4 4 0 0 0 2 -3v-3a7 7 0 0 1 4 -6a2 2 0 1 1 4 0a7 7 0 0 1 4 6v.5" />
                <path d="M19.001 19m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M19.001 15.5v1.5" />
                <path d="M19.001 21v1.5" /><path d="M22.032 17.25l-1.299 .75" /><path d="M17.27 20l-1.3 .75" />
                <path d="M15.97 17.25l1.3 .75" /><path d="M20.733 20l1.3 .75" /><path d="M9 17v1a3 3 0 0 0 3 3" />
              </svg>
              Preferences
            </a>
            <a href="https://gatewaynation.org" class="dropdown-item" target="_blank" rel="noreferrer">
              <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-pointer">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M7.904 17.563a1.2 1.2 0 0 0 2.228 .308l2.09 -3.093l4.907 4.907a1.067 1.067 0 0 0 1.509 0l1.047 -1.047a1.067 1.067 0 0 0 0 -1.509l-4.907 -4.907l3.113 -2.09a1.2 1.2 0 0 0 -.309 -2.228l-13.582 -3.904l3.904 13.563z" />
              </svg>
              Gateway Nation
              <span class="badge badge-sm bg-green-lt ms-auto">Home</span>
            </a>
            <div class="dropdown-divider"></div>
            <a href="{% url 'login' %}" class="dropdown-item text-danger">
              <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-logout">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" />
                <path d="M9 12h12l-3 -3" /><path d="M18 15l3 -3" />
              </svg>
              Logout
            </a>
          </div>
        </div>
      </div>

      <!-- Mobile Navbar menu: scrollable -->
      <div class="navbar-collapse collapse" data-bs-auto-close="outside" id="navbar-menu" style="max-height:50vh; overflow-y:auto;">
        <ul class="navbar-nav">
          <!-- Logo inside input (left) -->
        
          <!-- Team Buttons Strip -->
          <li class="nav-item mt-2">
            {% if request.user|is_project_wide_admin %}
              <a class="nav-link text-white" href="{% url 'accounts:admin_dashboard' %}">
                <span class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler.io/icons/icon/home -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0066ffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                    <path d="M5 12l-2 0l9 -9l9 9l-2 0"></path>
                    <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7"></path>
                    <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6"></path>
                  </svg>
                </span>
                <span class="nav-link-title fs-4"> Dashboard </span>
              </a>
            {% else %}
              <a class="nav-link text-white" href="{% url 'dashboard' %}">
                <span class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler.io/icons/icon/home -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0066ffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                    <path d="M5 12l-2 0l9 -9l9 9l-2 0"></path>
                    <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7"></path>
                    <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6"></path>
                  </svg>
                </span>
                <span class="nav-link-title fs-4"> Dashboard </span>
              </a>
            {% endif %}
          </li>
          <li class="nav-item">
            {% if request.user|in_team:"Magnet" %}
              <a class="nav-link text-white" href="{% url 'guest_list' %}">
                <span class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler.io/icons/icon/home -->
                  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="#ff5e01ff"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-users">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" /><path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                    <path d="M16 3.13a4 4 0 0 1 0 7.75" /><path d="M21 21v-2a4 4 0 0 0 -3 -3.85" />
                  </svg>
                </span>
                <span class="nav-link-title"> Guests </span>
              </a>
            {% endif %}
          </li>
          <li class="nav-item">
            <a class="nav-link text-white fs-4" href="#" id="chatroomsToggle">
              <span class="nav-link-icon d-md-none d-lg-inline-block">
                <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="#f703d7ff"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-armchair">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M5 11a2 2 0 0 1 2 2v2h10v-2a2 2 0 1 1 4 0v4a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-4a2 2 0 0 1 2 -2z" />
                  <path d="M5 11v-5a3 3 0 0 1 3 -3h8a3 3 0 0 1 3 3v5" />
                  <path d="M6 19v2" /><path d="M18 19v2" />
                </svg>
              </span>
              <span class="nav-link-title"> My ChatRooms </span>
              <span id="total-unread-chatrooms"
                    class="badge bg-gray-lt text-warning rounded-pill"
                    style="display:none; margin-left:8px; font-size:0.7rem; min-width:20px; height:20px; display:inline-flex; align-items:center; justify-content:center;">
              </span>
            </a>
            <div id="chatroomsContainer" class="chatrooms-collapsible scrollable" style="display:none; background: #1F2937 !important; border: none; width: 100%; overflow-y: auto;">
              <div id="teamSelector" class="team-selector d-flex flex-column mb-3 px-2">
                {% for team in teams %}
                  <button class="team-btn text-white border-0 py-2 px-3 text-center w-100 {{ team.color_class }} position-relative"
                          data-team-id="{{ team.id }}"
                          data-team-color-class="{{ team.color_class }}"
                          data-team-name="{{ team.name }}">

                    <!-- Unread badge -->
                    <span class="team-badge position-absolute text-warning badge rounded-pill bg-gray"
                          style="display:none; font-size: 0.75rem; padding: 2px 6px;
                                  top: -5px; right: 0;"
                          data-team-badge="{{ team.id }}">
                    </span>

                    <!-- Inactive icon -->
                    <svg class="team-icon team-icon-inactive btn-animate-icon" style="position:absolute; left:8px; top:50%; transform:translateY(-50%);"
                        xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                      <path d="M13 12v.01" />
                      <path d="M3 21h18" />
                      <path d="M5 21v-16a2 2 0 0 1 2 -2h6m4 10.5v7.5" />
                      <path d="M21 7h-7m3 -3l-3 3l3 3" />
                    </svg>

                    {{ team.name }}

                    <!-- Active icon -->
                    <svg class="team-icon team-icon-active btn-animate-icon btn-animate-icon-move-start" style="position:absolute; right:8px; top:50%; transform:translateY(-50%);"
                        xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                      <path d="M13 12v.01" />
                      <path d="M3 21h18" />
                      <path d="M5 21v-16a2 2 0 0 1 2 -2h7.5m2.5 10.5v7.5" />
                      <path d="M14 7h7m-3 -3l3 3l-3 3" />
                    </svg>

                  </button>
                {% endfor %}
              </div>

            </div>
          </li>

            
        </ul>
      </div>
    </div>
  </header>

  <div class="page-body" style="flex:1 1 auto; display:flex; overflow:hidden;">
    <div class="container-xl d-flex flex-fill border-0 p-0" style="flex:1 1 auto; display:flex; flex-direction:column; overflow:hidden;">
      <div class="card chat-card flex-fill" style="height:100%; overflow:hidden;">
        <div class="row g-0 flex-fill" style="height:100%;">

          <!-- DESKTOP LEFT COLUMN -->
          <div class="d-none d-lg-flex col-12 col-lg-5 col-xl-3 border-end flex-column" style="display:flex; flex-direction:column; height:100%;">
            <div class="card-header my-2 p-2 justify-content-center align-items-center border-0 sticky-top">
              <!-- Back button (desktop only) -->
              <a class="link-secondary p-0 ms-2 me-auto d-flex chat-back-btn animate-icon-move-start" style="color:white;">
                <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="#ff5e01ff"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-chevrons-left">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M11 7l-5 5l5 5" /><path d="M17 7l-5 5l5 5" />
                </svg>
              </a>
              <!-- Avatar -->
              <span class="d-flex me-2 gap-2 align-items-center justify-content-center" style="width:40px; height:40px;">
                {% if request.user|is_project_wide_admin %}
                  <a class="nav-link text-white animate-icon-pulse" href="{% url 'accounts:admin_dashboard' %}">
                    <span class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler.io/icons/icon/home -->
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0066ffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                        <path d="M5 12l-2 0l9 -9l9 9l-2 0"></path>
                        <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7"></path>
                        <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6"></path>
                      </svg>
                    </span>
                  </a>
                {% else %}
                  <a class="nav-link text-white" href="{% url 'dashboard' %}">
                    <span class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler.io/icons/icon/home -->
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0066ffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                        <path d="M5 12l-2 0l9 -9l9 9l-2 0"></path>
                        <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7"></path>
                        <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6"></path>
                      </svg>
                    </span>
                  </a>
                {% endif %}
                {% if request.user|in_team:"Magnet" %}
                  <a class="nav-link text-white" href="{% url 'guest_list' %}">
                    <span class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler.io/icons/icon/home -->
                      <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="#ff5e01ff"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-users">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" /><path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" /><path d="M21 21v-2a4 4 0 0 0 -3 -3.85" />
                      </svg>
                    </span>
                  </a>
                {% endif %}
              </span>

              <!-- Text 
              <kbd class="bg-warning-lt"><h5>A People <em>Helped</em> By God!</h5></kbd>-->
            </div>
            <!-- Desktop User list -->
            <div class="card-body p-0 mt-0 mb-3 scrollable flex-fill">
              <div class="row g-2">
                <!-- Team Buttons Switcher -->
                <div id="teamSelector" class="team-selector d-flex flex-column mb-3">
                  {% for team in teams %}
                    <button class="team-btn text-white border-0 py-2 px-3 text-center w-100 {{ team.color_class }} position-relative"
                            data-team-id="{{ team.id }}"
                            data-team-color-class="{{ team.color_class }}"
                            data-team-name="{{ team.name }}">

                      <!-- Unread badge -->
                      <span class="team-badge position-absolute text-warning badge rounded-pill bg-gray"
                            style="display:none; font-size: 0.75rem; padding: 2px 6px;
                                    top: 50%; right: 6px;"
                            data-team-badge="{{ team.id }}">
                      </span>

                      <!-- Inactive icon (visible when NOT active) -->
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" 
                          class="team-icon team-icon-inactive team-icon-animate-icon icon icon-tabler icons-tabler-outline icon-tabler-door-enter"
                          style="position:absolute; left:8px; top:50%; transform:translateY(-50%);">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M13 12v.01" />
                        <path d="M3 21h18" /><path d="M5 21v-16a2 2 0 0 1 2 -2h6m4 10.5v7.5" />
                        <path d="M21 7h-7m3 -3l-3 3l3 3" />
                      </svg>

                      {{ team.name }}

                      <!-- Active icon (visible only when active) -->
                      
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" 
                          class="team-icon team-icon-active team-icom-animate-icon btn-animate-icon-move-start icon icon-tabler icons-tabler-outline icon-tabler-door-exit"
                          style="position:absolute; right:8px; top:50%; transform:translateY(-50%);">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M13 12v.01" />
                        <path d="M3 21h18" /><path d="M5 21v-16a2 2 0 0 1 2 -2h7.5m2.5 10.5v7.5" />
                        <path d="M14 7h7m-3 -3l3 3l-3 3" />
                      </svg>
                    </button>
                  {% endfor %}
                </div>

                <!-- Users Display Area -->
                <div id="teamUsersContainer">
                  {% for team in teams %}
                    <div id="team-users-{{ team.id }}" class="team-users d-none">
                      {% for user in team.enriched_users %}
                        <div class="card shadow-sm border-0 mb-2 {{ user.color }} user-card" data-user-id="{{ user.id }}" data-online="{{ user.is_online }}">
                          <div class="card-body py-2 px-3 d-flex align-items-center">
                            <!-- Avatar -->
                            <div class="me-3 position-relative">
                              <a href="tel:{{ user.phone_number }}">
                                {% if user.image %}
                                  <span class="avatar rounded"
                                        style="background-image:url('{{ user.image }}');
                                              width:40px; height:40px;
                                              background-size:cover;
                                              background-position:center;">
                                  </span>
                                {% else %}
                                  <span class="avatar d-flex align-items-center justify-content-center rounded text-white fw-bold"
                                        style="width:40px; height:40px; font-size:0.9rem;">
                                    {{ user.initials }}
                                  </span>
                                {% endif %}
                              </a>
                              <span class="online-badge position-absolute top-0 end-0 rounded-circle"
                                    style="width:10px; height:10px; background: #22c55e; border: 1px solid #111;"></span>
                            </div>

                            <!-- Name + Last Message -->
                            <div class="flex-grow-1">
                              <div class="fw-bold text-truncate"
                                  style="color: var(--tblr-{{ user.color }});">
                                {{ user.title|default:"" }} {{ user.full_name }}
                              </div>
                              <!--<div id="last-message-{{ user.id }}"
                                  class="text-secondary fst-italic text-truncate"
                                  style="font-size:0.65rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                {{ user.last_message|default:"No messages yet"|truncatechars:30 }}
                              </div>-->
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>

          <!-- CHAT AREA -->
          <div class="chat-column col-12 col-lg-7 col-xl-9 d-flex flex-column" style="height:100%;">
            <!-- Desktop right column header -->
            <div class="d-none d-lg-flex card-header justify-content-center border-0 position-relative">
              
              <!-- Search bar container -->
              <div class="input-icon position-absolute">
                <!-- Input -->
                <input type="text"
                      class="form-control text-center rounded-4 ms-2 border-0 chat-search"
                      placeholder="Search Chat" aria-label="Search"
                      style="
                        background: #111827;
                        box-shadow: 0 4px 8px #000000d2;
                        height: 48px;             /* tall enough for icons */
                        padding-left: 48px;       /* space for logo */
                        padding-right: 48px;      /* space for avatar */
                        width: 250px;
                      ">

                <!-- Avatar / SVG inside input (right)
                <span class="input-icon-addon top-50 start-0 translate-middle-y ps-3 me-2">
                  <span class="d-flex align-items-center justify-content-center" style="width:32px; height:32px;">
                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-user-search">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                      <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" /><path d="M6 21v-2a4 4 0 0 1 4 -4h1.5" />
                      <path d="M18 18m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" /><path d="M20.2 20.2l1.8 1.8" />
                    </svg>
                  </span>
                  </span>
                </span>-->

                <!-- Logo inside input (left) 
                <span class="input-icon-addon top-50 end-0 translate-middle-y ps-3 me-2" style="pointer-events:auto;">
                  {% if request.user|is_project_wide_admin %}
                    <a class="nav-link text-white" href="{% url 'accounts:admin_dashboard' %}">
                      <span class="nav-link-icon d-md-none d-lg-inline-block">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0066ffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                          <path d="M5 12l-2 0l9 -9l9 9l-2 0"></path>
                          <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7"></path>
                          <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6"></path>
                        </svg>
                      </span>
                    </a>
                  {% else %}
                    <a class="nav-link text-white" href="{% url 'dashboard' %}">
                      <span class="nav-link-icon d-md-none d-lg-inline-block">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0066ffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                          <path d="M5 12l-2 0l9 -9l9 9l-2 0"></path>
                          <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7"></path>
                          <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6"></path>
                        </svg>
                      </span>
                    </a>
                  {% endif %}
                </span>-->
              </div>

              <!-- Desktop right icons (classic style, hidden on mobile) -->
              <div class="navbar-nav flex-row ms-auto">  
                <div class="nav-item dropdown d-flex align-items-center">
                  <a href="#" class="nav-link px-0" data-bs-toggle="dropdown" aria-label="Show notifications">
                    <!-- Tabler bell icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ff5e01ff"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                      <path d="M10 5a2 2 0 1 1 4 0a7 7 0 0 1 4 6v3a4 4 0 0 0 2 3h-16a4 4 0 0 0 2 -3v-3a7 7 0 0 1 4 -6"></path>
                      <path d="M9 17v1a3 3 0 0 0 6 0v-1"></path>
                    </svg>
                    {% if unread_count > 0 %}
                      <span class="badge-lt text-red position-absolute top-5 start-100 translate-middle"
                            style="font-size: 0.7rem; width: 20px; height:20px; display:flex; align-items:center; justify-content:center;"
                            id="notif-badge">
                        {{ unread_count }}
                      </span>
                    {% endif %}
                  </a>

                  <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-end dropdown-menu-card notif-dropdown">
                    <div class="card">
                      <div class="card-header d-flex">
                        <h3 class="card-title">Notifications</h3>
                        <div class="btn-close ms-auto" data-bs-dismiss="dropdown"></div>
                      </div>

                      <div class="list-group list-group-flush list-group-hoverable" id="notif-list">
                        {% for notif in unread_notifications %}
                        <div class="list-group-item notif-item" data-id="{{ notif.id }}">
                          <div class="row align-items-center">
                            <div class="col-auto">
                              <span class="status-dot status-dot-animated {% if notif.is_urgent %}bg-red{% elif notif.is_success %}bg-green{% else %}bg-gray{% endif %} d-block"></span>
                            </div>
                            <div class="col">
                              <a href="{{ notif.link }}" class="text-body d-block notif-link text-truncate">{{ notif.title }}</a>
                              <div class="d-block text-secondary mt-n1 notif-description" data-full="{{ notif.description }}">
                                {{ notif.description|truncatechars:150 }}
                                {% if notif.description|length > 150 %}
                                  <a href="#" class="show-more">...more</a>
                                {% endif %}
                              </div>
                            </div>
                            <div class="col-auto">
                              <a href="#" class="list-group-item-actions notif-star">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                  class="icon text-light icon-2">
                                  <path
                                    d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z"></path>
                                </svg>
                              </a>
                            </div>
                          </div>
                        </div>
                        {% empty %}
                        <div class="list-group-item">No new notifications</div>
                        {% endfor %}
                      </div>

                      <div class="card-body">
                        <div class="row">
                          <div class="col">
                            <a href="#" class="btn btn-2 w-100 mark-all-read-btn"> Mark All Read </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="nav-item dropdown">
                  <a href="#" class="nav-link d-flex lh-1 p-0 px-2 ms-2 text-white" data-bs-toggle="dropdown" aria-label="Open user menu" aria-expanded="false">
                    {% if user.image %}
                      <img src="{{ user.image.url }}" class="avatar avatar-sm" 
                          style="width: 32px; height: 32px; border-radius: 0.5rem; object-fit: cover;">
                    {% else %}
                      <span class="avatar avatar-sm bg-grey text-white d-inline-flex align-items-center justify-content-center"
                            style="width: 32px; height: 32px; font-weight: bold; font-size: 16px; border-radius: 0.5rem;">
                        {{ user.initials }}
                      </span>
                    {% endif %}
                  </a>
                  <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow py-1">
                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#notifSettingsModal">
                      <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-bell-cog">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 17h-8a4 4 0 0 0 2 -3v-3a7 7 0 0 1 4 -6a2 2 0 1 1 4 0a7 7 0 0 1 4 6v.5" />
                        <path d="M19.001 19m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M19.001 15.5v1.5" />
                        <path d="M19.001 21v1.5" /><path d="M22.032 17.25l-1.299 .75" /><path d="M17.27 20l-1.3 .75" />
                        <path d="M15.97 17.25l1.3 .75" /><path d="M20.733 20l1.3 .75" /><path d="M9 17v1a3 3 0 0 0 3 3" />
                      </svg>
                      Preferences
                    </a>
                    <a href="https://gatewaynation.org" class="dropdown-item" target="_blank" rel="noreferrer">
                      <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-pointer">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M7.904 17.563a1.2 1.2 0 0 0 2.228 .308l2.09 -3.093l4.907 4.907a1.067 1.067 0 0 0 1.509 0l1.047 -1.047a1.067 1.067 0 0 0 0 -1.509l-4.907 -4.907l3.113 -2.09a1.2 1.2 0 0 0 -.309 -2.228l-13.582 -3.904l3.904 13.563z" />
                      </svg>
                      Gateway Nation
                      <span class="badge badge-sm bg-green-lt ms-auto">Home</span>
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="{% url 'login' %}" class="dropdown-item text-danger">
                      <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-logout">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" />
                        <path d="M9 12h12l-3 -3" /><path d="M18 15l3 -3" />
                      </svg>
                      Logout
                    </a>
                  </div>
                </div>
              </div>
            </div>
            <!-- Chat Body -->
            <div class="card-body mt-0 p-0 d-flex flex-column flex-fill" style="height:100%; overflow:hidden;">
              <!-- Dynamic User List Banner (top of chat) -->
              <div id="activeUserListWrapper" class="team-user-strip">
                <div id="activeUserList" class="team-user-strip-inner" aria-hidden="false">
                  <!-- JS will populate user-card nodes here -->
                </div>
              </div>
              <!-- Pinned Message Preview -->
              <div id="pinnedPreview" class="pinned-preview"></div>
              <!-- Chat Container -->
              <div class="chat-bubbles text-start ps-1 pe-1 pb-1 flex-grow-1" id="chatMessagesContainer" style="overflow-y:auto; position:relative; overflow-x:hidden;">
                <!-- Messages will be dynamically loaded here -->
              </div>
              
              <!-- Options Panel -->
              <div id="chatOptionsPanel" class="options-panel hidden" aria-hidden="true">
                <button id="replyBtn" title="Reply">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#f59f00" class="bi bi-reply-all-fill" viewBox="0 0 16 16">
                    <path d="M8.021 11.9 3.453 8.62a.72.72 0 0 1 0-1.238L8.021 4.1a.716.716 0 0 1 1.079.619V6c1.5 0 6 0 7 8-2.5-4.5-7-4-7-4v1.281c0 .56-.606.898-1.079.62z"/>
                    <path d="M5.232 4.293a.5.5 0 0 1-.106.7L1.114 7.945l-.042.028a.147.147 0 0 0 0 .252l.042.028 4.012 2.954a.5.5 0 1 1-.593.805L.539 9.073a1.147 1.147 0 0 1 0-1.946l3.994-2.94a.5.5 0 0 1 .699.106"/>
                  </svg>
                </button>
                <!--<button id="editBtn" title="Edit">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
                    <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001m-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708z"/>
                  </svg>
                </button>-->
                <button id="copyBtn" title="Copy">
                  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="#02bd12ff"  class="icon icon-tabler icons-tabler-filled icon-tabler-copy-check">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M18.333 6a3.667 3.667 0 0 1 3.667 3.667v8.666a3.667 3.667 0 0 1 -3.667 3.667h-8.666a3.667 3.667 0 0 1 -3.667 -3.667v-8.666a3.667 3.667 0 0 1 3.667 -3.667zm-3.333 -4c1.094 0 1.828 .533 2.374 1.514a1 1 0 1 1 -1.748 .972c-.221 -.398 -.342 -.486 -.626 -.486h-10c-.548 0 -1 .452 -1 1v9.998c0 .32 .154 .618 .407 .805l.1 .065a1 1 0 1 1 -.99 1.738a3 3 0 0 1 -1.517 -2.606v-10c0 -1.652 1.348 -3 3 -3zm1.293 9.293l-3.293 3.292l-1.293 -1.292a1 1 0 0 0 -1.414 1.414l2 2a1 1 0 0 0 1.414 0l4 -4a1 1 0 0 0 -1.414 -1.414" />
                  </svg>
                </button>
                <button id="pinBtn" title="Pin">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#f703d7ff" class="bi bi-pin-angle-fill" viewBox="0 0 16 16">
                    <path d="M9.828.722a.5.5 0 0 1 .354.146l4.95 4.95a.5.5 0 0 1 0 .707c-.48.48-1.072.588-1.503.588-.177 0-.335-.018-.46-.039l-3.134 3.134a6 6 0 0 1 .16 1.013c.046.702-.032 1.687-.72 2.375a.5.5 0 0 1-.707 0l-2.829-2.828-3.182 3.182c-.195.195-1.219.902-1.414.707s.512-1.22.707-1.414l3.182-3.182-2.828-2.829a.5.5 0 0 1 0-.707c.688-.688 1.673-.767 2.375-.72a6 6 0 0 1 1.013.16l3.134-3.133a3 3 0 0 1-.04-.461c0-.43.108-1.022.589-1.503a.5.5 0 0 1 .353-.146"/>
                  </svg>
                </button>
                <!-- Hidden Unpin SVG Template 
                <svg id="unpinIconTemplate" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#f703d7ff" 
                    class="bi bi-pin-angle" viewBox="0 0 16 16" style="display:none;">
                  <path d="M4.146 14.854a.5.5 0 0 1-.708-.708l3.182-3.182-2.829-2.828a.5.5 0 0 1 0-.707c.48-.48 
                          1.073-.588 1.503-.588.177 0 .335.018.46.039l3.134-3.134a6 6 0 0 1-.16-1.013c-.046-.702.032-1.687.72-2.375a.5.5 
                          0 0 1 .707 0l2.829 2.828 3.182-3.182c.195-.195 1.219-.902 1.414-.707s-.512 1.22-.707 1.414l-3.182 3.182 
                          2.828 2.829a.5.5 0 0 1 0 .707c-.688.688-1.673.767-2.375.72a6 6 0 0 1-1.013-.16l-3.134 3.134a3 3 0 0 1 
                          .04.461c0 .43-.108 1.022-.589 1.503a.5.5 0 0 1-.354.146z"/>
                </svg>-->
                <!--
                <button id="deleteBtn" title="Delete">
                  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-trash">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" />
                    <path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                    <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                  </svg>
                </button>
                -->
              </div>
              <!-- Sticky Date Header -->
              <div id="stickyDateHeader"></div>

              <!--<div id="scrollToBottomBtn" class="scroll-to-bottom" title="Scroll to bottom">⬇️</div>-->
              <!-- Floating scroll-to-bottom -->
              <div id="scrollToBottomBtn" class="scroll-to-bottom hidden" title="Scroll to bottom">
                <svg  xmlns="http://www.w3.org/2000/svg"  width="36"  height="36"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-chevrons-down">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M7 7l5 5l5 -5" /><path d="M7 13l5 5l5 -5" />
                </svg>
              </div>
            </div>

            <!-- Typing indicator -->
            <span class="team-typing position-absolute bottom-0 start-50 translate-middle-x text-xs text-muted"
                  style="display:none;"
                  data-team-typing="{{ team.id }}">
              typing…
            </span>

            {% if not request.user|has_group:"Demo" or request.user.is_superuser %} 
              <!-- Message Input --> 
              <div class="card-footer border-0"> 
                
                <div class="input-group input-group-flat border-0 d-flex flex-column p-2"
                    style="box-shadow: 0 4px 8px #000000d2; border-radius: 1rem; background: #0c1420;">

                  <!-- Reply Preview (inline above textarea) -->
                  <div id="replyPreview" 
                      class="d-none d-flex reply-preview text-white p-2 mb-1 justify-content-between align-items-center"
                      style="border-radius: 6px; border-left: 4px solid #018f14ff; background-color: #111827; font-style: normal; box-shadow: 0 4px 8px #0000004d;">
                    <span id="replyPreviewText"></span>
                    <span id="cancelReply" class="p-0 border-0 d-flex align-items-center justify-content-center"
                          style="flex:0 0 auto; cursor:pointer;">
                      <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="rgba(255, 0, 0, 1)"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-x">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M18 6l-12 12" /><path d="M6 6l12 12" />
                      </svg>
                    </span>
                  </div>

                  <!-- Guest Preview (injected dynamically) -->
                  <div id="guestPreviewContainer"></div>

                  <!-- Input Row (always at bottom of stack) -->
                  <div class="d-flex align-items-end justify-content-center w-100">
                    <!-- Guest Attachment Button -->
                    <div class="guest-controls" style="display:none;">
                      <a href="#" class="link-secondary dropdown p-2 text-purple d-flex align-items-center justify-content-center" 
                        id="openUserGuestPopup" style="flex: 0 0 auto;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="icon icon-tabler icons-tabler-outline icon-tabler-user-up"> 
                          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                          <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" /> 
                          <path d="M6 21v-2a4 4 0 0 1 4 -4h4" />
                          <path d="M19 22v-6" />
                          <path d="M22 19l-3 -3l-3 3" /> 
                        </svg> 
                      </a>
                    </div>

                    <!-- File Attachment -->
                    <input type="file" id="fileInput" class="d-none" />
                    <a href="#" id="attachFileBtn" class="link-secondary text-teal p-2 d-flex align-items-center justify-content-center">
                      <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-paperclip">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M15 7l-6.5 6.5a1.5 1.5 0 0 0 3 3l6.5 -6.5a3 3 0 0 0 -6 -6l-6.5 6.5a4.5 4.5 0 0 0 9 9l6.5 -6.5" />
                      </svg>
                    </a>

                    <!-- Textarea -->
                    <textarea class="form-control border-0 flex-grow-1" id="chatInput" 
                              placeholder="Type Message" rows="1"
                              style="resize: none; overflow: hidden; background: transparent;"></textarea>

                    

                    <!-- Send Button -->
                    <a href="#" id="sendButton" class="link-secondary p-2 text-green d-flex align-items-center justify-content-center"
                      style="flex: 0 0 auto;"> 
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-send"> 
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10 14l11 -11" />
                        <path d="M21 3l-6.5 18a.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a.55 .55 0 0 1 0 -1l18 -6.5" /> 
                      </svg> 
                    </a>
                  </div>
                </div>
                <!-- Mention dropdown -->
                <div id="mentionDropdown" class="mention-dropdown d-none"></div> 
                
              </div> 
            {% endif %}
            <div id="preview" class="preview"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Central popup container -->
<div id="userGuestPopup" class="d-none">
  <div class="popup-backdrop"></div>
  <div class="popup-content">
    <div class="popup-header d-flex justify-content-between align-items-center">
      <input type="text" id="popupSearch" placeholder="Search Officers/Guests" class="form-control flex-grow-1 me-2">
      <span id="popupClose">
        <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-x">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M18 6l-12 12" /><path d="M6 6l12 12" />
        </svg>
      </span>
    </div>
    <div class="popup-body" id="popupBody"></div>
  </div>
</div>

{% endblock %}

{% block extra_js %}

<script src="https://cdn.jsdelivr.net/npm/textarea-caret@3.1.0/index.min.js"></script>

<script>
  //window.magnetTeamId = {{ magnet_team_id|default:"null" }};
  //if (window.magnetTeamId === "null") window.magnetTeamId = null;
</script>

<script>
const USERS = JSON.parse('{{ users_json|escapejs }}' || '[]');
const USER_GUESTS = JSON.parse('{{ user_guests_json|escapejs }}' || '[]');
const UNASSIGNED_GUESTS = JSON.parse('{{ unassigned_guests_json|escapejs }}' || '[]');
const LAST_MESSAGES = JSON.parse('{{ last_messages_json|escapejs }}' || '[]');
const CURRENT_USER_ID = {{ current_user_id }};
const CURRENT_USER_ROLE = "{{ current_user_role }}";
const IS_MAGNET_ADMIN = {{ is_magnet_admin|yesno:"true,false" }};
const USER_PERMS = JSON.parse('{{ context_user_permissions|escapejs }}');

document.addEventListener("DOMContentLoaded", () => {
  const chatContainer = document.getElementById("chatMessagesContainer");
  const stickyDateHeader = document.getElementById("stickyDateHeader");
  const chatInput = document.getElementById("chatInput");
  const chatFooter = document.querySelector(".card-footer");
  const sendButton = document.getElementById("sendButton");
  const replyPreview = document.getElementById("replyPreview");
  const replyPreviewText = document.getElementById("replyPreviewText");
  const cancelReply = document.getElementById("cancelReply");
  const openBtn = document.getElementById("openUserGuestPopup");
  const popup = document.getElementById("userGuestPopup");
  const popupBody = document.getElementById("popupBody");
  const popupSearch = document.getElementById("popupSearch");
  const closeBtn = document.getElementById("popupClose");
  const optionsPanel = document.getElementById("chatOptionsPanel");
  const scrollToBottomBtn = document.getElementById("scrollToBottomBtn");
  const mentionDropdown = document.getElementById("mentionDropdown");

  const preview = document.getElementById("preview");

  const fileInput = document.getElementById("fileInput");
  const openFileAttach = document.getElementById("openFileAttach");
  const filePreviewContainer = document.getElementById("filePreviewContainer");
  const filePreviewContent = document.getElementById("filePreviewContent");
  const cancelFilePreview = document.getElementById("cancelFilePreview");
  //const roomId = chatContainer.dataset.roomId;

  const wrapper = document.getElementById("activeUserListWrapper");
  const inner = document.getElementById("activeUserList");
  const teamSelector = document.querySelector("#teamSelector"); // your list of team links/buttons

  // Handle all back buttons (desktop + mobile)
  const guestListURL = "{% url 'guest_list' %}";
  const adminDashboardURL = "{% url 'accounts:admin_dashboard' %}";
  const regularDashboardURL = "{% url 'dashboard' %}";

  // user_json is already defined globally in your template context
  const currentUser = USERS.find(u => u.id === CURRENT_USER_ID) || {};
  const userRole = (CURRENT_USER_ROLE || "").toLowerCase();
  const isMagnetUser = userRole.includes("magnet");
  const isProjectWideAdmin = USER_PERMS.is_project_wide_admin === true;

  // Use existing DOM container with id="pinnedPreview" if present
  const pinnedPreviewContainer = document.getElementById('pinnedPreview') || document.querySelector('.pinned-preview');

  const toggle = document.getElementById("chatroomsToggle");
  const chatroomsBox = document.getElementById("chatroomsContainer");

  toggle.addEventListener("click", (e) => {
      e.preventDefault();
      const isHidden = chatroomsBox.style.display === "none";

      // Toggle visibility instantly
      chatroomsBox.style.display = isHidden ? "block" : "none";

      if (isHidden) {
          scrollToActiveTeam();
      }
  });

  // Auto-scroll to active team
  function scrollToActiveTeam() {
    const activeBtn = teamSelector.querySelector(".active-team");

    if (activeBtn) {
        setTimeout(() => {
            activeBtn.scrollIntoView({ behavior: "smooth", block: "center" });
        }, 50);
    }
  }

  document.querySelectorAll(".chat-back-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const fromLogin = document.referrer.includes("/accounts/login");

      // --- CASE 1: User is in Magnet team ---
      if (isMagnetUser) {
        if (fromLogin) {
          // If user came from login → go to guest list
          window.location.href = guestListURL;
        } else {
          // Otherwise just go back to previous page
          window.history.back();
        }
        return;
      }

      // --- CASE 2: Non-Magnet Team ---
      if (fromLogin) {
        // If user came from login, send to appropriate dashboard
        if (isProjectWideAdmin && !isMagnetUser) {
          window.location.href = adminDashboardURL;
        } else {
          window.location.href = regularDashboardURL;
        }
      } else {
        // If not from login, just go back to where they came from
        window.history.back();
      }
    });
  });

  let selectedGuest = null;
  let replyToId = null;
  let selectedBubbles = new Set(); // selected message IDs
  let lastSelectionClick = null;    // for detecting single-selection for edit/reply
  const isTouch = ("ontouchstart" in window);
  let loading = false;
  let oldestLoaded = null; // track oldest message timestamp
  const limit = 50;
  let lastMessageDate = null;
  let pinnedMessages = []; // local cache (max 3, FIFO)
  let currentTeam = null;
  let manualClose = false;
  let stripVisible = false;
  let autoHideTimeout = null;

  // default team param — from template context
  const initialTeamId = "{{ selected_team_id|default:'' }}";

  let chatSocket = null;

  function connectSocket(teamParam) {
    // teamParam may be id or name
    const qs = teamParam ? `?team=${encodeURIComponent(teamParam)}` : "";
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${qs}`);

    chatSocket.onopen = () => {
      console.log("✅ WS connected to", teamParam || "central");
      chatSocket.send(JSON.stringify({
        type: "get_unread_counts"
      }));
    };

    chatSocket.onclose = (e) => {
      console.log("❌ Socket closed:", e.reason);
      if (!manualClose) setTimeout(() => connectSocket(teamParam), 3000); // only auto-reconnect if not switching
    };

    chatSocket.onerror = (err) => {
      console.error("Socket error:", err);
      chatSocket.close();
    };

    chatSocket.onmessage = (e) => {
      const data = JSON.parse(e.data);

      const incomingTeam = (data.team_id === null || data.team_id === undefined) ? "central" : String(data.team_id);

      // Normalize active team for comparison: if activeTeamId is null/undefined -> central
      const normalizedActive = (activeTeamId === null || activeTeamId === undefined) ? "central" : String(activeTeamId);

      console.log("📩 Incoming WebSocket data:", data);
      console.log("Incoming team:", incomingTeam, "Normalized active:", normalizedActive);

      // Update your local USER_GUESTS
      if (data.guest && data.guest.assigned_user) {
        const idx = USER_GUESTS.findIndex(g => g.id === data.guest.id);
        if (idx !== -1) USER_GUESTS[idx].assigned_user = data.guest.assigned_user;
      }

      // Handle online/offline updates
      if (data.type === "user_online_status") {
        const card = document.querySelector(`.user-card[data-user-id="${data.user_id}"]`);
        if (card) {
          card.dataset.online = data.is_online ? "true" : "false";
        }
        updateBannerOnlineCount();
      }

      if (data.type == "mark_read") {
       // await self.mark_team_read(data.get("team_id"))
        //await self.send_unread_counts()
        return
      }

      if (data.type === "unread_counts") {
        Object.entries(data.counts).forEach(([teamId, count]) => {
            UNREAD[teamId] = count;
            updateTeamBadge(teamId);
        });
        updateTotalUnreadBadges();
      }

      // Typing event
      if (data.type === "typing") {
          if (incomingTeam !== normalizedActive) {
              showTeamTyping(incomingTeam);
          }
          return;
      }

      if (data.type === "chat_message" || data.message) {

        //if (!incomingTeam) return;

        // If message is for another non-central team -> increment unread
        if (incomingTeam !== normalizedActive) {
          // don't show unread badges for central
          if (incomingTeam !== "central") {
            UNREAD[incomingTeam] = (UNREAD[incomingTeam] || 0) + 1;
            updateTeamBadge(incomingTeam);
            updateTotalUnreadBadges();
            flashTeamButton(incomingTeam);
          }
          return;
        }

        appendMessage(data);
        return;
      }

      if (data.type === "pinned_preview") {
        // Initial load or refresh (server sends last 3 pinned)
        pinnedMessages.length = 0;
        (data.messages || []).forEach(m => addPinnedMessage(m));
        renderPinnedPreview();
        return;
      }

      // Individual message pinned toggles (no full message payload)
      if (data.type === "message_pinned") {
        const ids = data.message_ids || [];
        const pinnedMap = data.pinned || {};
        const pinner = data.pinned_by || null;
        ids.forEach(id => {
          const node = document.getElementById(`chat-bubble-${id}`);
          if (!node) return;
          const flags = node.querySelector('.chat-bubble-flags');
          const shouldPin = pinnedMap[String(id)] || pinnedMap[id];
          if (shouldPin) {
            if (!node.querySelector('.pin-flag')) {
              const pin = document.createElement('span');
              pin.classList.add('pin-flag');
              pin.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="#f703d7ff" class="bi bi-pin-angle-fill" viewBox="0 0 16 16">
                <path d="M9.828.722a.5.5 0 0 1 .354.146l4.95 4.95a.5.5 0 0 1 0 .707c-.48.48-1.072.588-1.503.588-.177 0-.335-.018-.46-.039l-3.134 3.134a6 6 0 0 1 .16 1.013c.046.702-.032 1.687-.72 2.375a.5.5 0 0 1-.707 0l-2.829-2.828-3.182 3.182c-.195.195-1.219.902-1.414.707s.512-1.22.707-1.414l3.182-3.182-2.828-2.829a.5.5 0 0 1 0-.707c.688-.688 1.673-.767 2.375-.72a6 6 0 0 1 1.013.16l3.134-3.133a3 3 0 0 1-.04-.461c0-.43.108-1.022.589-1.503a.5.5 0 0 1 .353-.146"/>
              </svg>`;
              flags?.appendChild(pin);
            }
            // 🔹 Add pinned preview immediately with pinner info
            addPinnedMessage({
              id,
              message: node.querySelector('.chat-bubble-body')?.innerText || "",
              original_sender_id: node.dataset.senderId,
              original_sender_name: node.dataset.senderName,
              original_sender_title: node.dataset.senderTitle,
              pinned_by: pinner,   // ✅ include this
              pinned: true,
              pinned_at: new Date().toISOString()
            });
          } else {
            const el = node?.querySelector('.pin-flag');
            if (el) el.remove();
            removePinnedMessage(id);
          }
        });
        removePinnedMessage();
        return;
      }

      if (data.action === "pin_update" || data.action === "pin") {
        (data.pins || []).forEach(p => {
          const id = p.id || p.message_id || p;
          if (p.pinned) {
            // if full message present, add to preview stack
            if (p.message) {
              addPinnedMessage(p);
            } else {
              // just toggle flag on bubble if present
              const node = document.getElementById(`chat-bubble-${id}`);
              if (node && !node.querySelector('.pin-flag')) {
                const flags = node.querySelector('.chat-bubble-flags');
                const pin = document.createElement('span');
                pin.classList.add('pin-flag');
                pin.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="#f703d7ff" class="bi bi-pin-angle-fill" viewBox="0 0 16 16">
                    <path d="M9.828.722a.5.5 0 0 1 .354.146l4.95 4.95a.5.5 0 0 1 0 .707c-.48.48-1.072.588-1.503.588-.177 0-.335-.018-.46-.039l-3.134 3.134a6 6 0 0 1 .16 1.013c.046.702-.032 1.687-.72 2.375a.5.5 0 0 1-.707 0l-2.829-2.828-3.182 3.182c-.195.195-1.219.902-1.414.707s.512-1.22.707-1.414l3.182-3.182-2.828-2.829a.5.5 0 0 1 0-.707c.688-.688 1.673-.767 2.375-.72a6 6 0 0 1 1.013.16l3.134-3.133a3 3 0 0 1-.04-.461c0-.43.108-1.022.589-1.503a.5.5 0 0 1 .353-.146"/>
                  </svg>`;
                flags?.appendChild(pin);
              }
            }
          } else {
            removePinnedMessage(id);
            const node = document.getElementById(`chat-bubble-${id}`);
            const el = node?.querySelector('.pin-flag');
            if (el) el.remove();
          }
        });
        return;
      }

      // Fallback: if server sent other non-message payloads, ignore
      console.warn("Skipping non-message payload:", data);
    };

    window.ChatSocket = chatSocket; // expose for debugging
    window.currentTeam = teamParam || null; // track current team
    return chatSocket;

  }
  // ✅ Initial connection (central)
  connectSocket(null);

  // Update banner to show online count
  function updateBannerOnlineCount() {
    const badge = document.getElementById("online-count-badge");
    if (!badge) return;

    let cards;

    // If in a specific team → count ONLY that team's visible users
    if (currentTeam) {
        cards = document.querySelectorAll(`#team-users-${currentTeam} .user-card[data-online="true"]`);
    } 
    // No team selected → count ALL users (central room)
    else {
        cards = document.querySelectorAll(`.user-card[data-online="true"]`);
    }

    const count = cards.length;

    if (count > 0) {
        badge.textContent = count;
        badge.style.display = "inline-block";
    } else {
        badge.style.display = "none";
    }
  }

  function updateStickyHeaderPosition() {
    // Only account for the user strip height
    const stripHeight = wrapper.classList.contains("visible") ? wrapper.offsetHeight : 0;
    stickyDateHeader.style.top = `${stripHeight + 0}px`; // 4px gap from strip
  }

  const banner = document.createElement("div");
  banner.id = "chatRoomBanner";
  banner.className = "chat-room-banner chat-room-banner-gradient";
  banner.innerHTML = `<div class="banner-inner"><span class="banner-text">GForce ChatRoom</span></div>`;
  const onlineBadge = document.createElement("span");
  onlineBadge.id = "online-count-badge";
  onlineBadge.className = "badge bg-lime text-dark fw-bold";
  onlineBadge.style.cssText = `
      position:absolute;
      right:8px;
      top:50%;
      transform:translateY(-50%);
      display:none;
  `;
  banner.appendChild(onlineBadge);
  chatContainer.prepend(banner);

  // Make banner clickable
  banner.style.cursor = "pointer";
  banner.addEventListener("click", () => {
    stripVisible = !stripVisible;
    if (stripVisible) {
      wrapper.classList.add("visible");
      resetAutoHide();
    } else {
      wrapper.classList.remove("visible");
      if (autoHideTimeout) clearTimeout(autoHideTimeout);
    }
    updateStickyHeaderPosition();
  });

  updateStickyHeaderPosition();

  // Hide strip by default
  wrapper.classList.remove("visible");

  function showTeamUsers(teamId) {
    // Hide all other team users
    document.querySelectorAll(".team-users").forEach(el => el.classList.add("d-none"));

    // Show selected team
    const container = document.getElementById(`team-users-${teamId}`);
    if (container) container.classList.remove("d-none");

    // Show the wrapper if hidden
    if (!wrapper.classList.contains("visible")) {
      wrapper.classList.add("visible");
    }

    // Reset auto-hide timer
    resetAutoHide();
    updateStickyHeaderPosition();
  }

  function hideTeamUsers() {
    wrapper.classList.remove("visible");
    updateStickyHeaderPosition();
  }

  function resetAutoHide() {
    if (autoHideTimeout) clearTimeout(autoHideTimeout);

    // Only auto-hide if mouse/touch is not over the wrapper
    if (!wrapper.matches(":hover") && !isTouching) {
      autoHideTimeout = setTimeout(() => {
        hideTeamUsers();
        stripVisible = false;
      }, 5000);
    }
  }

  // Track if touch is active
  let isTouching = false;

  // Pause auto-hide on hover (desktop) or touchstart (mobile)
  wrapper.addEventListener("mouseenter", () => {
    if (autoHideTimeout) clearTimeout(autoHideTimeout);
  });
  wrapper.addEventListener("touchstart", () => {
    isTouching = true;
    if (autoHideTimeout) clearTimeout(autoHideTimeout);
  });

  // Resume auto-hide on mouse leave or touchend
  wrapper.addEventListener("mouseleave", () => {
    resetAutoHide();
  });
  wrapper.addEventListener("touchend", () => {
    isTouching = false;
    resetAutoHide();
  });

  // Team button click
  teamSelector.querySelectorAll(".team-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const teamId = btn.dataset.teamId;

      // Toggle visibility on same team
      if (currentTeam === teamId && wrapper.classList.contains("visible")) {
        hideTeamUsers();
        currentTeam = null;
        updateBannerOnlineCount();
        return;
      }

      currentTeam = teamId;
      showTeamUsers(teamId);
      updateBannerOnlineCount();
    });
  });

  // Only hide on outside mousedown/touchstart
  ["mousedown", "touchstart"].forEach(eventType => {
    document.addEventListener(eventType, e => {
      if (!wrapper.contains(e.target) && !e.target.classList.contains("team-btn") && !banner.contains(e.target)) {
        hideTeamUsers();
        stripVisible = false;
      }
    });
  });

  function updatePinnedPreviewTop() {
    const bannerHeight = banner.offsetHeight || 28; // banner height
    const userStripHeight = wrapper.classList.contains("visible") ? wrapper.offsetHeight : 0;
    const gap = 4; // optional small gap
    pinnedPreview.style.top = `${bannerHeight + userStripHeight + gap}px`;
  }

  // Initial update (immediate + delayed)
  updatePinnedPreviewTop();

  // Run again after layout stabilizes (for fonts or transitions)
  requestAnimationFrame(() => setTimeout(updatePinnedPreviewTop, 100));

  // Update whenever the user strip visibility changes
  const observer = new MutationObserver(updatePinnedPreviewTop);
  observer.observe(wrapper, { attributes: true, attributeFilter: ["class"] });

  // Also update on window resize (in case banner/user strip size changes)
  window.addEventListener("resize", updatePinnedPreviewTop);


  // --- Styling (you can move this into CSS) ---
  const style = document.createElement("style");
  style.textContent = `
  .chat-room-banner {
    position: sticky;
    top: 0;
    left: 15px;
    z-index: 10;
    background: #111827;
    color: #f59f00;
    font-size: 0.8rem;
    font-weight: 800;
    padding: 3px 6px;
    border-radius: 2rem;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.76);
    display: flex;
    align-items: center;
    justify-content: flex-start;
    overflow: hidden;
    max-width: 100px;
    min-height: 28px;
  }

  /* Container to let text scroll smoothly without squeezing */
  .banner-inner {
    display: inline-block;
    width: 100%;
    overflow: hidden;
    text-align: left;
  }

  /* Scrolling text */
  .banner-text {
    display: inline-block;
    white-space: nowrap;
    padding-right: 100%; /* extra gap before looping */
    animation: scrollText 5s linear infinite;
  }

  /* Glossy sweep overlay */
  .chat-room-banner::after {
    content: "";
    position: absolute;
    top: 0;
    left: -150%;
    width: 60%;
    height: 100%;
    pointer-events: none;
    background: linear-gradient(
      120deg,
      transparent 0%,
      rgba(255, 255, 255, 0.15) 40%,
      rgba(255, 255, 255, 0.35) 60%,
      transparent 100%
    );
    animation: glossSweep 3s ease-in-out infinite;
    mix-blend-mode: screen;
  }

  @keyframes scrollText {
    0% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
  }

  @keyframes glossSweep {
    0% { left: -150%; }
    50% { left: 150%; }
    100% { left: 150%; }
  }
  `;
  document.head.appendChild(style);

  // ✅ Update banner text + preserve team color dynamically
  function updateBanner(teamName, colorClass = null) {
    if (!banner) return;

    banner.className = "chat-room-banner chat-room-banner-gradient";
    const textEl = banner.querySelector(".banner-text");
    if (!textEl) return;

    if (!teamName) {
      textEl.innerHTML = `<span><span class="me-2">Welcome back to GForce ChatRoom </span> — <span class="ms-2"> A People <em>Helped</em> By God!</span></span>`;
      banner.style.background = "#111827";
      banner.style.color = "#f59f00";
    } else {
      textEl.innerHTML = `<span><span class="me-2">${teamName} ChatRoom </span> — <span class="ms-2"> A People <em>Helped</em> By God!</span></span>`;

      if (colorClass) {
        banner.className = "chat-room-banner chat-room-banner-gradient"; // reset
        banner.classList.add(...colorClass.split(" "));
        banner.style.background = "none"; // allow class color
        banner.style.color = "";
      } else {
        banner.style.background = "#444";
        banner.style.color = "#fff";
      }
    }

    // 💡 Adjust scroll speed based on text length
    const textLength = textEl.textContent.length;
    const scrollDuration = Math.min(12, Math.max(6, textLength / 3));
    textEl.style.animationDuration = `${scrollDuration}s`;
  }

  // --- Team-based user strip ---
  const teamButtons = Array.from(document.querySelectorAll(".team-btn"));
  const teamSections = {};

  // --- Build teamSections map ---
  document.querySelectorAll("[id^='team-users-']").forEach(section => {
    const id = section.id.replace("team-users-", "");
    const cards = Array.from(section.querySelectorAll(".user-card")).map(c => c.outerHTML);
    teamSections[id] = cards;
  });

  // Flatten all users for "All Users"
  //const allUsers = Object.values(teamSections).flat();

  // Render ALL users (from DB, not grouped teams)
  const allCards = USERS.map(u => `
    <div class="card shadow-sm border-0 mb-2 ${u.color} user-card" data-user-id="${u.id}" data-online="${u.is_online}">
      <div class="card-body py-2 px-3 d-flex align-items-center">
        <div class="me-3 position-relative">
          <a href="tel:${u.phone_number}">
            ${
              u.image
                ? `<span class="avatar rounded"
                    style="background-image:url('${u.image}');
                          width:40px; height:40px;
                          background-size:cover;
                          background-position:center;">
                  </span>`
                : `<span class="avatar d-flex align-items-center justify-content-center rounded text-white fw-bold"
                        style="width:40px; height:40px; font-size:0.9rem;">
                    ${u.initials}
                  </span>`
            }
          </a>
          <span class="online-badge position-absolute top-0 end-0 rounded-circle"
                style="width:10px; height:10px; background: #22c55e; border: 1px solid #111;"></span>
        </div>
        <div class="flex-grow-1">
          <div class="fw-bold text-truncate" style="color: var(--tblr-${u.color});">
            ${u.title || ""} ${u.full_name}
          </div>
          
        </div>
      </div>
    </div>
  `);

  // Active team state
  let activeTeamId = null;
  const UNREAD = {};
  const TYPING_TIMEOUTS = {};
  let typingTimer;

  chatInput.addEventListener("input", () => {
      chatSocket.send(JSON.stringify({
          type: "typing",
          team_id: activeTeamId
      }));
  });

  teamButtons.forEach(btn => {
      const id = btn.dataset.teamId;
      UNREAD[id] = 0;
  });

  function updateTeamBadge(teamId) {
    const badge = document.querySelector(`[data-team-badge="${teamId}"]`);
    const count = UNREAD[teamId] || 0;

    if (!badge) {
        // Try again shortly in case layout just changed
        setTimeout(() => updateTeamBadge(teamId), 150);
        return;
    }
    badge.style.display = count > 0 ? "inline-block" : "none";
    badge.textContent = count;
    console.log("Updating badge for team", teamId, "count:", count);
  }

  // === GLOBAL UNREAD BADGES ===
  function computeTotalUnread() {
    return Object.values(UNREAD).reduce((s, v) => s + (parseInt(v) || 0), 0);
  }

  function setTotalBadge(el, count) {
    if (!el) return;
    if (!count || count <= 0) {
        el.style.display = "none";
        el.textContent = "";
        return;
    }
    el.textContent = count > 99 ? "99+" : count;
    el.style.display = "";
  }

  function updateTotalUnreadBadges() {
    const total = computeTotalUnread();
    setTotalBadge(document.getElementById("total-unread-toggler"), total);
    setTotalBadge(document.getElementById("total-unread-chatrooms"), total);
  }

  function showTeamTyping(teamId) {
    const el = document.querySelector(`[data-team-typing="${teamId}"]`);
    if (!el) return;

    el.style.display = "inline";

    // Clear previous timeout
    if (TYPING_TIMEOUTS[teamId]) {
        clearTimeout(TYPING_TIMEOUTS[teamId]);
    }

    // Hide after 3s
    TYPING_TIMEOUTS[teamId] = setTimeout(() => {
        el.style.display = "none";
    }, 3000);
  }

  function flashTeamButton(teamId) {
    const btn = document.querySelector(`.team-btn[data-team-id="${teamId}"]`);
    if (!btn) return;

    btn.classList.add("flash");
    setTimeout(() => btn.classList.remove("flash"), 600);
  }

  // Render user cards
  function renderUserList(cardsArray) {
    inner.innerHTML = cardsArray.join("");
  }

  // --- Handle Team button click ---
  teamButtons.forEach(btn => {
    btn.addEventListener("click", e => {
      e.preventDefault();

      const teamId = btn.dataset.teamId;
      const teamName = btn.dataset.teamName || "";
      const teamColor = btn.dataset.teamColorClass || "";
      const isMagnet = teamName.toLowerCase() === "magnet";

      // Helper: auto-close mobile navbar dropdown if open
      const closeMobileNavbar = () => {
        if (window.innerWidth <= 767) {
          const navbarMenu = document.getElementById("navbar-menu");
          const navbarToggler = document.querySelector(".navbar-toggler");

          // 1️⃣ Close the chatrooms toggle first
          if (chatroomsBox && chatroomsBox.style.display === "block") {
            chatroomsBox.style.display = "none";
          }

          // 2️⃣ Now close the mobile navbar
          if (navbarMenu && navbarMenu.classList.contains("show")) {
            const collapse =
              bootstrap.Collapse.getInstance(navbarMenu) ||
              new bootstrap.Collapse(navbarMenu);
            collapse.hide();

            // toggle icons
            if (navbarToggler) {
              const menuIcon = navbarToggler.querySelector(".icon-tabler-menu-deep");
              const closeIcon = navbarToggler.querySelector(".icon-tabler-x");
              if (menuIcon && closeIcon) {
                menuIcon.classList.remove("hidden");
                closeIcon.classList.add("hidden");
              }
            }
          }
        }
      };

      if (activeTeamId === teamId) {
        // --- Reset to All Users ---
        btn.classList.remove("active-team");
        activeTeamId = null;
        wrapper.className = "team-user-strip";
        renderUserList(allCards);
        inner.scrollLeft = 0;
        currentTeam = null;
        updateBanner(null);
        if (window.chatSocket) {
          manualClose = true;
          window.chatSocket.close();
          manualClose = false;
        }
        connectSocket(null);
        document.querySelector("#chatMessagesContainer").innerHTML = "";
        chatContainer.prepend(banner);
        document.querySelector("#pinnedPreview").innerHTML = "";
        oldestLoaded = null;
        loadMoreMessages();
        document.querySelectorAll(".guest-controls").forEach(el => {
          el.style.display = "none";
        });
        closeMobileNavbar();
        return;
      }

      // --- New team selected ---
      teamButtons.forEach(b => b.classList.remove("active-team"));
      btn.classList.add("active-team");
      activeTeamId = teamId;
      // Reset unread
      UNREAD[teamId] = 0;
      updateTeamBadge(teamId);
      updateTotalUnreadBadges();
      chatSocket.send(JSON.stringify({
        type: "mark_read",
        team_id: teamId
      }));

      const cards = teamSections[teamId] || [];
      wrapper.className = `team-user-strip ${teamColor}`;
      renderUserList(cards);
      inner.scrollLeft = 0;

      // --- CHAT SWITCH ---
      currentTeam = teamId;
      updateBanner(teamName, teamColor);

      if (window.chatSocket) {
        manualClose = true;
        window.chatSocket.close();
        manualClose = false;
      }
      connectSocket(currentTeam);

      document.querySelector("#chatMessagesContainer").innerHTML = "";
      chatContainer.prepend(banner);
      document.querySelector("#pinnedPreview").innerHTML = "";
      oldestLoaded = null;
      loadMoreMessages();

      // --- Guest controls (Magnet only) ---
      document.querySelectorAll(".guest-controls").forEach(el => {
        el.style.display = isMagnet ? "" : "none";
      });
      closeMobileNavbar();
    });
  });

  // --- Initial render ---
  renderUserList(allCards);

  // Auto-activate initial team if provided
  //if (initialTeamId) {
  //  const initialBtn = document.querySelector(`.team-btn[data-team-id="${initialTeamId}"]`);
  //  if (initialBtn) {
  //    initialBtn.click(); // triggers the same logic as manual click
  //  }
  //}

  const urlParams = new URLSearchParams(window.location.search);
  const teamId = urlParams.get("team_id");
  const guestId = urlParams.get("guest_id");

  // Auto-trigger Magnet chat only when a guest is being attached
  if (guestId && teamId) {
    console.log("🔁 Auto-activating Magnet chat for attached guest:", guestId);

    const magnetBtn = document.querySelector(`.team-btn[data-team-id="${teamId}"]`);
    if (magnetBtn) {
      // Wait a short delay to ensure all chat scripts and sockets are ready
      setTimeout(() => {
        magnetBtn.click();
        console.log("✅ Magnet chat auto-triggered");
      }, 800);
    } else {
      console.warn("⚠️ Magnet team button not found in DOM yet.");
    }
  }


  // --- Assign consistent colors to users based on their ID ---
  function getUserColor(userId) {
    const colors = ["bg-blue-lt text-white","bg-green-lt text-white","bg-orange-lt text-white","bg-purple-lt text-white","bg-pink-lt text-white","bg-cyan-lt text-white","bg-yellow-lt text-white","bg-red-lt text-white","bg-indigo-lt text-white","bg-teal-lt text-white","bg-lime-lt text-white","bg-amber-lt text-white","bg-fuchsia-lt text-white","bg-emerald-lt text-white","bg-violet-lt text-white","bg-rose-lt text-white","bg-sky-lt text-white","bg-orange-200 text-white","bg-purple-200 text-white","bg-pink-200 text-white"];
    return colors[userId % colors.length];
  }

  // --- Utility: escape user-provided strings for RegExp ---
  function escapeRegex(str) {
    if (str == null) return "";
    return String(str).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  // --- Input listener for "@" ---
  // Use users JSON from Django
  const usersList = USERS.map(u => ({
      id: u.id,
      name: u.full_name || u.username,
      title: u.title || "",
      username: u.username,
      image: u.image || null,
      color: (u.color && u.color.trim() !== "") ? u.color : "#00aeff71"
  }));

  // --- Utilities ---
  //function getInputText() {
  //  return chatInput?.value.trim() || "";
  //}

  //function clearInput() {
  //  if (chatInput) chatInput.value = "";
  //}

  let mentions = [];
  let filteredUsers = [];
  let currentSelection = 0;

  // --- Show dropdown above the input ---
  function showMentionDropdown() {
    if (!filteredUsers.length) return hideMentionDropdown();

    mentionDropdown.innerHTML = filteredUsers.map((u, idx) => `
      <div class="mention-item ${idx === currentSelection ? 'active' : ''}" data-id="${u.id}">
        <span class="avatar" style="${u.image ? 'background-image:url(' + u.image + ')' : ''}">
          ${!u.image ? (u.full_name || u.username).slice(0,2).toUpperCase() : ''}
        </span>
        <div class="user-info d-flex">
          <span class="title">${u.title || ''}</span>
          <span class="name">${u.full_name}</span>
        </div>
      </div>
    `).join('');

    mentionDropdown.classList.remove("d-none");
    mentionDropdown.style.display = "block";

    // Position above input
    const parentRect = chatInput.offsetParent.getBoundingClientRect();
    const inputRect = chatInput.getBoundingClientRect();
    const dropdownHeight = mentionDropdown.offsetHeight;
    mentionDropdown.style.left = (inputRect.left - parentRect.left) + "px";
    mentionDropdown.style.top = (inputRect.top - parentRect.top - dropdownHeight - 4) + "px";
    mentionDropdown.style.minWidth = chatInput.offsetWidth + "px";
  }

  function hideMentionDropdown() {
    mentionDropdown.classList.add("d-none");
    mentionDropdown.style.display = "none";
    currentSelection = 0;
  }

  // --- Insert mention into contenteditable ---
  function selectMention(item) {
    const userId = item.dataset.id;
    const user = filteredUsers.find(u => u.id == userId);
    if (!user) return;

    const titlePrefix = user.title ? (user.title + " ") : "";
    const mentionText = `@${titlePrefix}${user.full_name} `;

    const start = chatInput.selectionStart;
    const end = chatInput.selectionEnd;

    // Detect @query before cursor
    const textBeforeCursor = chatInput.value.slice(0, start);
    const match = textBeforeCursor.match(/@([^\s@]*)$/);
    const replaceStart = match ? start - match[0].length : start;

    chatInput.value =
      chatInput.value.slice(0, replaceStart) +
      mentionText +
      chatInput.value.slice(end);

    const newPos = replaceStart + mentionText.length;
    chatInput.setSelectionRange(newPos, newPos);
    hideMentionDropdown();
    chatInput.focus();
  }

  function updateActive() {
    const items = mentionDropdown.querySelectorAll("div[data-id]");
    items.forEach((el, idx) =>
      el.classList.toggle("active", idx === currentSelection)
    );
  }

  // --- Detect mentions on input ---
  chatInput.addEventListener("input", () => {
    autoResizeTextarea(chatInput);

    const cursorPos = chatInput.selectionStart;
    const textBeforeCursor = chatInput.value.slice(0, cursorPos);

    const match = textBeforeCursor.match(/@([^\s@]*)$/);
    if (match) {
      const query = match[1].toLowerCase();
      filteredUsers = USERS.filter((u) => {
        const fullName = (u.full_name || u.username).toLowerCase();
        const title = (u.title || "").toLowerCase();
        return `${title} ${fullName}`.includes(query);
      });
      currentSelection = 0;
      showMentionDropdown();
    } else {
      hideMentionDropdown();
    }
  });

  // --- Keyboard navigation ---
  chatInput.addEventListener("keydown", (e) => {
    const items = mentionDropdown.querySelectorAll("div[data-id]");
    const isDropdownOpen = !mentionDropdown.classList.contains("d-none");

    if (!isDropdownOpen || !items.length) return;

    if (e.key === "ArrowDown") {
      e.preventDefault();
      currentSelection = (currentSelection + 1) % items.length;
      updateActive();
      return;
    }

    if (e.key === "ArrowUp") {
      e.preventDefault();
      currentSelection = (currentSelection - 1 + items.length) % items.length;
      updateActive();
      return;
    }

    if (e.key === "Enter" || e.key === "Tab") {
      e.preventDefault();
      selectMention(items[currentSelection]);
      return; // ✅ stop here, no newline logic
    }

    if (e.key === "Escape") {
      e.preventDefault();
      hideMentionDropdown();
      return;
    }
  });

  // --- Click/tap on mention item ---
  mentionDropdown.addEventListener("mousedown", (e) => {
    // use mousedown so selection isn’t lost before click
    e.preventDefault();
    const item = e.target.closest("div[data-id]");
    if (item) selectMention(item);
  });

  // --- Mobile scroll containment for mention dropdown ---
  mentionDropdown.addEventListener("touchstart", (e) => {
    e.stopPropagation();
  }, { passive: true });

  mentionDropdown.addEventListener("touchmove", (e) => {
    // Allow scrolling within dropdown, but prevent bubbling
    const el = mentionDropdown;
    const scrollTop = el.scrollTop;
    const scrollHeight = el.scrollHeight;
    const height = el.offsetHeight;
    const atTop = scrollTop <= 0;
    const atBottom = scrollTop + height >= scrollHeight;

    const touch = e.touches[0];
    const deltaY = touch.clientY - (el._lastTouchY || touch.clientY);
    el._lastTouchY = touch.clientY;

    // Prevent overscroll from propagating to the chat container
    if ((atTop && deltaY > 0) || (atBottom && deltaY < 0)) {
      e.preventDefault();
    }

    e.stopPropagation();
  }, { passive: false });

  mentionDropdown.addEventListener("touchend", () => {
    delete mentionDropdown._lastTouchY;
  });

  // --- Expose mentions array for sendMessage ---
  //window.getCurrentMentions = () => mentions;
  //window.clearMentions = () => { mentions = []; };


  // Format timestamp to "Sept. 15, 2025 - 11:10"
  function formatForCopy(iso) {
    const d = new Date(iso);
    const months = ["Jan.","Feb.","Mar.","Apr.","May","Jun.","Jul.","Aug.","Sept.","Oct.","Nov.","Dec."];
    const datePart = `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
    const timePart = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
    return `${datePart} - ${timePart}`;
  }

  // Example: when right-clicking a message
  document.querySelectorAll(".chat-message").forEach(msg => {
    msg.addEventListener("contextmenu", e => {
      e.preventDefault();
      const isPinned = msg.dataset.pinned === "true"; // <-- set this when pinning
      updatePinButton(isPinned);
      // show options panel...
    });
  });


  function updateOptionsPanelVisibility() {
    if (selectedBubbles.size > 0) {
      optionsPanel.classList.remove("hidden");
      optionsPanel.setAttribute("aria-hidden", "false");
    } else {
      optionsPanel.classList.add("hidden");
      optionsPanel.setAttribute("aria-hidden", "true");
    }
  }

  // Utility: gather selected bubble DOM nodes
  function getSelectedNodes() {
    return Array.from(selectedBubbles).map(id => document.getElementById(`chat-bubble-${id}`)).filter(Boolean);
  }

  // Toggle selection (highlight) for a single bubble
  function toggleBubbleSelection(bubbleEl, messageId) {
    if (selectedBubbles.has(messageId)) {
      selectedBubbles.delete(messageId);
      bubbleEl.classList.remove("selected");
    } else {
      selectedBubbles.add(messageId);
      bubbleEl.classList.add("selected");
    }
    updateOptionsPanelVisibility();
    // focus input on reply candidate (UX)
    chatInput.focus();
  }

  // Clear all selections
  function clearSelections() {
    getSelectedNodes().forEach(node => node.querySelector(".chat-bubble")?.classList.remove("selected"));
    selectedBubbles.clear();
    updateOptionsPanelVisibility();
  }



  // Render the pinned preview stack
  function renderPinnedPreview() {
    const container = pinnedPreviewContainer;
    if (!container) return;
    container.innerHTML = "";

    pinnedMessages.forEach((msg, index) => {
      const outer = document.createElement("div");
      outer.classList.add("pinned-outer");
      outer.dataset.id = msg.id;

      // Add animation classes
      if (index === 0 && pinnedMessages.length >= 3) {
        outer.classList.add("new-card"); // newest card
      } else if (index === pinnedMessages.length - 1) {
        outer.classList.add("oldest-third"); // oldest third card
      }

      // Pin icon
      const icon = document.createElement("div");
      icon.classList.add("pinned-icon");
      icon.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#f703d7ff" class="bi bi-pin" viewBox="0 0 16 16">
          <path d="M4.146.146A.5.5 0 0 1 4.5 0h7a.5.5 0 0 1 .5.5c0 .68-.342 1.174-.646 1.479-.126.125-.25.224-.354.298v4.431l.078.048c.203.127.476.314.751.555C12.36 7.775 13 8.527 13 9.5a.5.5 0 0 1-.5.5h-4v4.5c0 .276-.224 1.5-.5 1.5s-.5-1.224-.5-1.5V10h-4a.5.5 0 0 1-.5-.5c0-.973.64-1.725 1.17-2.189A6 6 0 0 1 5 6.708V2.277a3 3 0 0 1-.354-.298C4.342 1.674 4 1.179 4 .5a.5.5 0 0 1 .146-.354m1.58 1.408-.002-.001zm-.002-.001.002.001A.5.5 0 0 1 6 2v5a.5.5 0 0 1-.276.447h-.002l-.012.007-.054.03a5 5 0 0 0-.827.58c-.318.278-.585.596-.725.936h7.792c-.14-.34-.407-.658-.725-.936a5 5 0 0 0-.881-.61l-.012-.006h-.002A.5.5 0 0 1 10 7V2a.5.5 0 0 1 .295-.458 1.8 1.8 0 0 0 .351-.271c.08-.08.155-.17.214-.271H5.14q.091.15.214.271a1.8 1.8 0 0 0 .37.282"/>
        </svg>
      `;

      // Pinner info
      const pinner = document.createElement("div");
      pinner.classList.add("pinner");
      if (msg.pinned_by && msg.pinned_by.id === CURRENT_USER_ID) {
        pinner.textContent = "You pinned";
      } else if (msg.pinned_by) {
        pinner.textContent = `${msg.pinned_by.title || ""} ${msg.pinned_by.name} pinned`;
      } else {
        pinner.textContent = "Pinned";
      }

      // Preview bubble
      const preview = document.createElement("div");
      preview.classList.add("pinned-info");
      const senderTitle = msg.original_sender_title || msg.sender_title || "";
      const senderName = msg.original_sender_name || msg.sender_name || "Unknown";
      const sender = `${senderTitle} ${senderName}`.trim();
      let attachmentHTML = "";
      if (msg.guest) {
        const g = msg.guest;
        attachmentHTML = `
          <div class="d-flex align-items-center mt-1" style="gap:4px;">
            ${
              g.image
                ? `<img src="${g.image}" style="width:28px;height:28px;border-radius:4px;object-fit:cover;">`
                : `<span class="avatar bg-gray d-flex align-items-center justify-content-center"
                      style="width:28px;height:28px;border-radius:4px;">${g.name?.[0] || "?"}</span>`
            }
            <span class="small text-warning">${g.title || ""} ${g.name || ""}</span>
          </div>`;
      } else if (msg.file) {
        const f = msg.file;
        const fileType = (f.type || "").toLowerCase();
        const ext = f.name?.split(".").pop()?.toLowerCase() || "";
        const fileUrl = f.display_url || f.url;
        if (fileType.startsWith("image/")) {
          attachmentHTML = `
            <div class="mt-1 d-flex align-items-center gap-2">
              <img src="${fileUrl}" alt="${f.name}"
                  style="width:30px;height:30px;border-radius:4px;object-fit:cover;">
              <span class="small text-secondary text-truncate" style="max-width:120px;">${f.name}</span>
            </div>`;
        } else {
          const icon = getFileIcon(ext, fileType);
          attachmentHTML = `
            <div class="mt-1 d-flex align-items-center gap-2">
              <div class="d-flex align-items-center justify-content-center"
                  style="width:28px;height:28px;background:#1f2937;border-radius:4px;">${icon}</div>
              <span class="small text-secondary text-truncate" style="max-width:120px;">${f.name}</span>
            </div>`;
        }
      } else if (msg.link_preview) {
        const lp = msg.link_preview;
        attachmentHTML = `
          <div class="mt-1 d-flex align-items-center gap-2">
            ${
              lp.image
                ? `<img src="${lp.image}" alt="${lp.title}"
                    style="width:30px;height:30px;border-radius:4px;object-fit:cover;">`
                : `<span class="avatar bg-blue-lt d-flex align-items-center justify-content-center"
                    style="width:30px;height:30px;border-radius:4px;">🌐</span>`
            }
            <div class="d-flex flex-column" style="max-width:130px;">
              <span class="small text-white text-truncate">${lp.title || lp.url}</span>
              <span class="text-muted small text-truncate">${new URL(lp.url).hostname}</span>
            </div>
          </div>`;
      }

      const rawText = msg.message || msg.message_text || "";
      let displayText = rawText;
      let hasNewline = rawText.includes("\n");
      let firstLine = rawText.split("\n")[0];

      // If there’s a newline, decide whether to show enter icon or truncate
      if (hasNewline) {
        displayText = firstLine; // always keep first line
      }

      // Create span HTML
      let newlineIndicator = "";
      if (hasNewline) {
        newlineIndicator = "...";
      }

      preview.innerHTML = `
        <small class="text-secondary">${sender}</small><br>
        <span class="reply-preview-text small text-muted" 
              style="display:block;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
              ${displayText}${newlineIndicator}
        </span>
        ${attachmentHTML}
      `;

      // Click-to-scroll
      preview.addEventListener("click", () => {
        scrollToMessage(msg.id, "highlight-pinned");
      });

      outer.appendChild(icon);
      outer.appendChild(pinner);
      outer.appendChild(preview);
      container.appendChild(outer);
    });
  }

  // Add or update a pinned message in FIFO (max 3)
  function addPinnedMessage(msg) {
    // Check for duplicates
    const exists = pinnedMessages.find(m => String(m.id) === String(msg.id));
    if (exists) return;

    // Enforce 14-day expiry if pinned_at exists
    if (msg.pinned_at) {
      const pinnedAt = new Date(msg.pinned_at);
      if (isNaN(pinnedAt.getTime()) || (Date.now() - pinnedAt.getTime()) > 14 * 24 * 60 * 60 * 1000) return;
    }

    // Keep max 3, FIFO
    if (pinnedMessages.length >= 3) {
      pinnedMessages.shift();
    }

    pinnedMessages.push(msg);
    renderPinnedPreview();
  }

  // Remove a message from preview
  function removePinnedMessage(id) {
    const idx = pinnedMessages.findIndex(m => String(m.id) === String(id));
    if (idx !== -1) {
      pinnedMessages.splice(idx, 1);
      renderPinnedPreview();
    }
  }

  document.getElementById("pinBtn").addEventListener("click", () => {
    if (!selectedBubbles.size) return;

    const ids = Array.from(selectedBubbles);

    // ✅ Just tell the server
    chatSocket.send(JSON.stringify({
      action: "pin",
      message_ids: ids,
      sender_id: CURRENT_USER_ID
    }));

    clearSelections();
  });

  // Scroll to specific message by ID, loading more if needed
  async function scrollToMessage(msgId, highlightClass = "highlight-pinned") {
    let target = document.getElementById(`chat-bubble-${msgId}`);

    while (!target) {
      if (!oldestLoaded) break;
      await loadMoreMessages();
      target = document.getElementById(`chat-bubble-${msgId}`);
    }

    if (!target) return;

    const bubble = target.querySelector(".chat-bubble") || target;
    const siblings = Array.from(chatContainer.querySelectorAll(".chat-item"));
    const index = siblings.indexOf(target);

    const containerRect = chatContainer.getBoundingClientRect();
    const targetRect = target.getBoundingClientRect();

    let jumpTarget = target; // default: no jump

    // Only jump if target is outside the current viewport
    if (targetRect.bottom > containerRect.bottom) {
      // jump to a few bubbles above, but not if it's already below current scroll
      const jumpIndex = Math.max(index - 1, 0);
      jumpTarget = siblings[jumpIndex];
    } else if (targetRect.top < containerRect.top) {
      // jump to a few bubbles below, if target is above viewport
      const jumpIndex = Math.min(index + 1, siblings.length - 1);
      jumpTarget = siblings[jumpIndex];
    }

    // 1️⃣ Jump instantly to the intermediate position
    jumpTarget.scrollIntoView({ behavior: "auto", block: "center" });

    // 2️⃣ Smooth scroll the target into view immediately
    bubble.scrollIntoView({ behavior: "smooth", block: "center" });

    // 3️⃣ Highlight
    bubble.classList.add(highlightClass);
    setTimeout(() => bubble.classList.remove(highlightClass), 5000);
  }






  // Guest Date of Visit Formatting
  function formatGuestDate(dateStr) {
    if (!dateStr) return "";
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateStr).toLocaleDateString(undefined, options);
  }

  // --- Safe Date Parser ---
  function safeParseDate(isoString) {
    if (!isoString) return null;
    // Strip microseconds like .123456
    const cleaned = isoString.replace(/\.\d+/, "");
    const d = new Date(cleaned);
    return isNaN(d.getTime()) ? null : d;
  }

  // --- Update getDateText to use safe date ---
  function getDateText(date) {
    if (!date) return "";
    const now = new Date();
    const msgDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);

    if (msgDay.getTime() === today.getTime()) return "Today";
    if (msgDay.getTime() === yesterday.getTime()) return "Yesterday";

    const diffTime = today.getTime() - msgDay.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    if (diffDays < 7) return msgDay.toLocaleDateString(undefined, { weekday: "long" });

    return msgDay.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
  }

  // Attach from Guest list to Chat handler
  document.querySelectorAll(".attach-to-chat").forEach(item => {
    item.addEventListener("click", (e) => {
      e.preventDefault();
      
      let guest = JSON.parse(e.currentTarget.getAttribute("data-guest"));

      // 🔹 ALWAYS populate assigned_user from your arrays
      const matchedGuest =
        USER_GUESTS.find(g => g.id === guest.id) ||
        UNASSIGNED_GUESTS.find(g => g.id === guest.id);

      guest.assigned_user = matchedGuest?.assigned_user || null;

      createGuestPreview(guest);
      chatInput.focus();
      chatInput.scrollIntoView({ behavior: "smooth", block: "center" });
    });
  });


  // 🔹 File type icons
  function getFileIcon(ext, type) {
    const size = 128; // bigger icons for visibility
    const commonAttrs = `xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" 
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" 
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon icon-tabler"`;

    // Define colors per file type
    const colors = {
      pdf: "#E03E3E",      // red
      doc: "#2B579A",      // blue
      xls: "#217346",      // green
      ppt: "#D24726",      // orange
      archive: "#8B5CF6",  // purple
      generic: "#f8fafc"   // fallback light gray
    };

    const extLower = ext.toLowerCase();

    // PDF
    if (extLower === "pdf" || type.includes("pdf")) return `
      <svg ${commonAttrs} style="color:${colors.pdf};">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <path d="M14 3v4a1 1 0 0 0 1 1h4" />
        <path d="M5 12v-7a2 2 0 0 1 2 -2h7l5 5v4" />
        <path d="M5 18h1.5a1.5 1.5 0 0 0 0 -3h-1.5v6" />
        <path d="M17 18h2" /><path d="M20 15h-3v6" />
        <path d="M11 15v6h1a2 2 0 0 0 2 -2v-2a2 2 0 0 0 -2 -2h-1z" />
      </svg>`;

    // Word
    if (["doc", "docx"].includes(extLower)) return `
      <svg ${commonAttrs} style="color:${colors.doc};">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <path d="M14 3v4a1 1 0 0 0 1 1h4" />
        <path d="M5 12v-7a2 2 0 0 1 2 -2h7l5 5v4" />
        <path d="M5 15v6h1a2 2 0 0 0 2 -2v-2a2 2 0 0 0 -2 -2h-1z" />
        <path d="M20 16.5a1.5 1.5 0 0 0 -3 0v3a1.5 1.5 0 0 0 3 0" />
        <path d="M12.5 15a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1 -3 0v-3a1.5 1.5 0 0 1 1.5 -1.5z" />
      </svg>`;

    // Excel / CSV
    if (["xls", "xlsx", "csv"].includes(extLower)) return `
      <svg ${commonAttrs} style="color:${colors.xls};">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <path d="M14 3v4a1 1 0 0 0 1 1h4" />
        <path d="M5 12v-7a2 2 0 0 1 2 -2h7l5 5v4" />
        <path d="M4 15l4 6" /><path d="M4 21l4 -6" />
        <path d="M17 20.25c0 .414 .336 .75 .75 .75h1.25a1 1 0 0 0 1 -1v-1a1 1 0 0 0 -1 -1h-1
              a1 1 0 0 1 -1 -1v-1a1 1 0 0 1 1 -1h1.25a.75 .75 0 0 1 .75 .75" />
        <path d="M11 15v6h3" />
      </svg>`;

    // PowerPoint
    if (["ppt", "pptx"].includes(extLower)) return `
      <svg ${commonAttrs} style="color:${colors.ppt};">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <path d="M14 3v4a1 1 0 0 0 1 1h4" />
        <path d="M5 18h1.5a1.5 1.5 0 0 0 0 -3h-1.5v6" />
        <path d="M11 18h1.5a1.5 1.5 0 0 0 0 -3h-1.5v6" />
        <path d="M16.5 15h3" /><path d="M18 15v6" />
        <path d="M5 12v-7a2 2 0 0 1 2 -2h7l5 5v4" />
      </svg>`;

    // Archives / ZIP / RAR
    if (["zip", "rar", "7z", "tar", "gz"].includes(extLower)) return `
      <svg ${commonAttrs} style="color:${colors.archive};">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <path d="M14 3v4a1 1 0 0 0 1 1h4" />
        <path d="M5 12v-7a2 2 0 0 1 2 -2h7l5 5v4" />
        <path d="M16 18h1.5a1.5 1.5 0 0 0 0 -3h-1.5v6" />
        <path d="M12 15v6" /><path d="M5 15h3l-3 6h3" />
      </svg>`;

    // Generic fallback
    return `
      <svg ${commonAttrs} style="color:${colors.generic};" fill="currentColor" class="icon-tabler icon-tabler-file">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <path d="M12 2l.117 .007a1 1 0 0 1 .876 .876l.007 .117v4l.005 .15a2 2 0 0 0 
                1.838 1.844l.157 .006h4l.117 .007a1 1 0 0 1 .876 .876l.007 .117v9
                a3 3 0 0 1 -2.824 2.995l-.176 .005h-10a3 3 0 0 1 -2.995 -2.824
                l-.005 -.176v-14a3 3 0 0 1 2.824 -2.995l.176 -.005h5z" />
        <path d="M19 7h-4l-.001 -4.001z" />
      </svg>`;
  }


  //File Attachment Preview
  let selectedFile = null;

  document.getElementById("attachFileBtn").addEventListener("click", () => {
    document.getElementById("fileInput").click();
  });

  document.getElementById("fileInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    createFilePreview(file);
    chatInput.focus();
    chatInput.scrollIntoView({ behavior: "smooth", block: "center" });
  });

  function createFilePreview(file) {
    removeFilePreview();
    selectedFile = file;

    const preview = document.createElement("div");
    preview.id = "filePreview";
    preview.classList.add(
      "d-flex","align-items-center","text-white",
      "border-0","p-2","mb-2","rounded-2","bg-gray-900"
    );
    preview.style.boxShadow = "0 4px 8px #0000004d";

    const type = (file.type || "").toLowerCase();
    const ext = file.name.split(".").pop().toLowerCase();
    let thumb = "";

    if (type.startsWith("image/")) {
      thumb = `<img src="${URL.createObjectURL(file)}"
                    style="max-width:60px; max-height:60px; object-fit:cover; border-radius:4px; margin-right:10px;">`;
    } else if (type.startsWith("video/")) {
      thumb = `<video src="${URL.createObjectURL(file)}"
                      style="max-width:60px; max-height:60px; border-radius:4px; margin-right:10px;" muted></video>`;
    } else if (type.startsWith("audio/")) {
      thumb = `<audio src="${URL.createObjectURL(file)}"
                      style="width:120px; margin-right:10px;" controls></audio>`;
    } else {
      // ✅ use your new icon function for docs/zip/etc
      thumb = `<div style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;
                          background:#1f2937;border-radius:6px;margin-right:10px;">
                ${getFileIcon(ext, type)}
              </div>`;
    }

    preview.innerHTML = `
      ${thumb}
      <div class="flex-grow-1 overflow-hidden">
        <strong class="text-white text-truncate d-block" style="max-width:160px;">${file.name}</strong>
        <small class="text-muted">${(file.size / 1024).toFixed(1)} KB</small>
      </div>
      <span id="cancelFilePreview" class="text-red ms-2"
              style="background:none;border:none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
            viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="icon icon-tabler icon-tabler-x">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M18 6l-12 12" /><path d="M6 6l12 12" />
        </svg>
      </span>
    `;

    document.getElementById("guestPreviewContainer").appendChild(preview);

    document.getElementById("cancelFilePreview").addEventListener("click", removeFilePreview);
    adjustPreviewPositions();
  }

  function removeFilePreview() {
    const preview = document.getElementById("filePreview");
    if (preview) preview.remove();
    selectedFile = null;
  }

  //Link Preview
  let selectedLinkPreview = null;
  let linkPreviewTimeout = null;

  // Listen to chat input
  chatInput.addEventListener("input", () => {
    clearTimeout(linkPreviewTimeout);
    linkPreviewTimeout = setTimeout(() => {
      // use innerText instead of value for contenteditable
      const text = (chatInput.value || "").trim();
      const firstWord = text.split(/\s+/)[0] || "";
      const url = extractURLIfFirstWord(firstWord);

      if (url) {
        // Only fetch if the first link changed
        if (!selectedLinkPreview || selectedLinkPreview.url !== url) {
          fetchLinkPreview(url);
        }
      } else {
        removeLinkPreview();
      }
    }, 300); // debounce 300ms
  });

  // Extract URL only if it is the first word
  function extractURLIfFirstWord(text) {
    if (!text) return null;

    // Regex matches http(s), www, or bare domains with optional port/path
    const urlRegex = /^(https?:\/\/[^\s]+|www\.[^\s]+|[\w.-]+\.[a-z]{2,}(?::\d+)?(?:\/[^\s]*)?)$/i;
    const match = text.match(urlRegex);
    if (!match || !match[0]) return null;

    let url = match[0];
    if (!/^https?:\/\//i.test(url)) url = "https://" + url; // prepend https if missing
    return url;
  }

  // Fetch link preview
  async function fetchLinkPreview(url) {
    try {
      const res = await fetch(`/fetch_link_preview/?url=${encodeURIComponent(url)}`);
      const data = await res.json();
      if (res.ok && data.title) {
        selectedLinkPreview = data;
        createLinkPreview(data);
      }
    } catch (err) {
      console.error("Link preview fetch failed:", err);
    }
  }

  // Render the preview (same as before)
  function createLinkPreview(previewData) {
    removeLinkPreview();
    selectedLinkPreview = previewData;

    const preview = document.createElement("div");
    preview.id = "linkPreview";
    preview.classList.add(
      "d-flex",
      "align-items-center",
      "text-white",
      "border-0",
      "p-2",
      "mb-2",
      "rounded-2",
      "bg-gray-900"
    );
    preview.style.cssText = `
      width: 100%;
      max-width: 100%;
      overflow: hidden;
      box-shadow: 0 4px 8px #0000004d;
    `;

    const imgHTML = previewData.image
      ? `<img src="${previewData.image}" style="width:60px;height:60px;border-radius:4px;object-fit:cover;margin-right:10px;flex-shrink:0;">`
      : `<span class="avatar bg-blue-lt d-flex align-items-center justify-content-center"
                style="width:60px;height:60px;border-radius:4px;margin-right:10px;flex-shrink:0;">🌐</span>`;

    preview.innerHTML = `
      ${imgHTML}
      <div class="flex-grow-1 d-flex flex-column" style="min-width:0; max-width:100%;">
        <div
          class="fw-bold text-white"
          style="
            display:-webkit-box;
            -webkit-line-clamp:2;
            -webkit-box-orient:vertical;
            overflow:hidden;
            text-overflow:ellipsis;
            word-break:break-word;
            width:100%;
            min-width:0;
            line-height:1.2em;
            max-height:2.4em;
            font-size:0.95rem;
          "
          title="${previewData.title}">
          ${previewData.title}
        </div>
        <div
          class="text-muted small"
          style="
            display:-webkit-box;
            -webkit-line-clamp:2;
            -webkit-box-orient:vertical;
            overflow:hidden;
            text-overflow:ellipsis;
            word-break:break-word;
          ">
          ${previewData.description || ""}
        </div>
        <div class="text-secondary small">${new URL(previewData.url).hostname}</div>
      </div>
      <span id="cancelLinkPreview"
            class="avatar text-red p-0 border-0 d-flex align-items-center justify-content-center"
            style="width:24px; height:24px; cursor:pointer; flex-shrink:0;">
        ✖
      </span>
    `;

    document.getElementById("guestPreviewContainer").appendChild(preview);
    document
      .getElementById("cancelLinkPreview")
      .addEventListener("click", removeLinkPreview);

    adjustPreviewPositions();
  }

  function removeLinkPreview() {
    const preview = document.getElementById("linkPreview");
    if (preview) preview.remove();
    selectedLinkPreview = null;
  }

  // Preview Position
  function adjustPreviewPositions() {
    const reply = document.getElementById("replyPreview");
    const guest = document.getElementById("guestPreview");

    if (reply && !reply.classList.contains("d-none")) {
      const guestHeight = guest ? guest.offsetHeight + 6 : 0;
      reply.style.bottom = `calc(100% + ${guestHeight}px)`;
    }
    if (guest) {
      guest.style.bottom = "100%";
    }
  }

  // Reply preview HTML (used for both reply bar + inside bubbles)
  function createReplyPreviewHTML(data, inBubble = false) {
    let replyOwner = "";

    if (data.parent) {
      replyOwner =
        data.parent.sender_id === CURRENT_USER_ID
          ? "You"
          : `${data.parent.sender_title || ""} ${data.parent.sender_name || ""}`;
    }

    // --- Build attachment preview depending on parent type ---
    let attachmentPreview = "";

    if (data.parent.guest) {
      // 🧍 Guest mini preview
      const g = data.parent.guest;
      attachmentPreview = `
        <div class="d-flex align-items-center mt-1">
          ${
            g.image
              ? `<img src="${g.image}" style="width:35px;height:35px;border-radius:4px;object-fit:cover;">`
              : `<span class="avatar bg-gray d-flex align-items-center justify-content-center"
                    style="width:35px;height:35px;border-radius:10px;">${g.name?.[0] || "?"}</span>`
          }
          <span class="ms-2 text-warning">${g.title || ""} ${g.name || ""}</span>
        </div>`;
    }

    else if (data.parent.file) {
      // 📎 File mini preview (non-clickable)
      const f = data.parent.file;
      const type = (f.type || "").toLowerCase();
      const ext = f.name?.split(".").pop()?.toLowerCase() || "";
      const fileUrl = f.display_url || f.url;

      if (type.startsWith("image/")) {
        attachmentPreview = `
          <div class="mt-1 d-flex align-items-center gap-2">
            <img src="${fileUrl}" alt="${f.name}" 
                style="width:45px;height:45px;object-fit:cover;border-radius:10px;">
            <span class="small text-secondary text-truncate" style="max-width:120px;">${f.name}</span>
          </div>`;
      } else {
        const icon = getFileIcon(ext, type);
        attachmentPreview = `
          <div class="mt-1 d-flex align-items-center gap-2">
            <div class="d-flex align-items-center justify-content-center"
                style="width:35px;height:35px;background:#1f2937;border-radius:10px;">
              ${icon}
            </div>
            <span class="small text-secondary text-truncate" style="max-width:120px;">${f.name}</span>
          </div>`;
      }
    }

    else if (data.parent.link_preview) {
      // 🔗 Link mini preview (non-clickable)
      const lp = data.parent.link_preview;
      attachmentPreview = `
        <div class="mt-1 d-flex align-items-center gap-2">
          ${
            lp.image
              ? `<img src="${lp.image}" alt="${lp.title}" 
                    style="width:40px;height:40px;border-radius:10px;object-fit:cover;">`
              : `<span class="avatar bg-blue-lt d-flex align-items-center justify-content-center"
                    style="width:40px;height:40px;border-radius:10px;">🌐</span>`
          }
          <div class="d-flex flex-column" style="max-width:140px;">
            <span class="small text-white text-truncate">${lp.title || lp.url}</span>
            <span class="text-muted small text-truncate">${new URL(lp.url).hostname}</span>
          </div>
        </div>`;
    }

    const innerHTML = data.parent
      ? `
        <small style="color: inherit;">${replyOwner}</small><br>
        <span class="reply-preview-text text-secondary">
          ${data.parent.message || ""}
        </span>
        ${attachmentPreview}
      `
      : "";

    // Wrap only when used in a chat bubble
    return inBubble
      ? `<div class="chat-reply-preview fs-7 mb-1 p-1"
                data-parent-id="${data.parent.id}"
                style="border-radius:10px; cursor:pointer; background: #111827;
                      border-left:4px solid #018f14ff; width:auto;
                      box-shadow: 0 4px 8px #0000004d;">
            ${innerHTML}
        </div>`
      : innerHTML;
  }

  // --- helper: pop animation ---
  function animateReplyPop(el) {
    el.animate(
      [
        { transform: "scale(1)", boxShadow: "0 0 0 rgba(0,255,120,0)" },
        { transform: "scale(1.2)", boxShadow: "0 0 12px rgba(0,255,120,0.6)" },
        { transform: "scale(1)", boxShadow: "0 0 0 rgba(0,255,120,0)" }
      ],
      { duration: 500, easing: "ease-out" }
    );
    if (navigator.vibrate) navigator.vibrate(25);
  }

  // Chat Bubble Text Formatting
  function formatMessage(text) {
    if (!text) return "";  // <-- prevent null/undefined errors

    let formatted = text
      .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
      .replace(/\*(.*?)\*/g, "<i>$1</i>")
      .replace(/_(.*?)_/g, "<u>$1</u>")
      .replace(/==(.+?)==/g, '<span class="highlight">$1</span>');

    const lines = formatted.split(/\n/);
    const processed = lines.map((line) => {
      // preserve all leading spaces
      const leadingSpaces = line.match(/^(\s*)/)[1].replace(/ /g, "&nbsp;");
      const content = line.trimStart(); // remove only leading spaces for content formatting

      if (/^\d+\.\s/.test(line.trimStart())) {
        return `<div class="numbered-line">${leadingSpaces}${content}</div>`;
      } else if (/^[a-z]\.\s/.test(line.trimStart())) {
        return `<div class="nested-line">${leadingSpaces}${content}</div>`;
      }
      return `<div>${leadingSpaces}${line.trimStart()}</div>`;
    });

    return processed.join("");
  }

  // Enhanced linkify for chat text
  function linkify(text) {
    if (!text) return "";

    const urlRegex = /\b(https?:\/\/[^\s]+|www\.[^\s]+|[\w.-]+\.[a-z]{2,}(?::\d+)?(?:\/[^\s]*)?)\b/gi;

    return text.replace(urlRegex, (match) => {
      let url = match;
      if (!/^https?:\/\//i.test(url)) url = "https://" + url;

      try {
        const parsed = new URL(url);
        const display = parsed.hostname.replace(/^www\./, "");
        return `<a href="${url}" target="_blank" rel="noopener noreferrer" 
                  class="text-cyan text-decoration-none">${display}</a>`;
      } catch {
        return match;
      }
    });
  }


  // Render Message
  function renderMessage(data, isPrepend = false) {
    //console.log("Incoming message:", data);
    const isMe = data.sender_id === CURRENT_USER_ID;

    const replyHTML = data.parent ? createReplyPreviewHTML({ parent: data.parent }, true) : "";

    const bubbleColorClass = isMe ? "bg-green-lt text-white" : data.color;

    const bubble = document.createElement("div");
    bubble.dataset.createdAt = data.created_at;
    bubble.classList.add("chat-item");
    bubble.id = `chat-bubble-${data.id}`;
    bubble.dataset.senderId = data.sender_id;   // 🔥 needed for edit check
    bubble.dataset.color = data.color || "";   // helpful for reply handler
    bubble.dataset.guest = data.guest ? JSON.stringify(data.guest) : "";
    bubble.dataset.file = data.file ? JSON.stringify(data.file) : "";
    bubble.dataset.linkPreview = data.link_preview ? JSON.stringify(data.link_preview) : "";
    //bubble.dataset.edited = data.edited ? "true" : "false"; // if already edited

    let guestHTML = "";
    if (data.guest) {
      bubble.dataset.guest = JSON.stringify(data.guest);
      const formattedGuestDate = formatGuestDate(data.guest.date_of_visit);

      // Check if guest has an assigned user
      const assignedUser = data.guest.assigned_user; // make sure your guest object includes assigned user
      //if (assignedUser) {
      //  console.log("Assigned:", assignedUser.full_name);
      //} else {
      //  console.log("No assigned user");
      //}
      let assignedHTML = "";
      if (assignedUser) {
        assignedHTML = `
          <div class="assigned-user d-flex align-items-center gap-2">
            <div class="avatar rounded"
                style="width:32px; height:32px; background-color: #11182781; overflow:hidden; 
                        display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 8px #000000a1;"">
              ${assignedUser.image
                  ? `<img src="${assignedUser.image}" alt="${assignedUser.full_name}" style="width:100%; height:100%; object-fit:cover;">`
                  : `${assignedUser.full_name ? assignedUser.full_name[0].toUpperCase() : "?"}`}
            </div>
            <span class="text-white small">${assignedUser.title || ''} ${assignedUser.full_name}</span>
          </div>
        `;
      }

      guestHTML = `
        <div class="chat-guest-card text-white text-center px-2 py-2 mb-2 d-flex flex-column align-items-center gap-2"
            style="border-radius: 10px; max-width: 250px; box-shadow: 0 4px 8px #000000a1; background-color: #11182781;">

          ${data.guest.image
            ? `<img src="${data.guest.image}" alt="${data.guest.name}" 
                    style="width:200px; height:200px; object-fit:cover; border-radius:10px;
                    box-shadow: 0 4px 8px #000000a1; cursor:pointer;"
                    data-bs-toggle="modal" data-bs-target="#previewModal${data.guest.id}">`
            : `<div class="avatar bg-gray d-flex align-items-center justify-content-center fs-2 fw-bold"
                  style="width:200px; height:200px; border-radius:10px;
                  box-shadow: 0 4px 8px #000000a1;">
                ${data.guest.name ? data.guest.name[0].toUpperCase() : "?"}
              </div>`}

          <div class="text-center mt-1">
            <div class="fw-bold fs-3 text-warning"
                style="max-width: 200px;word-break: break-word;">
              ${data.guest.title} ${data.guest.name}
            </div>
            <div class="text-muted">${data.guest.custom_id}</div>
            <div>${formattedGuestDate}</div>
          </div>
          ${assignedHTML}
        </div>

        <!-- Bootstrap Modal -->
        <div class="modal modal-md modal-blur fade" id="previewModal${data.guest.id}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 text-white pb-0"
                  style="border-radius: 24px !important; box-shadow: 0 4px 8px #000000f3;">
              <div class="modal-header" style="border-bottom: none;">
                <h5 class="modal-title text-warning text-center">${data.guest.title || ""} ${data.guest.name}</h5>
                <button class="btn-animate-icon btn-animate-icon-rotate ms-auto border-0" data-bs-dismiss="modal" style="background: none !important;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff0000ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-x">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M18 6l-12 12" /><path d="M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <div class="modal-body text-center p-4">
                ${data.guest.image
                  ? `<img src="${data.guest.image}" class="img-fluid" 
                          alt="${data.guest.title || ""} ${data.guest.name}"
                          style="border-radius: 20px !important; box-shadow: 0 4px 8px #000000f3;">`
                  : `<div class="bg-gray p-5 d-inline-block"
                          style="border-radius: 20px !important; box-shadow: 0 4px 8px #000000f3;">
                      <span class="fw-bold display-4">${data.guest.name ? data.guest.name[0].toUpperCase() : "?"}</span>
                    </div>`}
              </div>
            </div>
          </div>
        </div>
      `;

    }

    // Render FIle Attachment <div class="mt-1 small text-muted text-center" 
                  //style="max-width: 200px; white-space: pre-wrap; word-break: break-word;">${name} · ${sizeText}</div>
    function renderFilePreview(file) {
      if (!file) return "";

      const name = file.name || file.original_name || "file";
      const type = (file.type || "").toLowerCase();
      const ext = name.includes(".") ? name.split(".").pop().toLowerCase() : "";
      const sizeText = file.size ? `${(file.size/1024).toFixed(1)} KB` : "";
      const fileUrl = file.display_url || file.url;

      if (type.startsWith("image/")) {
        return `
          <div class="chat-file-card text-white px-2 py-2 mb-2 rounded-2 d-flex flex-column align-items-center gap-2"
              style="box-shadow: 0 4px 8px #000000a1; background-color: #11182781;">
            <a href="${file.url}" target="_blank">
              <img src="${file.url}" alt="${name}"
                  style="max-width:200px; max-height:200px; object-fit:cover; border-radius:6px;">
            </a>
          </div>`;
      }

      if (type.startsWith("video/")) {
        return `
          <div class="chat-file-card text-white px-2 py-2 mb-2 rounded-2 d-flex flex-column align-items-center gap-2"
              style="box-shadow: 0 4px 8px #000000a1; background-color: #11182781;">
            <div class="chat-file-card mb-2">
              <video src="${file.url}" controls
                    style="max-width:200px; max-height:150px; border-radius:6px;"></video>
            </div>
          </div>`;
      }

      if (type.startsWith("audio/")) {
        return `
          <div class="chat-file-card text-white px-2 py-2 mb-2 rounded-2 d-flex flex-column align-items-center gap-2"
              style="box-shadow: 0 4px 8px #000000a1; background-color: #11182781;">
            <div class="chat-file-card mb-2">
              <audio src="${file.url}" controls style="width:200px;"></audio>
            </div>
          </div>`;
      }

      if (ext === "pdf") {
        const icon = getFileIcon(ext, type);
        return `
          <div class="chat-file-card text-white px-2 py-2 mb-2 rounded-2 d-flex flex-column align-items-center gap-2"
                style="box-shadow: 0 4px 8px #000000a1; background-color: #11182781;">
            <a href="${fileUrl}" target="_blank" class="text-center" 
                style="text-decoration:none; max-width:200px; max-height:200px; object-fit:cover; border-radius:6px;">
              ${icon}
              <div class="small text-white mt-1">${ext.toUpperCase()}</div>
            </a>
          </div>`;
      }

      // Generic doc / zip / etc with icon
      const icon = getFileIcon(ext, type);
      return `
        <div class="chat-file-card text-white px-2 py-2 mb-2 rounded-2 d-flex flex-column align-items-center gap-2"
              style="box-shadow: 0 4px 8px #000000a1; background-color: #11182781;">
          <a href="${file.url}" target="_blank" class="text-center" 
              style="text-decoration:none; max-width:200px; max-height:200px; object-fit:cover; border-radius:6px;">
            ${icon}  
            <div class="small text-white">${ext.toUpperCase()}</div>
          </a>         
        </div>`;
    }
    let fileHTML = data.file ? renderFilePreview(data.file) : "";

    // Render Link
    let linkHTML = "";
    if (data.link_preview) {
      const lp = data.link_preview;
      linkHTML = `
        <a href="${lp.url}" target="_blank" rel="noopener noreferrer"
          class="chat-link-card text-white text-decoration-none px-2 py-2 mb-2 rounded-2 d-flex align-items-center gap-2"
          style="box-shadow:0 4px 8px #000000a1; background-color: #11182781; max-width:100%; overflow:hidden;">
          
          ${lp.image
            ? `<img src="${lp.image}" style="flex-shrink:0; width:60px; height:60px; border-radius:4px; object-fit:cover;">`
            : `<span class="avatar bg-blue-lt d-flex align-items-center justify-content-center"
                      style="flex-shrink:0; width:60px; height:60px; border-radius:4px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-link">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 15l6 -6" />
                    <path d="M11 6l.463 -.536a5 5 0 0 1 7.071 7.072l-.534 .464" />
                    <path d="M13 18l-.397 .534a5.068 5.068 0 0 1 -7.127 0a4.972 4.972 0 0 1 0 -7.071l.524 -.463" />
                  </svg>
                </span>`}
          
          <div class="flex-grow-1 overflow-hidden" style="max-width:100%;">
            <div class="fw-bold text-white text-truncate" 
                style="display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" 
                title="${lp.title}">
              ${lp.title}
            </div>
            <div class="text-muted small" 
                style="display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; word-break:break-word;">
              ${lp.description || ''}
            </div>
            <div class="text-secondary small text-truncate" style="overflow:hidden; text-overflow:ellipsis;">
              ${new URL(lp.url).hostname}
            </div>
          </div>
        </a>
      `;
    }

    const avatarHTML = data.sender_image
      ? `<span class="avatar rounded" style="background-image:url('${data.sender_image}'); width:20px; height:20px; background-size:cover; background-position:center;"></span>`
      : `<span class="avatar ${data.color || ''} d-flex align-items-center justify-content-center border-0 rounded"
            style="width:20px; height:20px; font-weight:normal; border-radius:8px">
          ${
            data.sender_name
              ? (data.sender_name.split(" ").map(n => n[0])[0] || data.sender_name[0])
              : "?" // fallback placeholder
          }
        </span>`;

    let formattedMsg = formatMessage(data.message || "");
    formattedMsg = renderMessageWithMentions(formattedMsg, data.mentions);
    const messageHTML = linkify(formattedMsg);
    bubble.innerHTML = `
      <div class="d-flex align-items-end ${isMe ? "justify-content-end" : ""}">
        ${!isMe ? `<div class="me-1" style="bottom: 10px;">${avatarHTML}</div>` : ""}
        <div class="chat-bubble m-0 pt-1 ${isMe ? 'chat-bubble-me' : ""} ${bubbleColorClass}"
            style="box-shadow: 0 4px 8px #000000d2; display: flex; flex-direction: column;
                    align-items: stretch; cursor: pointer; max-width: 75%; width: fit-content;">
          ${!isMe ? `
            <div class="chat-bubble-title mb-1" style="font-size: 0.75rem;">
              <small><i class="chat-bubble-author" style="color: inherit;">
                ${data.sender_title || ""} ${data.sender_name}
              </i></small>
            </div>` : ""}
          <div class="chat-bubble-body" style="display: block; gap: 0.5rem; padding: 0;">
            ${replyHTML}
            ${guestHTML}
            ${fileHTML}
            ${linkHTML}

            ${data.message?.trim() ? `<div class="message-row" style="display: block; margin: 0;">
              <div class="fs-4 text-white"
                  style="white-space: pre-wrap; word-break: break-word; margin:0; padding:0;">${messageHTML}</div></div>` : ""}
            <div style="display:flex; justify-content:flex-end; width:100%;">
              <small class="chat-bubble-date text-muted me-1 mb-1"
                    style="white-space: nowrap; font-size: 0.5rem;" 
                    data-full-date="${data.created_at}">
                ${new Date(data.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}
              </small>
            </div>
            <div class="chat-bubble-flags"></div>
          </div>
        </div>
      </div>
    `;

    //📌 Add flags if pinned/mentioned
    const flags = bubble.querySelector(".chat-bubble-flags");
      if (data.pinned) {
        const pin = document.createElement("span");
        pin.classList.add("pin-flag");
        pin.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="#f703d7ff" class="bi bi-pin-angle-fill" viewBox="0 0 16 16">
            <path d="M9.828.722a.5.5 0 0 1 .354.146l4.95 4.95a.5.5 0 0 1 0 .707c-.48.48-1.072.588-1.503.588-.177 0-.335-.018-.46-.039l-3.134 3.134a6 6 0 0 1 .16 1.013c.046.702-.032 1.687-.72 2.375a.5.5 0 0 1-.707 0l-2.829-2.828-3.182 3.182c-.195.195-1.219.902-1.414.707s.512-1.22.707-1.414l3.182-3.182-2.828-2.829a.5.5 0 0 1 0-.707c.688-.688 1.673-.767 2.375-.72a6 6 0 0 1 1.013.16l3.134-3.133a3 3 0 0 1-.04-.461c0-.43.108-1.022.589-1.503a.5.5 0 0 1 .353-.146"/>
          </svg>`;
        flags.appendChild(pin);
      }
      if (data.mentions && data.mentions.some(m => parseInt(m.id) === CURRENT_USER_ID)) {
        const flag = document.createElement("span");
        flag.classList.add("mention-flag");
        flag.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" 
              fill="none" stroke="currentColor" stroke-width="2" 
              stroke-linecap="round" stroke-linejoin="round" 
              class="icon icon-tabler icons-tabler-outline icon-tabler-at bounce-flag" style="width:14px; height:14px;">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
            <path d="M16 12v1.5a2.5 2.5 0 0 0 5 0v-1.5a9 9 0 1 0 -5.5 8.28" />
          </svg>`;
        flags.appendChild(flag);
      }

    // Set message text and preserve newlines
    //const msgDiv = bubble.querySelector(".fs-3");
    //msgDiv.style.whiteSpace = "pre-wrap"; // preserves \n
    //msgDiv.textContent = data.message;

    // 🔥 Update last message preview in user list (left column)
    const lastMsgEl = document.getElementById(`last-message-${data.sender_id}`);
    if (lastMsgEl) {
      let preview = data.message && data.message.trim() ? data.message : "(Attachment)";
      if (preview.length > 28) preview = preview.slice(0, 28) + "…";
      lastMsgEl.textContent = preview;
    }


    // ---------- selection handlers ----------
    const chatBubbleEl = bubble.querySelector(".chat-bubble");

    // Desktop: right-click opens selection/option panel
    if (!isTouch) {
      chatBubbleEl.addEventListener("contextmenu", (ev) => {
        ev.preventDefault();
        toggleBubbleSelection(chatBubbleEl, data.id);
      });
      // left-click toggles selection if options are open (so user can multi-select easily)
      chatBubbleEl.addEventListener("click", (ev) => {
        if (selectedBubbles.size > 0) {
          ev.preventDefault();
          toggleBubbleSelection(chatBubbleEl, data.id);
        }
      });
    }

    // Mobile: long-press opens selection/option panel (500ms)
    // --- Mobile touch gestures ---
    if (isTouch) {
      let pressTimer;
      let touchStartX = 0;
      let touchStartY = 0;
      let longPressTriggered = false;
      let swipeTriggered = false;

      chatBubbleEl.addEventListener(
        "touchstart",
        (ev) => {
          const t = ev.changedTouches[0];
          touchStartX = t.screenX;
          touchStartY = t.screenY;
          longPressTriggered = false;
          swipeTriggered = false;

          // 🔹 Start long-press threshold timer
          pressTimer = setTimeout(() => {
            longPressTriggered = true;
            ev.preventDefault(); // stop Windows native menu

            // 🔸 Push-in animation
            const pushAnim = chatBubbleEl.animate(
              [
                { transform: "scale(1)", boxShadow: "0 0 0 rgba(0,0,0,0)" },
                { transform: "scale(0.7)", boxShadow: "inset 0 0 10px rgba(0,0,0,0.5)" }
              ],
              { duration: 120, fill: "forwards", easing: "ease-out" }
            );

            if (navigator.vibrate) navigator.vibrate(20);

            // Show options panel once push completes
            pushAnim.onfinish = () => {
              toggleBubbleSelection(chatBubbleEl, data.id);

              // 🔸 Bounce-back with smooth, springy feel
              chatBubbleEl.animate(
                [
                  { transform: "scale(0.7)", boxShadow: "inset 0 0 10px rgba(0,0,0,0.5)" },
                  { transform: "scale(1.03)", boxShadow: "0 0 6px rgba(0,255,120,0.25)" },
                  { transform: "scale(1)", boxShadow: "0 0 0 rgba(0,0,0,0)" }
                ],
                {
                  duration: 280,
                  fill: "forwards",
                  easing: "cubic-bezier(0.22, 1.35, 0.5, 1)" // smooth spring-like motion
                }
              );

              // disable long-press after feedback
              longPressTriggered = false;
              clearTimeout(pressTimer);
            };
          }, 500); // threshold
        },
        { passive: false }
      );

      chatBubbleEl.addEventListener(
        "touchmove",
        (ev) => {
          const t = ev.changedTouches[0];
          const dx = Math.abs(t.screenX - touchStartX);
          const dy = Math.abs(t.screenY - touchStartY);

          // cancel if moved too far
          if (dy > 10 || dx > 10) {
            clearTimeout(pressTimer);
          }
        },
        { passive: true }
      );

      chatBubbleEl.addEventListener(
        "touchend",
        (ev) => {
          clearTimeout(pressTimer);
          if (longPressTriggered) return; // prevent overlap

          const t = ev.changedTouches[0];
          const deltaX = t.screenX - touchStartX;
          const deltaY = Math.abs(t.screenY - touchStartY);

          // ✅ Right-swipe to reply
          if (deltaX > 60 && deltaY < 25 && !swipeTriggered) {
            swipeTriggered = true;
            animateReplyPop(chatBubbleEl); // subtle pop/glow

            replyToId = data.id;
            replyPreview.classList.remove("d-none");
            replyPreviewText.innerHTML = createReplyPreviewHTML({ parent: data });
            chatInput.focus();
            adjustPreviewPositions();
          }
        },
        { passive: true }
      );

      chatBubbleEl.addEventListener("touchcancel", () => clearTimeout(pressTimer), { passive: true });

      // Completely block the native Windows "touch right-click" popup
      chatBubbleEl.addEventListener("contextmenu", (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        return false;
      });
    }

    // ========== Click reply preview inside bubble -> scroll & highlight ==========
    bubble.querySelectorAll(".chat-reply-preview").forEach((el) => {
      el.addEventListener("click", (e) => {
        e.stopPropagation();
        scrollToMessage(el.dataset.parentId, "highlight-chat-bubble");
      });
    });

    if (cancelReply) {
      cancelReply.addEventListener("click", () => {
        replyToId = null;
        replyPreview.classList.add("d-none");
        adjustPreviewPositions();
        replyPreviewText.innerHTML = ""; // clear text
      });
    }
    return bubble;
  }

  // ---------- Prepend older messages ----------
  function prependMessages(messages) {
    const prevScrollHeight = chatContainer.scrollHeight;
    const prevScrollTop = chatContainer.scrollTop;

    // ✅ Keep backend order (oldest → newest)
    messages.forEach(msg => {
      // Skip duplicates silently
      if (!document.getElementById(`chat-bubble-${msg.id}`)) {
        chatContainer.prepend(renderMessage(msg, true));
      }
    });

    // ✅ Restore scroll position after prepend
    chatContainer.scrollTop = chatContainer.scrollHeight - prevScrollHeight + prevScrollTop;

    // ✅ Rebuild separators cleanly
    normalizeDateSeparators();
    updateStickyHeader();
  }

  // ---------- Normalize date separators ----------
  // --- normalizeDateSeparators (fixed to use safeParseDate) ---
  function normalizeDateSeparators() {
    chatContainer.querySelectorAll(".chat-date-separator").forEach(el => el.remove());

    let lastDay = null;
    const messages = [...chatContainer.querySelectorAll(".chat-item")]
      .sort((a, b) => {
        const da = safeParseDate(a.dataset.createdAt);
        const db = safeParseDate(b.dataset.createdAt);
        return da - db;
      });

    // ✅ Clear container and rebuild in order
    messages.forEach(msg => chatContainer.appendChild(msg));

    messages.forEach(msg => {
      const createdAt = msg.dataset.createdAt;
      if (!createdAt) return;
      const msgDateObj = safeParseDate(createdAt);
      if (!msgDateObj) return;

      const msgDay = new Date(msgDateObj.getFullYear(), msgDateObj.getMonth(), msgDateObj.getDate());

      if (!lastDay || msgDay.getTime() !== lastDay.getTime()) {
        lastDay = msgDay;

        const separator = document.createElement("div");
        separator.classList.add("chat-date-separator", "mb-2");
        Object.assign(separator.style, {
          display: "inline-block",
          padding: "2px 12px",
          borderRadius: "20px",
          fontWeight: "500",
          fontSize: "0.8rem",
          color: "#f59f00",
          backgroundColor: "#1f2937",
          boxShadow: "0 4px 8px #000000d2",
          textAlign: "center",
          margin: "auto"
        });
        separator.textContent = getDateText(msgDay);

        chatContainer.insertBefore(separator, msg);
      }
    });
  }

  function updateStickyHeader() {
    const separators = Array.from(chatContainer.querySelectorAll(".chat-date-separator"));
    let headerText = "";
    const containerRect = chatContainer.getBoundingClientRect();

    for (let i = 0; i < separators.length; i++) {
      const sep = separators[i];
      const rect = sep.getBoundingClientRect();

      if (rect.top <= containerRect.top + 10) {
        headerText = sep.textContent;
      }
    }

    if (headerText) {
      stickyDateHeader.textContent = headerText;
      stickyDateHeader.style.opacity = "1";
      stickyDateHeader.style.transform = "translate(-50%, 0)";
    } else {
      stickyDateHeader.style.opacity = "0";
    }
  }
  chatContainer.addEventListener("scroll", updateStickyHeader);


  // ---------- Load more ----------
  async function loadMoreMessages() {
    if (loading) return;
    loading = true;
    let url = `/chat/load/?limit=${limit}`;
    if (oldestLoaded) url += `&before=${encodeURIComponent(oldestLoaded)}`;
    if (currentTeam) url += `&team_id=${encodeURIComponent(currentTeam)}`;

    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (data.messages.length) {
        prependMessages(data.messages);

        // ✅ first element is now the oldest
        oldestLoaded = data.messages[0].created_at;
      }
    } catch (err) {
      console.error(err);
    }

    loading = false;
  }

  // ---------- Append new live message ----------
  function appendMessage(data, isPrepend = false) {
    // 🔹 Ensure assigned_user is included for rendering immediately
    if (data.guest) {
      const latestGuest = USER_GUESTS.find(g => g.id === data.guest.id) || UNASSIGNED_GUESTS.find(g => g.id === data.guest.id);
      data.guest.assigned_user = latestGuest?.assigned_user || data.guest.assigned_user || null;
    }

    //if (data.type === "pin") {
    //  updatePinnedPreview(data); // your preview logic
    //  return;
    //}

    //if (data.type === "unpin") {
    //  removePinnedPreview(data.message_id);
    //  return;
    //}

    if (!data.message && data.type !== 'chat_message') {
      console.warn("Skipping non-message payload:", data);
      return;
    }

    if (document.getElementById(`chat-bubble-${data.id}`)) return console.warn("Duplicate skipped (append):", data.id);

    const bubble = renderMessage(data);
    if (isPrepend) chatContainer.insertBefore(bubble, chatContainer.firstChild); else chatContainer.appendChild(bubble);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    normalizeDateSeparators();
    updateStickyHeader();
  }

  // ---------- Infinite scroll ----------
  chatContainer.addEventListener("scroll", () => {
    if (chatContainer.scrollTop === 0 && !loading) loadMoreMessages();
  });

  // ---------- Initial load ----------
  loadMoreMessages();


  LAST_MESSAGES.forEach(appendMessage);

  /***********************
  * Mentions Utilities *
  ***********************/

  // Utility to safely escape regex special chars
  function escapeRegex(string) {
    if (!string) return "";
    return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  // Detect manually typed mentions in message text
  function detectMentionsFromText(text) {
    if (!text) return [];
    const detected = [];

    usersList.forEach(u => {
      const fullName = escapeRegex(u.full_name || u.username);
      const title = u.title ? escapeRegex(u.title) : "";

      // If title exists, allow optional "Title " before the name
      const pattern = title
        ? `@(?:${title}\\s+)?${fullName}`
        : `@${fullName}`;

      const regex = new RegExp(pattern, "i"); // case-insensitive
      if (regex.test(text) && !detected.some(m => m.id == u.id)) {
        detected.push({
          id: u.id,
          title: u.title || "",
          name: u.full_name || u.username,
          color: u.color || "#00aeff71",
        });
      }
    });

    return detected;
  }

  // Render mentions in message with styled spans
  function renderMessageWithMentions(message, mentionsList) {
    if (!mentionsList?.length) return message;

    let renderedMsg = message;

    mentionsList.forEach(m => {
      const titlePrefix = m.title ? m.title + " " : "";
      const name = m.full_name;
      const color = m.color || "#00aeffff";

      // Match the mention, case-insensitive, whole word
      const regex = new RegExp(`@${escapeRegex(titlePrefix + name)}\\b`, "gi");

      renderedMsg = renderedMsg.replace(
        regex,
        `<span class="mention" style="color:${color}">@${titlePrefix}${name}</span>`
      );
    });

    return renderedMsg;
  }

  async function sendMessage(message = "", guest = selectedGuest) {
    // Always pull latest text if not explicitly passed
    if (!message && chatInput) {
      message = chatInput.value;
    }

    // Exit only if everything is empty / null
    if (!message && !guest && !selectedFile && !selectedLinkPreview && !replyToId) {
      console.warn("sendMessage exited: nothing to send");
      return;
    }

    if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
      console.warn("sendMessage exited: WebSocket not open", chatSocket?.readyState);
      return;
    }

    // 🔹 Ensure assigned_user is included
    if (guest) {
      // Use already assigned user if present
      if (!guest.assigned_user) {
        const latestGuest = USER_GUESTS.find(g => g.id === guest.id) || UNASSIGNED_GUESTS.find(g => g.id === guest.id);
        guest.assigned_user = latestGuest?.assigned_user || null;
      }
    }

    // Detect manually typed mentions
    const manualMentions = detectMentionsFromText(message).map(m => {
      const user = USERS.find(u => u.id === m.id); // get the full user object
      return {
        ...m,
        color: user?.color || "#00aeffff" // assign their chat bubble color
      };
    });

    // Push to mentions array
    manualMentions.forEach(m => mentions.push(m));

    // Edit mode
    //if (chatInput.dataset.editingId) {
    //  const editId = parseInt(chatInput.dataset.editingId, 10);
    //  const node = document.getElementById(`chat-bubble-${editId}`);
    //  if (node) {
    //    node.dataset.edited = "true";
    //    const body = node.querySelector(".chat-bubble-body .fs-4");
    //    if (body) body.textContent = message.trim();

    //    let editedTag = node.querySelector(".edited-flag");
    //    if (!editedTag) {
    //      const dateEl = node.querySelector(".chat-bubble-date");
    //      if (dateEl) {
    //        editedTag = document.createElement("span");
    //        editedTag.className = "edited-flag text-muted ms-1";
    //        editedTag.style.fontSize = "0.7rem";
    //        editedTag.textContent = "(Edited)";
    //        dateEl.appendChild(editedTag);
    //      }
    //    }
    //  }

    //  chatSocket.send(JSON.stringify({
    //    action: "edit",
    //    message_id: editId,
    //    new_text: message.trim(),
    //    sender_id: CURRENT_USER_ID
    //  }));

    //  chatInput.value = "";
    //  delete chatInput.dataset.editingId;
    //  return;
    //}

    const payload = {
      sender_id: CURRENT_USER_ID,
      team_id: window.currentTeam || null,
      guest_id: guest ? parseInt(guest.id, 10) : null,
      reply_to_id: replyToId || null,
      mentions: mentions.map(m => m.id),
      guest: guest
      ? {
          id: parseInt(guest.id, 10),
          name: guest.name,
          custom_id: guest.custom_id,
          image: guest.image,
          title: guest.title,
          date_of_visit: guest.date_of_visit,
          assigned_user: guest.assigned_user || null
        }
      : null
    };

    // Only include message if it’s non-empty
    if (message?.trim()) {
      payload.message = message.trim();
    }

    //if (guest) {
    //  payload.guest = {
    //    id: parseInt(guest.id, 10),
    //    name: guest.name,
    //    custom_id: guest.custom_id,
    //    image: guest.image,
    //    title: guest.title,
    //    date_of_visit: guest.date_of_visit,
        //assigned_user: guest.assigned_user || null
    //  };
    //}

    // File Send Payload
    if (selectedFile) {
      const formData = new FormData();
      formData.append("file", selectedFile);

      try {
        const res = await fetch("/upload_file/", {
          method: "POST",
          body: formData
        });

        if (!res.ok) throw new Error("File upload failed");
        const uploaded = await res.json();

        // ✅ Pass whole metadata to WS
        payload.file = {
          url: uploaded.url,              // ALWAYS INCLUDED
          path: uploaded.path,
          public_id: uploaded.public_id,
          name: uploaded.name,
          size: uploaded.size,
          type: uploaded.type
        };
        selectedFile = null;
      } catch (err) {
        console.error("❌ File upload error:", err);
        return; // abort sending
      }
    }

    if (selectedLinkPreview) {
      payload.link_preview = selectedLinkPreview;
    }

    // 🔥 Log guest info reliably
    console.group("📝 Sending message");
    console.log("Guest object:", guest);
    console.log("Assigned user:", guest?.assigned_user);
    console.log("Message content:", message.trim());
    console.log("Final payload:", JSON.stringify(payload, null, 2)); // ✅ full JSON preview
    console.groupEnd();

    chatSocket.send(JSON.stringify(payload));

    // Cleanup
    if (chatInput) chatInput.value = "";
    autoResizeTextarea(chatInput);
    removeGuestPreview();
    replyToId = null;
    replyPreview.classList.add("d-none");
    removeFilePreview();
    removeLinkPreview();
    //window.clearMentions();
    mentions = [];
  }

  // escape HTML to prevent injection when using textContent-like replacement in innerHTML
  function escapeHtml(unsafe) {
    if (unsafe == null) return "";
    return String(unsafe)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // ---------- Options actions (frontend + WS emits) ----------
  // Get current user's full name from USERS array
  // Build the current user's display name (with title + full name)
  const CURRENT_USER_DISPLAY = currentUser
    ? `${currentUser.title ? currentUser.title + " " : ""}${currentUser.full_name || currentUser.username}`
    : "Unknown";

  // When copying messages
  document.getElementById("copyBtn").addEventListener("click", async () => {
    if (!selectedBubbles.size) return;

    const parts = [];

    for (const id of selectedBubbles) {
      const node = document.getElementById(`chat-bubble-${id}`);
      if (!node) continue;

      const text = node.querySelector(".chat-bubble-body .fs-4")?.textContent.trim() || "";
      const iso = node.querySelector(".chat-bubble-date")?.dataset?.fullDate || new Date().toISOString();

      const ownerId = parseInt(node.dataset.senderId, 10);
      const owner = ownerId === CURRENT_USER_ID
        ? CURRENT_USER_DISPLAY
        : (node.querySelector(".chat-bubble-author")?.textContent.trim() || "Unknown");

      parts.push(`${formatForCopy(iso)} — ${owner}:\n${text}`);
    }

    const final = parts.join("\n");
    await navigator.clipboard.writeText(final);

    // ✅ Feedback icon
    const btn = document.getElementById("copyBtn");
    btn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="green" viewBox="0 0 16 16">
        <path d="M13.485 1.929a.5.5 0 0 1 .07.707l-7 8a.5.5 0 0 1-.714.03l-3-3a.5.5 0 0 1 .708-.708L6 9.293l6.778-7.778a.5.5 0 0 1 .707-.07z"/>
      </svg>`;

    setTimeout(() => {
      btn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" 
            viewBox="0 0 24 24" fill="#02bd12ff" 
            class="icon icon-tabler icons-tabler-filled icon-tabler-copy-check">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M18.333 6a3.667 3.667 0 0 1 3.667 3.667v8.666a3.667 3.667 0 0 1 -3.667 3.667h-8.666a3.667 3.667 0 0 1 -3.667 -3.667v-8.666a3.667 3.667 0 0 1 3.667 -3.667zm-3.333 -4c1.094 0 1.828 .533 2.374 1.514a1 1 0 1 1 -1.748 .972c-.221 -.398 -.342 -.486 -.626 -.486h-10c-.548 0 -1 .452 -1 1v9.998c0 .32 .154 .618 .407 .805l.1 .065a1 1 0 1 1 -.99 1.738a3 3 0 0 1 -1.517 -2.606v-10c0 -1.652 1.348 -3 3 -3zm1.293 9.293l-3.293 3.292l-1.293 -1.292a1 1 0 0 0 -1.414 1.414l2 2a1 1 0 0 0 1.414 0l4 -4a1 1 0 0 0 -1.414 -1.414" />
        </svg>`;
    }, 900);

    clearSelections();
  });


  document.getElementById("pinBtn").addEventListener("click", () => {
    if (!selectedBubbles.size) return;

    const ids = Array.from(selectedBubbles);

    // ✅ Just tell the server
    chatSocket.send(JSON.stringify({
      action: "pin",
      message_ids: ids,
      sender_id: CURRENT_USER_ID
    }));

    clearSelections();
  });


  // === REPLY BUTTON HANDLER ===
  document.getElementById("replyBtn").addEventListener("click", () => {
    if (selectedBubbles.size === 0) return;

    // pick the last selected bubble
    const id = Array.from(selectedBubbles).pop();
    const node = document.getElementById(`chat-bubble-${id}`);
    if (!node) return;

    // grab the same data structure already stored on the bubble
    const messageData = {
      id,
      sender_id: parseInt(node.dataset.senderId, 10),
      sender_title: node.querySelector(".chat-bubble-author")?.textContent.split(" ")[0] || "",
      sender_name: node.querySelector(".chat-bubble-author")?.textContent.split(" ").slice(1).join(" ") || "",
      color: node.dataset.color || "text-primary",
      message: node.querySelector(".chat-bubble-body .fs-4")?.textContent || "",
      guest: node.dataset.guest ? JSON.parse(node.dataset.guest) : null,
      file: node.dataset.file ? JSON.parse(node.dataset.file) : null,             // ✅ support file preview
      link_preview: node.dataset.linkPreview ? JSON.parse(node.dataset.linkPreview) : null // ✅ support link preview
    };

    // 🔹 Pop animation
    const bubbleEl = node.querySelector(".chat-bubble");
    if (bubbleEl) animateReplyPop(bubbleEl);

    // ✅ use exactly the same reply preview HTML as swipe-to-reply
    replyToId = id;
    replyPreview.classList.remove("d-none");
    replyPreviewText.innerHTML = createReplyPreviewHTML({ parent: messageData });

    chatInput.focus();
    clearSelections();
  });

  // Clicking outside panel clears selection
  document.addEventListener("click", (e) => {
    if (!optionsPanel.contains(e.target) && !e.target.closest(".chat-bubble")) {
      clearSelections();
    }
  });

  // scroll-to-bottom behavior
  function scrollToBottom(focusInput = true) {
    const messages = Array.from(chatContainer.querySelectorAll(".chat-item"));
    if (!messages.length) return;

    const containerRect = chatContainer.getBoundingClientRect();
    const lastMsg = messages[messages.length - 1];
    const lastRect = lastMsg.getBoundingClientRect();

    let jumpTarget = lastMsg;

    // Jump only if we're far from bottom (> 5 messages height roughly)
    if ((chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight) > 300) {
      // Pick a message ~4 above the last message
      const jumpIndex = Math.max(messages.length - 3, 0);
      jumpTarget = messages[jumpIndex];
    }

    // Jump instantly
    jumpTarget.scrollIntoView({ behavior: "auto", block: "center" });

    // Then smooth scroll last message into view
    lastMsg.scrollIntoView({ behavior: "smooth", block: "end" });

    // Focus input
    if (focusInput && chatInput) chatInput.focus();
  }

  // Update button visibility
  function updateScrollButton() {
    const atBottom = (chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight) < 60;
    if (!atBottom) scrollToBottomBtn.classList.add("show");
    else scrollToBottomBtn.classList.remove("show");
  }

  chatContainer.addEventListener("scroll", updateScrollButton);
  scrollToBottomBtn.addEventListener("click", () => scrollToBottom());

  // Guest Preview
  function createGuestPreview(guest){
    // ensure assigned_user is always present
    const matchedGuest =
        USER_GUESTS.find(g => g.id === guest.id) ||
        UNASSIGNED_GUESTS.find(g => g.id === guest.id);
    guest.assigned_user = matchedGuest?.assigned_user || null;
    removeGuestPreview();
    selectedGuest = guest;

    const preview = document.createElement("div");
    preview.id = "guestPreview";
    preview.classList.add("d-flex","align-items-center","text-white","border-0","p-2","mb-2","rounded-2","bg-gray-900");
    preview.style.boxShadow = "0 4px 8px #0000004d";
    preview.innerHTML = `
      ${guest.image
        ? `<img src="${guest.image}" style="width:70px;height:70px;border-radius:6px;object-fit:cover;margin-right:10px;">`
        : `<span class="avatar bg-gray d-flex align-items-center justify-content-center"
                  style="width:70px;height:70px;border-radius:4px;margin-right:10px;">${guest.name[0]}</span>`}

      <div class="flex-grow-1">
        <strong class="text-warning">${guest.title} ${guest.name}</strong><br> (${guest.custom_id})<br>
        ${guest.date_of_visit}
      </div>
      <span id="cancelGuestPreview" class="avatar text-red p-0 border-0 d-flex align-items-center justify-content-center" style="width:24px; height:24px; cursor:pointer;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
        </svg>
      </span>
    `;
    document.getElementById("guestPreviewContainer").appendChild(preview);

    document.getElementById("cancelGuestPreview").addEventListener("click", removeGuestPreview);
    chatInput.focus();
    adjustPreviewPositions();
  }

  function removeGuestPreview(){
    const preview = document.getElementById("guestPreview");
    if(preview) preview.remove();
    selectedGuest = null;
  }

  //chatInput.addEventListener("keypress", e => { if(e.key==="Enter") sendMessage(chatInput.value); });
  //sendButton.addEventListener("click", e => { e.preventDefault(); sendMessage(chatInput.value); });

  //chatSocket.onmessage = e => appendMessage(JSON.parse(e.data));

  // ==========================
  // Central User/Guest Popup
  // ==========================
  openBtn.addEventListener("click", () => { popup.classList.remove("d-none"); renderList(""); });
  closeBtn.addEventListener("click", () => popup.classList.add("d-none"));
  popup.querySelector(".popup-backdrop").addEventListener("click", () => popup.classList.add("d-none"));
  popupSearch.addEventListener("input", e => renderList(e.target.value));

  function renderList(filter) {
    popupBody.innerHTML = "";

    const userGuestsMap = {};
    USER_GUESTS.forEach(u => userGuestsMap[u.id] = u.guests || []);

    let visibleUsers = [];

    // 🔹 Filter magnet users only
    const magnetUsers = USERS.filter(u =>
      u.role && u.role.toLowerCase().includes("magnet")
    );

    if (CURRENT_USER_ROLE === "Superuser") {
      // Superuser sees all magnet users (including Admins/Pastors)
      visibleUsers = magnetUsers;
    } else if (USER_PERMS.is_magnet_admin) {
      // These roles can see all magnet users except Superuser
      visibleUsers = magnetUsers.filter(
        u => !u.role.toLowerCase().includes("superuser")
      );
    } else {
      // Regular users see only themselves
      visibleUsers = magnetUsers.filter(u => u.id === CURRENT_USER_ID);
    }

    //console.log("Current Role:", CURRENT_USER_ROLE);
    //console.log("Visible Users:", visibleUsers.map(u => `${u.full_name} (${u.role})`));

    // 🔹 3️⃣ Render users and their guests
    visibleUsers.forEach(user => {
      const assignedGuests = userGuestsMap[user.id] || [];
      let allGuests = [...assignedGuests];

      // Show unassigned guests only if current user is a Magnet admin or project-level
      // Add unassigned guests only under *self* if privileged
      if (user.id === CURRENT_USER_ID && USER_PERMS.is_magnet_admin) {
        allGuests = allGuests.concat(UNASSIGNED_GUESTS);
      }

      const userMatches = user.full_name.toLowerCase().includes(filter.toLowerCase());
      const filteredGuests = allGuests.filter(g =>
        g.name.toLowerCase().includes(filter.toLowerCase())
      );

      const userColorClass = getUserColor(user.id);

      if (userMatches || filteredGuests.length > 0) {
        const userDiv = document.createElement("div");
        userDiv.classList.add("user-item");
        userDiv.innerHTML = `
          <div class="d-flex align-items-center gap-2 p-2">
            ${user.image
              ? `<img src="${user.image}" alt="${user.full_name}" 
                      style="width:32px; height:32px; object-fit:cover; border-radius:6px;">`
              : `<div class="avatar ${userColorClass} bg-gray d-flex align-items-center justify-content-center fs-2 fw-bold"
                    style="width:32px; height:32px; border-radius:6px;">
                  ${user.full_name ? user.full_name[0].toUpperCase() : "?"}
                </div>`}           
            <strong class="flex-grow-1 ${userColorClass} p-1 rounded">
              ${user.title ? user.title + " " : ""} ${user.full_name}
            </strong>
          </div>
        `;
        popupBody.appendChild(userDiv);

        const guestContainer = document.createElement("div");
        guestContainer.classList.add("guest-list");
        guestContainer.style.display = "none";

        // After creating guestContainer
        if (filteredGuests.length > 0) {
          filteredGuests.forEach(g => {
            const guestItem = document.createElement("div");
            guestItem.classList.add("guest-item");

            const avatar = g.image 
              ? `<img src="${g.image}" class="guest-avatar" style="width:50px;height:50px;border-radius:4px;object-fit:cover;margin-right:10px;">`
              : `<div class="guest-avatar bg-gray-900 d-flex align-items-center justify-content-center" style="width:50px;height:50px;border-radius:4px;font-size:12px;font-weight:bold;color:white;">
                  ${g.name.split(" ").map(n => n[0]).join('')}
                </div>`;

            const badge = g.assigned
              ? '<span class="badge-assigned bg-green-lt text-white">Assigned</span>'
              : '<span class="badge-unassigned bg-red-lt text-white">Unassigned</span>';

            guestItem.innerHTML = `<div class="col-12 me-3 mb-2">
                                    <div class="card shadow-sm border-0">
                                      <div class="card-body py-2 px-3 d-flex align-items-center">
                                        <div class="me-3">${avatar}</div>
                                        <div class="flex-grow-1">
                                          <span>${g.title ? g.title+" " : ""}${g.name}</span>
                                          ${badge}
                                        </div>
                                      </div>
                                    </div>
                                  </div>`;
            guestItem.addEventListener("click", () => {
              createGuestPreview(g);
              popup.classList.add("d-none");
            });
            guestContainer.appendChild(guestItem);
          });
        } else {
          // Show "No Guests Assigned Yet"
          const emptyMsg = document.createElement("div");
          emptyMsg.classList.add("text-muted", "px-3", "py-2", "fst-italic");
          emptyMsg.innerText = "No Guests Assigned Yet";
          guestContainer.appendChild(emptyMsg);
        }

        popupBody.appendChild(guestContainer);

        userDiv.addEventListener("click", () => {
          guestContainer.style.display = guestContainer.style.display === "none" ? "block" : "none";
        });
      }
    });
  }

  //Chat Live Search
  // Handle all search inputs (desktop + mobile)
  document.querySelectorAll(".chat-search").forEach(input => {
    input.addEventListener("input", function () {
      const query = this.value.toLowerCase().trim();
      const chatItems = chatContainer.querySelectorAll(".chat-item");

      chatItems.forEach(item => {
        const text = item.innerText.toLowerCase();
        if (text.includes(query)) {
          item.style.display = "";   // show
        } else {
          item.style.display = "none"; // hide
        }
      });
    });
  });

  // ---------- Textarea resizing ----------

  const TAB_SPACES = "    "; // 4-space tab
  let lastLineNumbering = null;       // top-level number
  let lastLineNestedNumbering = null; // nested letter
  let lastLineWasNumbered = false;
  let lastLineWasNested = false;

  function autoResizeTextarea(el) {
    el.style.height = "auto";
    const lineHeight = 20;
    const minHeight = lineHeight * 2;
    const maxHeight = lineHeight * 5;
    const newHeight = Math.min(el.scrollHeight, maxHeight);
    el.style.height = Math.max(newHeight, minHeight) + "px";
    el.style.overflowY = el.scrollHeight > maxHeight ? "auto" : "hidden";
  }

  function formatMessage(text) {
    return text
      .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
      .replace(/\*(.*?)\*/g, '<i>$1</i>')
      .replace(/_(.*?)_/g, '<u>$1</u>')
      .replace(/==(.+?)==/g, '<span class="highlight">$1</span>');
  }

  function updatePreview() {
    preview.innerHTML = formatMessage(chatInput.value);
  }

  function handleFormattingShortcuts(e, el) {
    const selStart = el.selectionStart;
    const selEnd = el.selectionEnd;
    const wrapperMap = { b: "**", i: "*", u: "_", h: "==" };
    const key = e.key.toLowerCase();

    if ((e.ctrlKey || e.metaKey) && wrapperMap[key]) {
      e.preventDefault();
      const wrapper = wrapperMap[key];
      const text = el.value;
      el.value = text.slice(0, selStart) + wrapper + text.slice(selStart, selEnd) + wrapper + text.slice(selEnd);
      el.selectionStart = selStart + wrapper.length;
      el.selectionEnd = selEnd + wrapper.length;
      autoResizeTextarea(el);
      updatePreview();
    }
  }

  function handleEnterAndNumbering(e, el) {
    const selStart = el.selectionStart;
    const selEnd = el.selectionEnd;
    const before = el.value.substring(0, selStart);
    const after = el.value.substring(selEnd);
    const lastNewline = before.lastIndexOf("\n");
    const currentLine = before.substring(lastNewline + 1);

    // Shift+Enter = send
    if (e.key === "Enter" && e.shiftKey) {
      e.preventDefault();
      sendMessage(el.value);
      el.value = "";
      autoResizeTextarea(el);
      updatePreview();
      lastLineNumbering = null;
      lastLineNestedNumbering = null;
      lastLineWasNumbered = false;
      lastLineWasNested = false;
      return;
    }

    // Enter key: continuation, double-enter cancellation
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      let newText = "\n";

      const nestedMatch = currentLine.match(/^(\s*)([a-z])\.\s/);
      const topMatch = currentLine.match(/^(\s*)(\d+)\.\s/);

      if (nestedMatch) {
        const indent = nestedMatch[1];
        const letter = nestedMatch[2];

        // Double-enter: cancel nested
        if (lastLineWasNested && lastLineNestedNumbering === letter && currentLine.trim() === `${letter}.`) {
          newText = "";
          lastLineNestedNumbering = null;
          lastLineWasNested = false;
          el.value = before.substring(0, lastNewline + 1) + newText + after;
          el.selectionStart = el.selectionEnd = lastNewline + 1;
        } else {
          const nextLetter = String.fromCharCode(letter.charCodeAt(0) + 1);
          newText += indent + nextLetter + ". ";
          lastLineNestedNumbering = nextLetter;
          lastLineWasNested = true;
          el.value = before + newText + after;
          el.selectionStart = el.selectionEnd = before.length + newText.length;
        }
      } else if (topMatch) {
        const indent = topMatch[1];
        const number = parseInt(topMatch[2], 10);

        // Double-enter: cancel top-level
        if (lastLineWasNumbered && lastLineNumbering === number && currentLine.trim() === `${number}.`) {
          newText = "";
          lastLineNumbering = null;
          lastLineWasNumbered = false;
          el.value = before.substring(0, lastNewline + 1) + newText + after;
          el.selectionStart = el.selectionEnd = lastNewline + 1;
        } else {
          newText += indent + (number + 1) + ". ";
          lastLineNumbering = number + 1;
          lastLineWasNumbered = true;
          el.value = before + newText + after;
          el.selectionStart = el.selectionEnd = before.length + newText.length;
        }
      } else {
        lastLineNumbering = null;
        lastLineNestedNumbering = null;
        lastLineWasNumbered = false;
        lastLineWasNested = false;
        el.value = before + newText + after;
        el.selectionStart = el.selectionEnd = before.length + newText.length;
      }

      autoResizeTextarea(el);
      updatePreview();
      return;
    }

    // Space after number -> indent
    if (e.key === " " && !e.shiftKey && selStart === selEnd) {
      // Detect top-level number
      if (/^\s*\d+\.$/.test(currentLine)) {
        e.preventDefault();
        const after = el.value.substring(selStart);
        const newLine = TAB_SPACES + currentLine + " ";
        el.value = el.value.substring(0, lastNewline + 1) + newLine + after;
        el.selectionStart = el.selectionEnd = lastNewline + 1 + newLine.length;
        lastLineWasNumbered = true;
        lastLineNumbering = parseInt(currentLine.trim(), 10);
        autoResizeTextarea(el);
        updatePreview();
        return;
      }

      // Detect typing a. in front of a top-level number → nested indent
      if (/^\s*a\.$/.test(currentLine.trim())) {
        const parentMatch = before.substring(0, lastNewline).match(/^\s*\d+\.\s.*$/m);
        if (parentMatch) {
          e.preventDefault();
          const parentIndent = parentMatch[0].match(/^(\s*)/)[1] || "";
          const after = el.value.substring(selStart);
          const nestedLine = parentIndent + TAB_SPACES + "a. ";
          el.value = el.value.substring(0, lastNewline + 1) + nestedLine + after;
          el.selectionStart = el.selectionEnd = lastNewline + 1 + nestedLine.length;
          lastLineNestedNumbering = "a";
          lastLineWasNested = true;
          lastLineWasNumbered = false;
          lastLineNumbering = null;
          autoResizeTextarea(el);
          updatePreview();
          return;
        }
      }
    }
  }

  // Live preview update
  chatInput.addEventListener("input", () => {
    autoResizeTextarea(chatInput);
    updatePreview();
  });

  // Key handling
  chatInput.addEventListener("keydown", (e) => {
    handleFormattingShortcuts(e, chatInput);
    handleEnterAndNumbering(e, chatInput);
  });

  // Send button
  sendButton.addEventListener("click", (e) => {
    e.preventDefault();
    sendMessage(chatInput.value);
    chatInput.value = "";
    autoResizeTextarea(chatInput);
    updatePreview();
    lastLineNumbering = null;
    lastLineNestedNumbering = null;
    lastLineWasNumbered = false;
    lastLineWasNested = false;
  });

  // Initialize
  autoResizeTextarea(chatInput);
  updatePreview();


  // Initial height set
  //autoResizeContenteditable(chatInput);


  // Attach Guest from Guest List page
  const guestData = localStorage.getItem("attachGuest");
  if (guestData) {
    createGuestPreview(JSON.parse(guestData));
    localStorage.removeItem("attachGuest"); // clear after use
  }

  function setVH() {
    document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
  }
  window.addEventListener('resize', setVH);
  window.addEventListener('orientationchange', setVH);
  setVH();

  // 🔹 Toggle player from thumbnail
  document.addEventListener("click", function (e) {
    const thumb = e.target.closest(".media-thumb");
    if (thumb) {
      const card = thumb.closest(".chat-file-card");
      const player = card.querySelector(".media-player");
      if (player) {
        thumb.classList.add("d-none");
        player.classList.remove("d-none");
        player.play().catch(err => console.warn("Autoplay blocked:", err));

        // 🔄 Auto-revert when finished
        player.onended = () => {
          player.classList.add("d-none");
          thumb.classList.remove("d-none");
        };
      }
    }
  });

  // 🔹 Click outside closes media player
  document.addEventListener("click", function (e) {
    document.querySelectorAll(".chat-file-card").forEach(card => {
      const player = card.querySelector(".media-player");
      const thumb = card.querySelector(".media-thumb");
      if (!player || player.classList.contains("d-none")) return;

      if (!card.contains(e.target)) {
        // Clicked outside → close player
        player.pause();
        player.currentTime = 0; // reset
        player.classList.add("d-none");
        if (thumb) thumb.classList.remove("d-none");
      }
    });
  });

  // 🔹 Adjust footer on input focus (mobile keyboards)
  chatInput.addEventListener("focus", () => {
    chatFooter.style.transform = "translateY(-env(safe-area-inset-bottom))"; // optional safe-area
    chatFooter.style.transition = "transform 0.3s ease";
  });

  chatInput.addEventListener("blur", () => {
    chatFooter.style.transform = "translateY(0)";
  });



});
</script>

{% endblock %}