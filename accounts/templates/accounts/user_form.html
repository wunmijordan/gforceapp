{% extends 'base.html' %}
{% load static %}
{% load form_tags %}
{% load access_tags %}

{% get_media_prefix as MEDIA_URL %}

{% block content %}

<div class="page-wrapper">
  <!-- BEGIN PAGE HEADER -->
  <div class="page-header d-print-none" aria-label="Page header">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <!-- Dynamic Page Title -->
          <kbd class="bg-indigo-lt"><h2 class="page-title">{{ page_title }}</h2></kbd>
        </div>
      </div>
    </div>
  </div>
  <div class="page-body">
    <div class="container py-4">
      <div class="card shadow-sm">
        <div class="card-header">
          <h3 class="card-title">
            {% if edit_mode %}
              Editing Profile for: <span class="text-warning fs-2">{{ user_obj.title|default:"" }} {{ user_obj.full_name }}</span>
            {% else %}
              Add New Team Member
            {% endif %} </h3>
        </div>

        <div class="card-body">
          <!-- User Image Preview -->
          <div class="mb-4 text-center">
            <span class="avatar avatar-xl rounded" style="width: 100px; height: 100px;">
              <img id="preview-img" 
                  src="{% if user_obj and user_obj.image %}{{ user_obj.image.url }}{% else %}{% static 'images/default_image.jpg' %}{% endif %}" 
                  alt="User Profile Picture" 
                  class="rounded shadow-sm"
                  style="object-fit: cover; width: 100px; height: 100px;">
            </span>
          </div>

          <!-- User Form Start -->
          <form id="UserCreationForm" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}
            {% if form.non_field_errors %}
              <div class="alert alert-danger">
                {{ form.non_field_errors }}
              </div>
            {% endif %}

            <div class="row g-3">

              {% for field in form.visible_fields %}
                {% if field.name != 'password' and field.name != 'confirm_password' %}
                  <div class="col-md-6">
                    <div class="form-group">
                      <!--<label for="{{ field.id_for_label }}" class="form-label text-white">{{ field.label }}</label>-->

                      <div class="input-group input-group-flat">
                        {% if field.name == 'image' %}
                          <span class="input-group-text bg-dark text-white" style="width: 38px; display:flex; align-items:center; justify-content:center;">
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-camera">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 7h1a2 2 0 0 0 2 -2a1 1 0 0 1 1 -1h6a1 1 0 0 1 1 1a2 2 0 0 0 2 2h1a2 2 0 0 1 2 2v9a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-9a2 2 0 0 1 2 -2" />
                              <path d="M9 13a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
                            </svg>
                          </span>
                          <input type="file" 
                                name="image" 
                                id="{{ field.id_for_label }}" 
                                accept="image/*" 
                                class="form-control bg-grey text-white border-0"
                                onchange="previewImage(this)">
                        {% elif field.name == 'full_name' %}
                          <span class="input-group-text bg-grey text-white border-0" style="width: 38px; display:flex; align-items:center; justify-content:center;">
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-user">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                              <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                            </svg>
                          </span>
                          {{ field|add_class:"form-control bg-grey text-white border-0" }}
                        {% elif field.name == 'phone_number' %}
                          <span class="input-group-text bg-grey text-white border-0" style="width: 38px; display:flex; align-items:center; justify-content:center;">
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-device-mobile-vibration">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 3m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v14a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z" />
                              <path d="M8 4l2 0" /><path d="M9 17l0 .01" /><path d="M21 6l-2 3l2 3l-2 3l2 3" />
                            </svg>
                          </span>
                          {{ field|add_class:"form-control bg-grey text-white border-0" }}
                        {% elif field.name == 'email' %}
                          <span class="input-group-text bg-grey text-white border-0" style="width: 38px; display:flex; align-items:center; justify-content:center;">
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-at">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
                              <path d="M16 12v1.5a2.5 2.5 0 0 0 5 0v-1.5a9 9 0 1 0 -5.5 8.28" />
                            </svg>
                          </span>
                          {{ field|add_class:"form-control bg-grey text-white border-0" }}
                        {% elif field.name == 'date_of_birth' %}
                          <span class="input-group-text bg-grey text-white border-0" style="width: 38px; display:flex; align-items:center; justify-content:center;">
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-calendar">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z" />
                              <path d="M16 3v4" /><path d="M8 3v4" />
                              <path d="M4 11h16" /><path d="M11 15h1" /><path d="M12 15v3" />
                            </svg>
                          </span>
                          {{ field|add_class:"form-control bg-grey text-white border-0" }}
                        {% elif field.name == 'department' %}
                          <span class="input-group-text bg-grey text-white border-0" style="width: 38px; display:flex; align-items:center; justify-content:center;">
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-briefcase">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v9a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z" /><path d="M8 7v-2a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v2" />
                              <path d="M12 12l0 .01" /><path d="M3 13a20 20 0 0 0 18 0" />
                            </svg>
                          </span>
                          {{ field|add_class:"form-select bg-grey text-white border-0" }}
                        {% elif field.name == 'address' %}
                          <span class="input-group-text bg-grey text-white border-0" style="width: 38px; display:flex; align-items:center; justify-content:center;">
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-home">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l-2 0l9 -9l9 9l-2 0" /><path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
                              <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
                            </svg>
                          </span>
                          {{ field|add_class:"form-control bg-grey text-white border-0" }}
                        {% elif field.name == 'title' %}
                          <span class="input-group-text bg-grey text-white border-0" style="width: 38px; display:flex; align-items:center; justify-content:center;">
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-tie">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 22l4 -4l-2.5 -11l.993 -2.649a1 1 0 0 0 -.936 -1.351h-3.114a1 1 0 0 0 -.936 1.351l.993 2.649l-2.5 11l4 4z" />
                              <path d="M10.5 7h3l5 5.5" />
                            </svg>
                          </span>
                          {{ field|add_class:"form-select bg-grey text-white border-0" }}
                        {% elif field.name == 'marital_status' %}
                          <span class="input-group-text bg-grey text-white border-0" style="width: 38px; display:flex; align-items:center; justify-content:center;">
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-friends">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 5m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                              <path d="M5 22v-5l-1 -1v-4a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4l-1 1v5" />
                              <path d="M17 5m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M15 22v-4h-2l2 -6a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1l2 6h-2v4" />
                            </svg>
                          </span>
                          {{ field|add_class:"form-select bg-grey text-white border-0" }}
                        {% elif field.name == 'username' %}
                          <span class="input-group-text bg-grey text-white border-0" style="width: 38px; display:flex; align-items:center; justify-content:center;">
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-user-edit">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                              <path d="M6 21v-2a4 4 0 0 1 4 -4h3.5" />
                              <path d="M18.42 15.61a2.1 2.1 0 0 1 2.97 2.97l-3.39 3.42h-3v-3l3.42 -3.39z" />
                            </svg>
                          </span>
                          {{ field|add_class:"form-control bg-grey text-white border-0" }}
                        {% elif field.name == 'groups' %}
                          <span class="input-group-text bg-grey text-white border-0" style="width: 38px; display:flex; align-items:center; justify-content:center;">
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-pray">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />
                              <path d="M7 20h8l-4 -4v-7l4 3l2 -2" />
                            </svg>
                          </span>
                          {{ field|add_class:"form-select bg-grey text-white border-0" }}
                        {% elif field.name == 'teams' %}
                          <div id="team-role-container" class="mt-3">
                            <div id="team-role-list"></div>
                            <button type="button" id="add-team-role" class="btn btn-grey-900 mt-2">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-users-group">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 13a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                                <path d="M8 21v-1a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v1" /><path d="M15 5a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                                <path d="M17 10h2a2 2 0 0 1 2 2v1" /><path d="M5 5a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M3 13v-1a2 2 0 0 1 2 -2h2" />
                              </svg> 
                              Add Team
                            </button>
                          </div>
                          <input type="hidden" id="teamsHiddenInput" name="teamsHiddenInput" value="">
                          
                        {% elif field.name == 'is_active' %}
                          <div class="form-check">
                              {{ form.is_active }}
                              <label class="form-check-label" for="{{ form.is_active.id_for_label }}">Active</label>
                          </div>
                        {% elif field.name == 'is_staff' %}
                          <div class="form-check">
                              {{ form.is_staff }}
                              <label class="form-check-label" for="{{ form.is_staff.id_for_label }}">Staff</label>
                          </div>
                        {% elif field.name == 'is_superuser' %}
                          <div class="form-check">
                              {{ form.is_superuser }}
                              <label class="form-check-label" for="{{ form.is_superuser.id_for_label }}">Superuser</label>
                          </div>
                        {% else %}
                          {{ field|add_class:"form-control bg-grey text-white border-0" }}
                        {% endif %}
                      </div>

                      {% if field.help_text %}
                        <small class="form-hint text-grey fst-italic">{{ field.help_text }}</small>
                      {% endif %}
                      {% for error in field.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
              {% endfor %}                    

              
              <!-- Toggle button for setting/changing password -->
              <div class="col-md-12">
                {% if edit_mode %}
                  <button type="button" class="btn btn-sm btn-warning-lt mb-2" id="togglePasswordBtn">
                    Change Password
                  </button>
                {% else %}
                  <button type="button" class="btn btn-sm btn-warning-lt mb-2" id="togglePasswordBtn">
                    Set Password
                  </button>
                {% endif %}
              </div>

              <!-- Password fields (hidden by default) -->
              <div id="passwordFields" class="row g-3" style="display: {% if not edit_mode %}flex{% else %}none{% endif %};">
                <div class="col-md-6">
                  <div class="form-group">
                    <div class="input-group input-group-flat">
                      <span class="input-group-text bg-grey text-white border-0">
                        <i class="bi bi-lock"></i>
                      </span>
                      {{ form.password|add_class:"form-control bg-grey text-white border-0" }}
                    </div>
                    {% for error in form.password.errors %}
                      <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="form-group">
                    <div class="input-group input-group-flat">
                      <span class="input-group-text bg-grey text-white border-0">
                        <i class="bi bi-lock-fill"></i>
                      </span>
                      {{ form.confirm_password|add_class:"form-control bg-grey text-white border-0" }}
                    </div>
                    {% for error in form.confirm_password.errors %}
                      <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                  </div>
                </div>
              </div>

              
            


            <!-- Buttons -->
            <div class="mt-4 d-flex gap-2">

              <!-- Save & Return -->
              <button type="submit" name="save_return" class="btn btn-success">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-device-floppy">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2" />
                  <path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                  <path d="M14 4l0 4l-6 0l0 -4" />
                </svg> 
                Save
              </button>

              <!-- Save & Repeat -->
              <button type="submit" name="save_add_another" class="btn btn-gray">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-reload">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M19.933 13.041a8 8 0 1 1 -9.925 -8.788c3.899 -1 7.935 1.007 9.425 4.747" />
                  <path d="M20 4v5h-5" />
                </svg> 
              </button>

              {% if edit_mode %}
                <!-- Deactivate/Reactivate User -->
                <button type="submit" name="deactivate_user" class="btn btn-yellow-lt">
                  {% if user_obj.is_active %}
                    <span class="text-light">
                      <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-lock">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-6z" />
                        <path d="M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0" /><path d="M8 11v-4a4 4 0 1 1 8 0v4" />
                      </svg>
                  {% else %}
                    <span class="text-light">
                      <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-lock-open-2">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2z" />
                        <path d="M9 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0" /><path d="M13 11v-4a4 4 0 1 1 8 0v4" />
                      </svg>
                  {% endif %}
                </button>

                <!-- Delete Button -->
                {% if not user_obj.is_superuser %}
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteUserModal">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-cancel">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M3 12a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                    <path d="M18.364 5.636l-12.728 12.728" />
                  </svg>
                  Delete
                </button>
                {% endif %}
              {% endif %}
            </div>


          </form>

        </div>


      </div>
    </div>
  </div>
</div>

<style>
  .dropdown-menu {
    border: none;
    border-radius: 0.75rem;
    background-color: #111827 !important;
  }

  .dropdown-menu .accordion-button {
    background-color: #111827 !important;
    color: #fff;
  }

  .dropdown-menu .accordion-button:not(.collapsed) {
    background-color: #2e303e !important;
  }

  .dropdown-menu .accordion-body {
    background-color: #111827 !important;
  }
</style>

<!-- Image Preview Script -->
<script>
  function previewImage(input) {
    const preview = document.getElementById('preview-img');
    const file = input.files[0];
    if (file && preview) {
      preview.src = URL.createObjectURL(file);
    }
  }
</script>

{{ preloadedTeamRoles|json_script:"preloadedTeamRoles" }}


<script>
document.addEventListener("DOMContentLoaded", async function () {
  const toggleBtn = document.getElementById("togglePasswordBtn");
  const passwordSection = document.getElementById("passwordFields");
  const groupSelect = document.getElementById("id_group");
  const addBtn = document.getElementById("add-team-role");
  const container = document.getElementById("team-role-list");
  const hiddenInput = document.getElementById("teamsHiddenInput");
  

  // Password toggle (unchanged)
  toggleBtn?.addEventListener("click", () => {
    const isHidden = passwordSection.style.display === "none" || passwordSection.style.display === "";
    passwordSection.style.display = isHidden ? "flex" : "none";
    if (!isHidden) passwordSection.querySelectorAll("input").forEach(i => i.value = "");
  });

  let availableTeams = [];
  let availableRoles = [];

  // Fetch data helper
  async function loadData(group) {
    const [teamRes, roleRes] = await Promise.all([
      fetch(`/accounts/ajax/load-teams/?group=${group}`),
      fetch(`/accounts/ajax/load-roles/?group=${group}`)
    ]);
    availableTeams = await teamRes.json();
    availableRoles = await roleRes.json();
  }

  // --- Update hidden input with id:role,id:role format ---
  function updateHiddenInput() {
    const pairs = [];
    container.querySelectorAll(".team-role-row").forEach(row => {
      const teamId = row.querySelector(".team-select").value;
      const role = row.querySelector(".role-select").value;
      if (teamId && role) pairs.push(`${teamId}:${role}`);
    });
    hiddenInput.value = pairs.join(",");
  }

  // --- Add a new Team-Role row ---
  function addTeamRoleRow(selectedTeam = "", selectedRole = "") {
    const row = document.createElement("div");
    row.classList.add("team-role-row", "d-flex", "align-items-center", "mb-2", "gap-2", "border-0");

    const teamSelect = document.createElement("select");
    teamSelect.classList.add("form-select", "team-select");
    teamSelect.innerHTML = `
      ${availableTeams.map(t =>
        `<option value="${t.id}" ${t.id == selectedTeam ? "selected" : ""}>${t.name}</option>`
      ).join("")}
    `;

    const roleSelect = document.createElement("select");
    roleSelect.classList.add("form-select", "role-select");
    roleSelect.innerHTML = `
      <option value="">Select Role</option>
      ${availableRoles.map(r =>
        `<option value="${r}" ${r === selectedRole ? "selected" : ""}>${r}</option>`
      ).join("")}
    `;

    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.classList.add("avatar", "border-0", "d-flex", "align-items-center", "justify-content-center");
    removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff000083" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-row-remove">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                              <path d="M20 6v4a1 1 0 0 1 -1 1h-14a1 1 0 0 1 -1 -1v-4a1 1 0 0 1 1 -1h14a1 1 0 0 1 1 1z" />
                              <path d="M10 16l4 4" /><path d="M10 20l4 -4" />
                              </svg>`;
    removeBtn.onclick = () => {
      row.remove();
      updateHiddenInput();
    };

    [teamSelect, roleSelect].forEach(el => el.addEventListener("change", updateHiddenInput));

    row.append(teamSelect, roleSelect, removeBtn);
    container.appendChild(row);

    updateHiddenInput();
  }

  // --- Handle group change ---
  groupSelect.addEventListener("change", async () => {
    const group = groupSelect.options[groupSelect.selectedIndex].text;
    if (!group) return;

    await loadData(group);
    container.innerHTML = ""; // reset
    hiddenInput.value = "";
  });

  // --- Add new manually ---
  addBtn.addEventListener("click", () => {
    if (!availableTeams.length) {
      alert("Please select a Group first.");
      return;
    }
    addTeamRoleRow();
  });

  // --- Prepopulate edit mode ---
  const preloadedData = JSON.parse(document.getElementById("preloadedTeamRoles").textContent || "{}");
  const preloadedPairs = preloadedData.userMemberships || [];
  console.log("Preloaded pairs:", preloadedPairs);

  async function initEditMode() {
    if (!preloadedPairs.length) return;

    // Wait for group select to have a valid value
    const selectedGroup = groupSelect.options[groupSelect.selectedIndex]?.text?.trim();
    if (!selectedGroup) return;

    // Fetch teams/roles for this group
    await loadData(selectedGroup);

    // Clear container just in case
    container.innerHTML = "";

    // Add rows for each preloaded pair
    preloadedPairs.forEach(({ team_id, team_role }) => {
      addTeamRoleRow(team_id, team_role);
    });

    // Update hidden input after rendering
    updateHiddenInput();
  }

  // Delay initialization slightly to ensure form is ready
  window.addEventListener("load", initEditMode);
  
});
</script>



{% endblock %}





